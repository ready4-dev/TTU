## This script creates the data files embedded with this package.
## As it involves interaction, it must be run  in four separate parts.
##
## PART ONE
##
# 1. Load magrittr package to that the pipe operator ("%>%") can be used in this script.
library(magrittr)
# 2. Create "fns", "gnrcs" and "mthds" sub-directories.
ready4fun::write_fn_type_dirs()
# 3. MANUAL STEP. Write all your functions to R files in the new "fns" directory.
##
## PART TWO
##
# 4. Set-up package structure
ready4fun::make_pkg_desc_ls(pkg_title_1L_chr = "Transfer to Utility Mapping Algorithm Toolkit",
                            pkg_desc_1L_chr = "Tools for developping Transfer To Utility (TTU) mapping algorithms to predict health utility from other health measures.
                            This development version of the TTU package has been made available as part of the process of testing and documenting the package.
                            Some of the documentation for this package has been automatically generated by the ready4fun package and is therefore quite rudimentary. Human edits to improve the quality of documentation will follow in 2021.
                            If you have any questions, please contact the authors (matthew.hamilton@orygen.org.au).",
                            authors_prsn = c(utils::person(given = "Caroline",family = "Gao",email = "caroline.gao@orygen.org.au", role = c("aut"),comment = c(ORCID = "0000-0002-0987-2759")),
                                              utils::person(given = "Matthew",family = "Hamilton",email = "matthew.hamilton@orygen.org.au", role = c("aut", "cre"),comment = c(ORCID = "0000-0001-7407-9194")),
                                              utils::person("Orygen", role = c("cph", "fnd")),
                                              utils::person("Headspace", role = c( "fnd")),
                                              utils::person("National Health and Medical Research Council", role = c( "fnd"))),
                            urls_chr = c("https://ready4-dev.github.io/TTU/",
                                         "https://github.com/ready4-dev/TTU",
                                         "https://ready4-dev.github.io/ready4/")) %>%
  ready4fun::write_pkg_setup_fls(incr_ver_1L_lgl = F,
                                 delete_r_dir_cnts_1L_lgl = T,
                                 copyright_holders_chr = "Orygen",
                                 check_type_1L_chr = "gh",
                                 path_to_pkg_logo_1L_chr = "../../../../../Documentation/Images/TTU-logo/default.png",
                                 github_repo = "ready4-dev/TTU",
                                 lifecycle_stage_1L_chr = "experimental",
                                 badges_lup = ready4fun::badges_lup,
                                 addl_badges_ls = list(ready4 = "modelling"))

# PAUSE FOR INTERACTIVE
##
## PART THREE
##
# 5. Create a lookup table of abbreviations used in this package and save it as a package dataset (data gets saved in the data directory, documentation script is created in R directory).
object_type_lup <- ready4fun::get_rds_from_dv("object_type_lup")
pkg_dss_tb <- ready4fun::get_rds_from_dv("abbreviations_lup") %>%
  ready4fun::write_abbr_lup(object_type_lup = object_type_lup)
utils::data("abbreviations_lup")
#
# 6. Make classes
source("data-raw/MAKE_CLASSES.R")
pkg_dss_tb <- classes_to_make_tb %>%
  ready4class::write_classes_and_make_lup(dev_pkg_ns_1L_chr = ready4fun::get_dev_pkg_nm(),
                                          name_pfx_1L_chr = name_pfx_1L_chr,
                                          output_dir_1L_chr = "R",
                                          file_exists_cdn_1L_chr = "overwrite",
                                          abbreviations_lup = abbreviations_lup,
                                          init_class_pt_lup = ready4fun::get_rds_from_dv("prototype_lup"),
                                          object_type_lup = object_type_lup)  %>% #
  ready4fun::write_and_doc_ds(db_1L_chr = "prototype_lup",
                              title_1L_chr = "Class prototype lookup table",
                              desc_1L_chr = "Metadata on classes used in readyforwhatsnext suite",
                              abbreviations_lup = abbreviations_lup,
                              object_type_lup = object_type_lup,
                              pkg_dss_tb = pkg_dss_tb)
##
# 7. Create function types look-up table and save it as a package dataset
pkg_dss_tb <- ready4fun::get_rds_from_dv("fn_type_lup_tb") %>%
  ready4fun::write_dmtd_fn_type_lup(abbreviations_lup = abbreviations_lup,
                                    object_type_lup = object_type_lup,
                                    pkg_dss_tb = pkg_dss_tb)
utils::data("fn_type_lup_tb")
#
# 8. Create a table of all functions to document
fns_dmt_tb <- ready4fun::make_dmt_for_all_fns(paths_ls = ready4fun::make_fn_nms()[1],
                                              undocumented_fns_dir_chr = ready4fun::make_undmtd_fns_dir_chr()[1],
                                              custom_dmt_ls = list(details_ls = NULL,
                                                                   inc_for_main_user_lgl_ls = list(force_true_chr = c("add_utility_predn_to_ds",
                                                                                                                      "get_cndts_for_mxd_mdls",
                                                                                                                      "get_signft_covars",
                                                                                                                      "make_analysis_ds_smry_ls",
                                                                                                                      "make_fake_eq5d_ds",
                                                                                                                      "make_fake_ts_data",
                                                                                                                      "make_mdl_nms_ls",
                                                                                                                      "make_prefd_mdls_vec",
                                                                                                                      "make_predr_vals",
                                                                                                                      "make_predr_vars_nms_ls",
                                                                                                                      "make_results_ls",
                                                                                                                      "make_results_ls_spine",
                                                                                                                      "make_study_descs_ls",
                                                                                                                      "predict_utility",
                                                                                                                      "reorder_cndt_predrs_chr",
                                                                                                                      "transform_mdl_vars_with_clss",
                                                                                                                      "transform_paths_ls_for_scndry",
                                                                                                                      "transform_rprt_lup",
                                                                                                                      "transform_tb_to_mdl_inp",
                                                                                                                      #"write_all_alg_outps",
                                                                                                                      "write_main_oupt_dir",
                                                                                                                      "write_mdl_cmprsn",
                                                                                                                      "write_mdl_type_covars_mdls",
                                                                                                                      "write_mdl_type_multi_outps",
                                                                                                                      "write_mdls_with_covars_cmprsn",
                                                                                                                      "write_predr_and_covars_cmprsn",
                                                                                                                      "write_predr_cmprsn_outps",
                                                                                                                      "write_report",
                                                                                                                      "write_rprt_with_rcrd",
                                                                                                                      "write_scndry_analysis",
                                                                                                                      "write_shareable_mdls",
                                                                                                                      "write_sngl_predr_multi_mdls_outps",
                                                                                                                      "write_to_delete_ds_copies",
                                                                                                                      "write_to_delete_mdl_fls",
                                                                                                                      "write_ts_mdls_from_alg_outp"),
                                                                                                   force_false_chr = NA_character_),
                                                                   args_ls_ls = NULL),
                                              fn_type_lup_tb = fn_type_lup_tb,
                                              abbreviations_lup = abbreviations_lup,
                                              object_type_lup = object_type_lup)
##
pkg_dss_tb <- fns_dmt_tb %>%
  ready4fun::write_and_doc_ds(db_1L_chr = "fns_dmt_tb",
                              title_1L_chr = "TTU function documentation table",
                              desc_1L_chr = "Meta-data on each TTU function used to create package documentation",
                              url_1L_chr = "https://ready4-dev.github.io/TTU/",
                              abbreviations_lup = abbreviations_lup,
                              pkg_dss_tb = pkg_dss_tb)
pkg_dss_tb <- tibble::tibble(short_name_chr = c("OLS_NTF",
                                                "OLS_LOG",
                                                "OLS_LOGIT",
                                                "OLS_LOGLOG",
                                                "OLS_CLL",
                                                "GLM_GSN_LOG",
                                                "GLM_BNL_LOG",
                                                "GLM_BNL_LGT",
                                                "GLM_BNL_CLL",
                                                "BET_LOG",
                                                "BET_LGT",
                                                "BET_CLL"),
                                  long_name_chr = c("Ordinary Least Squares (No transformation)",
                                                    "Ordinary Least Squares (Log transformation)",
                                                    "Ordinary Least Squares (Logit transformation)",
                                                    "Ordinary Least Squares (Log Log transformation)",
                                                    "Ordinary Least Squares (Complementary Log Log transformation)",
                                                    "Generalised Linear Model with Gaussian distribution and log link",
                                                    "Generalised Linear Model with Binomial distribution and log link",
                                                    "Generalised Linear Model with Binomial distribution and logit link",
                                                    "Generalised Linear Model with Binomial distribution and complementary log log link",
                                                    "Beta Regression Model with Binomial distribution and log link",
                                                    "Beta Regression Model with Binomial distribution and logit link",
                                                    "Beta Regression Model with Binomial distribution and complementary log log link")) %>%
  dplyr::mutate(control_chr = c(rep(NA_character_,9),rep("betareg::betareg.control",3)),
                family_chr = c(rep(NA_character_,5),"gaussian(log)","quasibinomial(log)","quasibinomial(logit)","quasibinomial(cloglog)", rep(NA_character_,3)),
                fn_chr = c(rep("lm",5),rep("glm",4),rep("betareg::betareg",3)),
                start_chr = c(rep(NA_character_,5),
                              rep("-0.1,-0.1",4),
                              rep("-0.5,-0.1,3",3)),

                predn_type_chr = c(rep(NA_character_,5),
                                  rep("response",7)),
                tfmn_chr = dplyr::case_when(startsWith(short_name_chr, "OLS_") ~ purrr::map_chr(short_name_chr, ~ {
                  idx_1L_int <- 1 + stringi::stri_locate_last_fixed(.x,"_")[1,1] %>% as.vector()
                  stringr::str_sub(.x, start = idx_1L_int)
                }),
                T ~ "NTF"),
                tfmn_for_bnml_lgl = c(rep(F,6),rep(T,3),rep(F,3)),
                fixed_acronym_chr = dplyr::case_when(startsWith(short_name_chr, "OLS_") ~ "OLS",
                                                     T ~ "GLM"),
                mixed_acronym_chr = dplyr::case_when(startsWith(short_name_chr, "OLS_") ~ "LMM",
                T ~ "GLMM"),
                mixed_type_chr = dplyr::case_when(startsWith(short_name_chr, "OLS_") ~ "Linear Mixed Model",
                                                     T ~ "Generalised Linear Mixed Model"),
                with_chr = long_name_chr %>%
                  purrr::map_chr(~ifelse(startsWith(.x,"Ordinary Least Squares"),
                                         stringr::str_remove(.x,"Ordinary Least Squares ") %>%
                                           stringr::str_sub(start = 2, end = -2),
                                         stringr::str_remove(.x,"Generalised Linear Model with ") %>%
                                           stringr::str_remove("Beta Regression Model with ")))) %>%
  ready4fun::write_and_doc_ds(db_1L_chr = "mdl_types_lup",
                              title_1L_chr = "Model types lookup table",
                              desc_1L_chr = "A lookup table of abbreviations to describe the different model types supported by TTU functions",
                              abbreviations_lup = abbreviations_lup,
                              object_type_lup = object_type_lup,
                              pkg_dss_tb = pkg_dss_tb)
pkg_dss_tb <- tibble::tibble(short_name_chr = c("coefs","hetg",
                                                "dnst","sctr_plt",
                                                "sim_dnst","sim_sctr",
                                                "cnstrd_dnst","cnstrd_sctr_plt",
                                                "cnstrd_sim_dnst","cnstrd_sim_sctr"),
                               long_name_chr = c("population level effects",
                                                 "group level effects",
                                                 "comparative densities of observed data and predictions using mean model parameter values",
                                                 "comparative scatter plot of observed and predictions using mean model parameter values",
                                                 "comparative densities of observed data and predictions using sampled model parameter values",
                                                 "comparative scatter plot of observed and predictions using sampled model parameter values",
                                                 "comparative densities of observed data and predictions using mean model parameter values and transformation of out of range predictions to upper and lower bounds",
                                                 "comparative scatter plot of observed and predictions using mean model parameter values and transformation of out of range predictions to upper and lower bounds",
                                                 "comparative densities of observed data and predictions using sampled model parameter values and transformation of out of range predictions to upper and lower bounds",
                                                 "comparative scatter plot of observed and predictions using sampled model parameter values and transformation of out of range predictions to upper and lower bounds")) %>%
  ready4fun::write_and_doc_ds(db_1L_chr = "plt_types_lup",
                              title_1L_chr = "Model plot types lookup table",
                              desc_1L_chr = "A lookup table of abbreviations to describe the different model plot types supported by TTU functions",
                              abbreviations_lup = abbreviations_lup,
                              object_type_lup = object_type_lup,
                              pkg_dss_tb = pkg_dss_tb)
##
# ADD TO PLOTS TABLE:
# AUTOPLT
# LNR_CMPRSN
# PRED_DNSTY
# PRED_SCTR
# SIM_DNSTY
# BORUTA_VAR_IMP
# RF_VAR_IMP
##
pkg_dss_tb <- tibble::tibble(rprt_nms_chr = "AAA_TTU_MDL_CTG",
                           title_chr = "Results supplement: longitudinal transfer to utility models.",
                           paths_to_rmd_dir_1L_chr = NA_character_,
                           pkg_dirs_chr = "Markdown",
                           packages_chr = "TTU",
                           nms_of_rmd_chr = "Report_TS_Mdls.RMD",
                           rltv_paths_to_outpt_yaml_chr = "_output.yml") %>%
  tibble::add_case(rprt_nms_chr = "AAA_PMRY_ANLYS_MTH",
                   title_chr = "Methods supplement: Main analysis algorithm",
                   paths_to_rmd_dir_1L_chr = NA_character_,
                   pkg_dirs_chr = "Markdown",
                   packages_chr = "TTU",
                   nms_of_rmd_chr = "Analyse.Rmd") %>%
  tibble::add_case(rprt_nms_chr = "AAA_RPRT_WRTNG_MTH",
                   title_chr = "Methods supplement: algorithm to auto-generate reports.",
                   paths_to_rmd_dir_1L_chr = NA_character_,
                   pkg_dirs_chr = "Markdown",
                   packages_chr = "TTU",
                   nms_of_rmd_chr = "Report.Rmd") %>%
  ready4fun::write_and_doc_ds(db_1L_chr = "rprt_lup",
                              title_1L_chr = "Report types lookup table",
                              desc_1L_chr = "A lookup table of the different report types supported by TTU functions",
                              abbreviations_lup = abbreviations_lup,
                              object_type_lup = object_type_lup,
                              pkg_dss_tb = pkg_dss_tb)

# NOTE: NEED TO UPDATE DIR PATH FOR MODELS
## Note files to be rewritten cannot be open in RStudio.
## 9. Document functions.
usethis::use_build_ignore("initial_setup.R")
readLines(".github/workflows/R-CMD-check.yaml")[-28] %>%
  writeLines(".github/workflows/R-CMD-check.yaml")
usethis::use_package("betareg")
usethis::use_package("eq5d")
usethis::use_package("ggfortify")
usethis::use_dev_package("cmdstanr")
usethis::use_package("knitrBootstrap")
usethis::use_package("readr")
usethis::use_package("rmarkdown",type = "Suggests")
usethis::use_dev_package("ready4show")
usethis::use_dev_package("ready4use")
usethis::use_dev_package("youthvars")
#usethis::use_package("knitr", type = "suggests")
#usethis::use_package("rgl")
#
ready4fun::write_and_doc_fn_fls(fns_dmt_tb,
                                r_dir_1L_chr = "R",
                                dev_pkgs_chr = c("ready4fun","ready4class","ready4use","ready4show","youthvars","dataverse","cmdstanr"),
                                update_pkgdown_1L_lgl = T)
##
## PART FOUR
data("prototype_lup")
if(!identical(prototype_lup,ready4fun::get_rds_from_dv("prototype_lup"))){
  prototype_lup %>%
    ready4use::write_paired_ds_fls_to_dv(fl_nm_1L_chr = "prototype_lup",
                                         desc_1L_chr = "Prototypes lookup table")
}
# devtools::build_vignettes()
ready4fun::write_links_for_website(user_manual_url_1L_chr = "https://github.com/ready4-dev/TTU/files/6277705/TTU_user_0.0.0.9133.pdf",
                                   developer_manual_url_1L_chr = "https://github.com/ready4-dev/TTU/files/6277710/TTU_developer_0.0.0.9133.pdf",
                                   project_website_url_1L_chr = "https://www.ready4-dev.com/")
##
##
# dv_ls <- list(primary_dv_chr = c("fakes","https://doi.org/10.7910/DVN/612HDC"))
# fake_eq5d_ds_tb <- make_fake_eq5d_ds()
# saveRDS(fake_eq5d_ds_tb,"data-raw/dataverse/fake_eq5d_ds_tb.Rds")
# ready4use::write_fls_to_dv_ds(dss_tb = tibble::tibble(ds_obj_nm_chr = "fake_eq5d_ds_tb",
#                                                       title_chr = "A synthetic (entirely fake) dataset with psychological distress, psychological wellbeing and EQ5D questionaire response variables."),
#                               dv_nm_1L_chr = dv_ls$primary_dv_chr[1],
#                               ds_url_1L_chr = dv_ls$primary_dv_chr[2],
#                               parent_dv_dir_1L_chr = "data-raw/dataverse",
#                               paths_to_dirs_chr = "data-raw/dataverse",
#                               inc_fl_types_chr = ".Rds",
#                               paths_are_rltv_1L_lgl = T)
##
## Add, Commit and Push
# system("git add .")
# system("git commit -m \"message\"")
