## This script creates the data files embedded with this package.
## As it involves interaction, it must be run  in four separate parts.
##
## PART ONE
##
# 1. Load magrittr package to that the pipe operator ("%>%") can be used in this script.
library(magrittr)
# 2. Create "fns", "gnrcs" and "mthds" sub-directories.
ready4fun::write_fn_type_dirs()
# 3. MANUAL STEP. Write all your functions to R files in the new "fns" directory.
##
## PART TWO
##
# 4. Set-up package structure
ready4fun::make_pkg_desc_ls(pkg_title_1L_chr = "Transfer to Utility Mapping Algorithm Toolkit",
                            pkg_desc_1L_chr = "Tools for developping Transfer To Utility (TTU) mapping algorithms to predict health utility from other health measures.
  This development version of the TTU package has been made available as part of the process of testing and documenting the package. The tools contained in this development release automate a number of tasks which MODIFY THE DIRECTORY STRUCTURE OF YOUR LOCAL MACHINE.
  Therefore you should only trial this software if you feel confident that you understand what it does and have created a sandpit area in which you can safely undertake testing. If you have any questions, please contact the authors (matthew.hamilton@orygen.org.au).
  Some of the documentation for this package has been automatically generated by the ready4fun package and is therefore quite rudimentary. Human edits to improve the quality of documentation will follow in 2021.",
                            authors_prsns = c(utils::person(given = "Caroline",family = "Gao",email = "caroline.gao@orygen.org.au", role = c("aut"),comment = c(ORCID = "0000-0002-0987-2759")),
                                              utils::person(given = "Matthew",family = "Hamilton",email = "matthew.hamilton@orygen.org.au", role = c("aut", "cre"),comment = c(ORCID = "0000-0001-7407-9194")),
                                              utils::person("Orygen", role = c("cph", "fnd")),
                                              utils::person("Headspace", role = c( "fnd")),
                                              utils::person("National Health and Medical Research Council", role = c( "fnd"))),
                            urls_chr = c("https://ready4-dev.github.io/TTU/",
                                         "https://github.com/ready4-dev/TTU",
                                         "https://ready4-dev.github.io/ready4/")) %>%
  ready4fun::write_pkg_setup_fls(incr_ver_1L_lgl = F,
                                 delete_contents_of_R_dir = T,
                                 copyright_holders_chr = "Orygen",
                                 check_type_1L_chr = "gh",
                                 path_to_pkg_logo_1L_chr = "../../../../../Documentation/Images/TTU-logo/default.png",
                                 github_repo = "ready4-dev/TTU",
                                 lifecycle_stage_1L_chr = "experimental",
                                 badges_lup = ready4fun::badges_lup,
                                 addl_badges_ls = list(ready4 = "modelling"))

# PAUSE FOR INTERACTIVE
##
## PART THREE
##
classes_to_make_tb <- ready4class::ready4_constructor_tbl() %>%
  dplyr::bind_rows(tibble::tribble(
    ~ make_s3_lgl, ~ name_stub_chr, ~ pt_ls, ~ pt_chkr_pfx_ls, ~ pt_ns_ls, ~ vals_ls, ~ allowed_vals_ls, ~ min_max_vals_ls, ~ start_end_vals_ls, ~ class_desc_chr, ~ parent_class_chr, ~ slots_ls, ~ meaningful_nms_ls, ~inc_clss_ls,
    TRUE, "predictors_lup", list("tibble"), list("is_"),list("tibble"),list(short_name_chr = "character(0)",
                                                                            long_name_chr = "character(0)",
                                                                            min_val_dbl = "numeric(0)",
                                                                            max_val_dbl = "numeric(0)",
                                                                            class_chr = "character(0)",
                                                                            increment_dbl = "numeric(0)",
                                                                            class_fn_chr = "character(0)",
                                                                            mdl_scaling_dbl = "numeric(0)",
                                                                            covariate_lgl = "logical(0)"), NULL,NULL, NULL, "TTU S3 class for candidate predictors lookup table", NA_character_, NULL, NULL, NULL)
  )
name_pfx_1L_chr <- "TTU_"
pkg_dss_tb <- ready4fun::write_abbr_lup(short_name_chr = c(paste0(name_pfx_1L_chr,classes_to_make_tb$name_stub_chr)),
                                        long_name_chr = c(classes_to_make_tb$class_desc_chr),
                                        #no_plural_chr = ,
                                        #custom_plural_ls = ,
                                        url_1L_chr = NA_character_,
                                        seed_lup = youthvars::abbreviations_lup)
utils::data("abbreviations_lup")
pkg_dss_tb <- classes_to_make_tb %>%
  ready4class::write_classes_and_make_lup(dev_pkg_ns_1L_chr = ready4fun::get_dev_pkg_nm(),
                                          name_pfx_1L_chr = name_pfx_1L_chr,
                                          output_dir_1L_chr = "R",
                                          file_exists_cdn_1L_chr = "overwrite",
                                          abbreviations_lup = abbreviations_lup,
                                          init_class_pt_lup = youthvars::prototype_lup)  %>% #
  ready4fun::write_and_doc_ds(db_1L_chr = "prototype_lup",
                              title_1L_chr = "Class prototype lookup table",
                              desc_1L_chr = "Metadata on classes used in readyforwhatsnext suite",
                              pkg_dss_tb = pkg_dss_tb)
##
# 5. Create a lookup table of abbreviations used in this package and save it as a package dataset (data gets saved in the data directory, documentation script is created in R directory).
#utils::data("abbreviations_lup",package = "ready4use")
pkg_dss_tb <- ready4fun::write_abbr_lup(short_name_chr = c("cnstr","con","cor",
                                                           "lgd",
                                                           "mdl",
                                                           "predn",
                                                           "tfmn",
                                                           "tot",
                                                           "ts",
                                                           "uid",
                                                           "ut"),
                                        long_name_chr = c("constraint",
                                                          "constant",
                                                          "correlation",
                                                          "legend",
                                                          "model",
                                                          "prediction",
                                                          "transformation",
                                                          "total",
                                                          "time series",
                                                          "unique identifier",
                                                          "utility"),
                                        no_plural_chr = c("prediction","time series"),
                                        custom_plural_ls = list(utility = "utilities"),
                                        url_1L_chr = NA_character_,
                                        seed_lup = youthvars::abbreviations_lup)
utils::data("abbreviations_lup")
##
# 5. Create function types and generics look-up tables
# 5.1 Create a lookup table of function types used in this package and save it as a package dataset (data gets saved in the data directory, documentation script is created in R directory).
utils::data("fn_type_lup_tb", package = "youthvars")
pkg_dss_tb <- fn_type_lup_tb %>%
  ready4fun::add_rows_to_fn_type_lup(fn_type_nm_chr = ready4fun::get_new_fn_types(abbreviations_lup = abbreviations_lup,
                                                                                  fn_type_lup_tb = fn_type_lup_tb),
                                  fn_type_desc_chr = c("Fits a model of a specified type to a dataset",
                                                       "Knits a rmarkdown file",
                                                       "Plots data",
                                                       "Makes predictions from data using a specified statistical model.",
                                                       "Randomly samples from data.",
                                                       "Reorders an object to conform to a pre-specified schema.",
                                                       "Randomly reorders an object."
                                                       ),
                                  is_generic_lgl = F,
                                  is_method_lgl = F) %>% # Add to ready4fun template.
  dplyr::arrange(fn_type_nm_chr) %>%
  ready4fun::write_dmtd_fn_type_lup(url_1L_chr = NA_character_,
                                    abbreviations_lup = abbreviations_lup,
                                    pkg_dss_tb = pkg_dss_tb)
utils::data("fn_type_lup_tb")
#
# 6. Create a table of all functions to document
fns_dmt_tb <- ready4fun::make_dmt_for_all_fns(paths_ls = ready4fun::make_fn_nms()[1],
                                              undocumented_fns_dir_chr = ready4fun::make_undmtd_fns_dir_chr()[1],
                                              custom_dmt_ls = list(details_ls = NULL,
                                                                   inc_for_main_user_lgl_ls = list(force_true_chr = c("add_interval_var",
                                                                                                                      "add_utility_predn_to_ds",
                                                                                                                      "make_fake_ts_data",
                                                                                                                      "write_all_alg_outps",
                                                                                                                      "write_mdl_cmprsns",
                                                                                                                      "write_predr_and_covars_cmprsns",
                                                                                                                      "write_mdls_with_covars_cmprsns",
                                                                                                                      #"write_rprt",
                                                                                                                      "write_shareable_mdls",
                                                                                                                      "write_ts_mdls_from_alg_outp"),
                                                                                                   force_false_chr = NA_character_),
                                                                   args_ls_ls = NULL),
                                              fn_type_lup_tb = fn_type_lup_tb,
                                              abbreviations_lup = abbreviations_lup)
##
pkg_dss_tb <- fns_dmt_tb %>%
  ready4fun::write_and_doc_ds(db_1L_chr = "fns_dmt_tb",
                              title_1L_chr = "TTU function documentation table",
                              desc_1L_chr = "Meta-data on each TTU function used to create package documentation",
                              url_1L_chr = "https://ready4-dev.github.io/TTU/",
                              abbreviations_lup = abbreviations_lup,
                              pkg_dss_tb = pkg_dss_tb)
pkg_dss_tb <- tibble::tibble(short_name_chr = c("OLS_NTF",
                                                     "OLS_LOG",
                                                     "OLS_LOGIT",
                                                     "OLS_LOGLOG",
                                                     "OLS_CLL",
                                                     "GLM_GSN_LOG",
                                                     "GLM_BNL_LOG",
                                                     "GLM_BNL_LGT",
                                                     "GLM_BNL_CLL",
                                                     "BET_LOG",
                                                     "BET_LGT",
                                                     "BET_CLL"),
                                  long_name_chr = c("Ordinary Least Squares (No transformation)",
                                                    "Ordinary Least Squares (Log transformation)",
                                                    "Ordinary Least Squares (Logit transformation)",
                                                    "Ordinary Least Squares (Log Log transformation)",
                                                    "Ordinary Least Squares (Complementary Log Log transformation)",
                                                    "Generalised Linear Mixed Model with Gaussian distribution and log link",
                                                    "Generalised Linear Mixed Model with Binomial distribution and log link",
                                                    "Generalised Linear Mixed Model with Binomial distribution and logit link",
                                                    "Generalised Linear Mixed Model with Binomial distribution and complementary log log link",
                                                    "Beta Regression Model with Binomial distribution and log link",
                                                    "Beta Regression Model with Binomial distribution and logit link",
                                                    "Beta Regression Model with Binomial distribution and complementary log log link")) %>%
  dplyr::mutate(control_chr = c(rep(NA_character_,9),rep("betareg::betareg.control",3)),
                family_chr = c(rep(NA_character_,5),"gaussian(log)","quasibinomial(log)","quasibinomial(logit)","quasibinomial(cloglog)", rep(NA_character_,3)),
                fn_chr = c(rep("lm",5),rep("glm",4),rep("betareg::betareg",3)),
                start_chr = c(rep(NA_character_,5),
                              rep("-0.1,-0.1",4),
                              rep("-0.5,-0.1,3",3)),

                pred_type_chr = c(rep(NA_character_,5),
                                  rep("response",7)),
                tfmn_chr = dplyr::case_when(startsWith(short_name_chr, "OLS_") ~ purrr::map_chr(short_name_chr, ~ {
                  idx_1L_int <- 1 + stringi::stri_locate_last_fixed(.x,"_")[1,1] %>% as.vector()
                  stringr::str_sub(.x, start = idx_1L_int)
                }),
                T ~ "NTF"),
                tfmn_for_bnml_lgl = c(rep(F,6),rep(T,3),rep(F,3))) %>%
  ready4fun::write_and_doc_ds(db_1L_chr = "mdl_types_lup",
                              title_1L_chr = "Model types lookup table",
                              desc_1L_chr = "A lookup table of abbreviations to describe the different model types supported by TTU functions",
                              abbreviations_lup = abbreviations_lup,
                              pkg_dss_tb = pkg_dss_tb)
pkg_dss_tb <- tibble::tibble(short_name_chr = c("coefs","hetg", "dnst","sctr_plt"),
                               long_name_chr = c("population level effects",
                                                 "group level effects",
                                                 "comparative densities of observed and predicted data",
                                                 "comparative scatter plot of obsereved and predicted data")) %>%
  ready4fun::write_and_doc_ds(db_1L_chr = "plt_types_lup",
                              title_1L_chr = "Model plot types lookup table",
                              desc_1L_chr = "A lookup table of abbreviations to describe the different model plot types supported by TTU functions",
                              abbreviations_lup = abbreviations_lup,
                              pkg_dss_tb = pkg_dss_tb)
pkg_dss_tb <- tibble::tibble(rprt_nms_chr = "Main_Mdl_Smry",
                           title_chr = "Summary report of the models estimated from synthetic data to map a number of mental health measures to utility scores.",
                           paths_to_RMD_dir_1L_chr = NA_character_,
                           pkg_dirs_chr = "Markdown",
                           packages_chr = "TTU",
                           nms_of_RMD_chr = "_Mdls_Report.RMD",
                           rltv_paths_to_outpt_yaml_chr = "_output.yml") %>%
  ready4fun::write_and_doc_ds(db_1L_chr = "rprt_lup",
                              title_1L_chr = "Report types lookup table",
                              desc_1L_chr = "A lookup table of the different report types supported by TTU functions",
                              abbreviations_lup = abbreviations_lup,
                              pkg_dss_tb = pkg_dss_tb)

# 7. Save copy of package documentation to online data repo.
# ds_ls <- ready4use::write_pkg_dss_to_dv_ds_csvs(pkg_dss_tb,
#                                                 dv_nm_1L_chr = "ready4models",
#                                                 ds_url_1L_chr = "https://doi.org/10.7910/DVN/RXGPAT",
#                                                 parent_dv_dir_1L_chr = "../../../../../Data/Dataverse",
#                                                 wait_time_in_secs_int = 5L)
# NOTE: NEED TO UPDATE DIR PATH FOR MODELS
## Note files to be rewritten cannot be open in RStudio.
## 8. Document functions.
usethis::use_build_ignore("initial_setup.R")
readLines(".github/workflows/R-CMD-check.yaml")[-28] %>%
  writeLines(".github/workflows/R-CMD-check.yaml")
usethis::use_package("ggfortify")
usethis::use_dev_package("cmdstanr")
usethis::use_package("knitrBootstrap")
usethis::use_package("readr")
usethis::use_dev_package("ready4show")
usethis::use_dev_package("ready4use")
usethis::use_dev_package("youthvars")
#usethis::use_package("knitr", type = "suggests")
#usethis::use_package("rgl")
#
ready4fun::write_and_doc_fn_fls(fns_dmt_tb,
                                r_dir_1L_chr = "R",
                                dev_pkgs_chr = c("ready4fun","ready4class","ready4use","ready4show","youthvars","dataverse","cmdstanr"),
                                update_pkgdown_1L_lgl = T)
##
## PART FOUR
devtools::build_vignettes()
##
## Add, Commit and Push

