library(magrittr)
library(ready4)
ready4fun::write_fn_type_dirs()
# MANUAL STEP. Write all your functions to R files in the new "fns" directory.
fns_env_ls <- ready4fun::read_fns(c("data-raw/fns/","data-raw/mthds/"),
                                  fns_env = new.env(parent = globalenv()))
x_ready4fun_manifest <- ready4fun::make_pkg_desc_ls(pkg_title_1L_chr = "Transfer to Utility Mapping Algorithm Toolkit",
                                                    pkg_desc_1L_chr = "Tools for developping, sharing and reporting Transfer To Utility (TTU) mapping algorithms that predict health utility from other health measures.
                            This development version of the TTU package has been made available as part of the process of testing and documenting the package.
                            Some of the documentation for this package has been automatically generated by the ready4fun package and is therefore quite rudimentary. Human edits to improve the quality of documentation will follow in 2021.
                            If you have any questions, please contact the authors (matthew.hamilton@orygen.org.au).",
                                                    authors_prsn = c(utils::person(given = "Caroline",family = "Gao",email = "caroline.gao@orygen.org.au", role = c("aut"),comment = c(ORCID = "0000-0002-0987-2759")),
                                                                     utils::person(given = "Matthew",family = "Hamilton",email = "matthew.hamilton@orygen.org.au", role = c("aut", "cre"),comment = c(ORCID = "0000-0001-7407-9194")),
                                                                     utils::person("Orygen", role = c("cph", "fnd")),
                                                                     utils::person("Headspace", role = c( "fnd")),
                                                                     utils::person("National Health and Medical Research Council", role = c( "fnd"))),
                                                    urls_chr = c("https://ready4-dev.github.io/TTU/",
                                                                 "https://github.com/ready4-dev/TTU",
                                                                 "https://ready4-dev.github.io/ready4/")) %>%
  ready4fun::make_manifest(addl_pkgs_ls = ready4fun::make_addl_pkgs_ls(depends_chr = c("eq5d","ggfortify"),
                                                                       suggests_chr = c("knitr","rmarkdown"),
                                                                       imports_chr = c("betareg","knitrBootstrap")),
                           build_ignore_ls = ready4fun::make_build_ignore_ls(file_nms_chr = c("initial_setup.R")),
                           check_type_1L_chr = "ready4",
                           copyright_holders_chr = "Orygen",
                           custom_dmt_ls = ready4fun::make_custom_dmt_ls(user_manual_fns_chr = c("add_utility_predn_to_ds",
                                                                                                 "get_background_text",
                                                                                                 "get_cndts_for_mxd_mdls",
                                                                                                 "get_conclusion_text",
                                                                                                 "get_covar_ctgs",
                                                                                                 "get_covars_by_ctg",
                                                                                                 "get_hlth_utl_nm",
                                                                                                 "get_hlth_utl_stat",
                                                                                                 "get_link_from_tfmn",
                                                                                                 "get_lngl_ttu_types",
                                                                                                 "get_mdl_cmprsns",
                                                                                                 "get_mdl_type_from_nm",
                                                                                                 "get_mdls_with_signft_covars",
                                                                                                 "get_nbr_of_predrs",
                                                                                                 "get_nbr_of_predrs_by_ctg",
                                                                                                 "get_nbr_of_scndry_analyses",
                                                                                                 "get_ordered_sngl_csnl_mdls",
                                                                                                 "get_popl_descvs",
                                                                                                 "get_predr_ctgs",
                                                                                                 "get_predrs_by_ctg",
                                                                                                 "get_prefd_mdl_predrs",
                                                                                                 "get_scndry_anlys_descs",
                                                                                                 "get_selected_mixed_mdls",
                                                                                                 "get_signft_covars",
                                                                                                 "make_abstract_args_ls",
                                                                                                 "make_analysis_ds_smry_ls",
                                                                                                 "make_cmpst_sctr_and_dnst_plt",
                                                                                                 "make_cndt_predr_text",
                                                                                                 "make_coi_text",
                                                                                                 "make_correlation_text",
                                                                                                 "make_covar_ttu_tbl_refs",
                                                                                                 "make_covar_ttu_tbl_title",
                                                                                                 "make_covariates_text",
                                                                                                 "make_data_availability_text",
                                                                                                 "make_dnst_and_sctr_plt_title",
                                                                                                 "make_ds_descvs_ls",
                                                                                                 "make_ds_smry_ls",
                                                                                                 "make_eq5d_ds_dict",
                                                                                                 "make_ethics_text",
                                                                                                 "make_fake_eq5d_ds",
                                                                                                 "make_fake_ts_data",
                                                                                                 "make_funding_text",
                                                                                                 "make_header_yaml_args_ls",
                                                                                                 "make_indpnt_predrs_lngl_tbl_title",
                                                                                                 "make_indpnt_predrs_lngl_tbls_ref",
                                                                                                 "make_input_params",
                                                                                                 "make_knit_pars_ls",
                                                                                                 "make_lngl_ttu_r2_text",
                                                                                                 "make_lngl_ttu_with_covars_text",
                                                                                                 "make_maui_params_ls",
                                                                                                 "make_mdl",
                                                                                                 "make_mdl_coef_range_text",
                                                                                                 "make_mdl_desc_lines",
                                                                                                 "make_nbr_at_fup_text",
                                                                                                 "make_nbr_included_text",
                                                                                                 "make_new_TTU_predictors_lup",
                                                                                                 "make_output_format_ls",
                                                                                                 "make_path_params_ls",
                                                                                                 "make_predr_vals",
                                                                                                 "make_predr_vars_nms_ls",
                                                                                                 "make_predrs_for_best_mdls",
                                                                                                 "make_prefd_mdls_vec",
                                                                                                 "make_prefd_mdls_vec",
                                                                                                 "make_pt_TTU_predictors_lup",
                                                                                                 "make_random_forest_text",
                                                                                                 "make_results_ls",
                                                                                                 "make_scaling_text",
                                                                                                 "make_scndry_anlys_params",
                                                                                                 "make_scndry_anlys_text",
                                                                                                 "make_selected_mdl_text",
                                                                                                 "make_shareable_mdl",
                                                                                                 "make_study_descs_ls",
                                                                                                 "make_ten_fold_text",
                                                                                                 "make_ten_folds_tbl_title",
                                                                                                 "make_tfmn_cmprsn_plt",
                                                                                                 "make_within_between_ratios_text",
                                                                                                 "predict_utility",
                                                                                                 "print_all_plts_for_mdl_set",
                                                                                                 "print_cohort_table",
                                                                                                 "print_cors_tbl",
                                                                                                 "print_covar_ttu_tbls",
                                                                                                 "print_indpnt_predrs_coefs_tbl",
                                                                                                 "print_indpnt_predrs_lngl_mdl_coefs",
                                                                                                 "print_lngl_ttu_tbls",
                                                                                                 "print_ten_folds_tbl",
                                                                                                 "print_ts_mdl_plts",
                                                                                                 "reorder_cndt_predrs_chr",
                                                                                                 "transform_tb_to_mdl_inp",
                                                                                                 "transform_data_tb_for_cmprsn",
                                                                                                 "transform_ds_for_mdlng",
                                                                                                 "transform_ds_to_predn_ds",
                                                                                                 "transform_mdl_vars_with_clss",
                                                                                                 "transform_tb_to_mdl_inp",
                                                                                                 "write_analyses",
                                                                                                 "write_csp_output",
                                                                                                 "write_main_outp_dir",
                                                                                                 "write_manuscript",
                                                                                                 "write_mdl_cmprsn",
                                                                                                 "write_mdl_type_covars_mdls",
                                                                                                 "write_mdl_type_multi_outps",
                                                                                                 "write_mdls_with_covars_cmprsn",
                                                                                                 "write_predr_and_covars_cmprsn",
                                                                                                 "write_predr_cmprsn_outps",
                                                                                                 "write_report",
                                                                                                 "write_reporting_dir",
                                                                                                 "write_shareable_mdls",
                                                                                                 "write_sngl_predr_multi_mdls_outps",
                                                                                                 "write_to_delete_ds_copies",
                                                                                                 "write_to_delete_mdl_fls",
                                                                                                 "write_ts_mdls_from_alg_outp")),##
                           dev_pkgs_chr = c("cmdstanr",
                                            "ready4","ready4fun",
                                            "ready4use","ready4show",
                                            "youthvars"),
                           lifecycle_stage_1L_chr = "experimental",
                           path_to_pkg_logo_1L_chr = "../../../../../Documentation/Images/TTU-logo/default.png",
                           pkg_dmt_dv_dss_chr = c("https://doi.org/10.7910/DVN/HLLXZN",
                                                  "https://doi.org/10.7910/DVN/2Y9VF9"),
                           ready4_type_1L_chr = "authoring")
x_ready4class_constructor <- ready4class::ready4class_constructor() %>%
  dplyr::bind_rows(tibble::tribble(
    ~ make_s3_lgl, ~ name_stub_chr, ~ pt_ls, ~ pt_chkr_pfx_ls, ~ pt_ns_ls, ~ vals_ls, ~ allowed_vals_ls, ~ min_max_vals_ls, ~ start_end_vals_ls, ~ class_desc_chr, ~ parent_class_chr, ~ slots_ls, ~ meaningful_nms_ls, ~ inc_clss_ls, ~ asserts_ls,
    TRUE, "predictors_lup", list("tibble"), list("is_"),list("tibble"),list(short_name_chr = "character(0)",
                                                                            long_name_chr = "character(0)",
                                                                            min_val_dbl = "numeric(0)",
                                                                            max_val_dbl = "numeric(0)",
                                                                            class_chr = "character(0)",
                                                                            increment_dbl = "numeric(0)",
                                                                            class_fn_chr = "character(0)",
                                                                            mdl_scaling_dbl = "numeric(0)",
                                                                            covariate_lgl = "logical(0)"), NULL,NULL, NULL, "TTU S3 class for candidate predictors lookup table", NA_character_, NULL, NULL, NULL, NULL))
datasets_ls <- list(tibble::tibble(short_name_chr = c("OLS_NTF",
                                                      "OLS_LOG",
                                                      "OLS_LOGIT",
                                                      "OLS_LOGLOG",
                                                      "OLS_CLL",
                                                      "GLM_GSN_LOG",
                                                      "GLM_BNL_LOG",
                                                      "GLM_BNL_LGT",
                                                      "GLM_BNL_CLL",
                                                      "BET_LOG",
                                                      "BET_LGT",
                                                      "BET_CLL"),
                                   long_name_chr = c("Ordinary Least Squares (no transformation)",
                                                     "Ordinary Least Squares (log transformation)",
                                                     "Ordinary Least Squares (logit transformation)",
                                                     "Ordinary Least Squares (log log transformation)",
                                                     "Ordinary Least Squares (complementary log log transformation)",
                                                     "Generalised Linear Model with Gaussian distribution and log link",
                                                     "Generalised Linear Model with Binomial distribution and log link",
                                                     "Generalised Linear Model with Binomial distribution and logit link",
                                                     "Generalised Linear Model with Binomial distribution and complementary log log link",
                                                     "Beta Regression Model with Binomial distribution and log link",
                                                     "Beta Regression Model with Binomial distribution and logit link",
                                                     "Beta Regression Model with Binomial distribution and complementary log log link")) %>%
                      dplyr::mutate(control_chr = c(rep(NA_character_,9),rep("betareg::betareg.control",3)),
                                    family_chr = c(rep(NA_character_,5),"gaussian(log)","quasibinomial(log)","quasibinomial(logit)","quasibinomial(cloglog)", rep(NA_character_,3)),
                                    fn_chr = c(rep("lm",5),rep("glm",4),rep("betareg::betareg",3)),
                                    start_chr = c(rep(NA_character_,5),
                                                  rep("-0.1,-0.1",4),
                                                  rep("-0.5,-0.1,3",3)),

                                    predn_type_chr = c(rep(NA_character_,5),
                                                       rep("response",7)),
                                    tfmn_chr = dplyr::case_when(startsWith(short_name_chr, "OLS_") ~ purrr::map_chr(short_name_chr, ~ {
                                      idx_1L_int <- 1 + stringi::stri_locate_last_fixed(.x,"_")[1,1] %>% as.vector()
                                      stringr::str_sub(.x, start = idx_1L_int)
                                    }),
                                    T ~ "NTF"),
                                    tfmn_for_bnml_lgl = c(rep(F,6),rep(T,3),rep(F,3)),
                                    fixed_acronym_chr = dplyr::case_when(startsWith(short_name_chr, "OLS_") ~ "OLS",
                                                                         T ~ "GLM"),
                                    mixed_acronym_chr = dplyr::case_when(startsWith(short_name_chr, "OLS_") ~ "LMM",
                                                                         T ~ "GLMM"),
                                    mixed_type_chr = dplyr::case_when(startsWith(short_name_chr, "OLS_") ~ "linear mixed model",
                                                                      T ~ "generalised linear mixed model"),
                                    with_chr = long_name_chr %>%
                                      purrr::map_chr(~ifelse(startsWith(.x,"Ordinary Least Squares"),
                                                             stringr::str_remove(.x,"Ordinary Least Squares ") %>%
                                                               stringr::str_sub(start = 2, end = -2),
                                                             stringr::str_remove(.x,"Generalised Linear Model with ") %>%
                                                               stringr::str_remove("Beta Regression Model with ")))) %>%
                      ready4fun::make_pkg_ds_ls(db_1L_chr = "mdl_types_lup",
                                                title_1L_chr = "Model types lookup table",
                                                desc_1L_chr = "A lookup table of abbreviations to describe the different model types supported by TTU functions"),
                    tibble::tibble(short_name_chr = c("coefs","hetg",
                                                      "dnst","sctr_plt",
                                                      "sim_dnst","sim_sctr",
                                                      "cnstrd_dnst","cnstrd_sctr_plt",
                                                      "cnstrd_sim_dnst","cnstrd_sim_sctr"),
                                   long_name_chr = c("population level effects",
                                                     "group level effects",
                                                     "comparative densities of observed data and predictions using mean model parameter values",
                                                     "comparative scatter plot of observed and predictions using mean model parameter values",
                                                     "comparative densities of observed data and predictions using sampled model parameter values",
                                                     "comparative scatter plot of observed and predictions using sampled model parameter values",
                                                     "comparative densities of observed data and predictions using mean model parameter values and transformation of out of range predictions to upper and lower bounds",
                                                     "comparative scatter plot of observed and predictions using mean model parameter values and transformation of out of range predictions to upper and lower bounds",
                                                     "comparative densities of observed data and predictions using sampled model parameter values and transformation of out of range predictions to upper and lower bounds",
                                                     "comparative scatter plot of observed and predictions using sampled model parameter values and transformation of out of range predictions to upper and lower bounds")) %>%
                      ready4fun::make_pkg_ds_ls(db_1L_chr = "plt_types_lup",
                                                title_1L_chr = "Model plot types lookup table",
                                                desc_1L_chr = "A lookup table of abbreviations to describe the different model plot types supported by TTU functions"),
                    # ADD TO PLOTS TABLE: # AUTOPLT # LNR_CMPRSN  # PRED_DNSTY # PRED_SCTR # SIM_DNSTY # BORUTA_VAR_IMP # RF_VAR_IMP
                    tibble::tibble(rprt_nms_chr = "AAA_TTU_MDL_CTG",
                                   title_chr = "Results supplement: longitudinal transfer to utility models.",
                                   paths_to_rmd_dir_1L_chr = NA_character_,
                                   pkg_dirs_chr = "Markdown",
                                   packages_chr = "TTU",
                                   nms_of_rmd_chr = "Report_TS_Mdls.RMD",
                                   rltv_paths_to_outp_yaml_chr = "_output.yml") %>%
                      tibble::add_case(rprt_nms_chr = "AAA_PMRY_ANLYS_MTH",
                                       title_chr = "Methods supplement: Main analysis algorithm",
                                       paths_to_rmd_dir_1L_chr = NA_character_,
                                       pkg_dirs_chr = "Markdown",
                                       packages_chr = "TTU",
                                       nms_of_rmd_chr = "Analyse.Rmd") %>%
                      tibble::add_case(rprt_nms_chr = "AAA_RPRT_WRTNG_MTH",
                                       title_chr = "Methods supplement: algorithm to auto-generate reports.",
                                       paths_to_rmd_dir_1L_chr = NA_character_,
                                       pkg_dirs_chr = "Markdown",
                                       packages_chr = "TTU",
                                       nms_of_rmd_chr = "Report.Rmd") %>%
                      ready4fun::make_pkg_ds_ls(db_1L_chr = "rprt_lup",
                                                title_1L_chr = "Report types lookup table",
                                                desc_1L_chr = "A lookup table of the different report types supported by TTU functions"))
x_ready4use_manifest <- ready4use::make_pt_ready4use_manifest(x_ready4fun_manifest,
                                                              constructor_r3 = x_ready4class_constructor,
                                                              pkg_ds_ls_ls = datasets_ls) %>%
  ready4use::ready4use_manifest()
x_xx <- ready4::author(x_ready4use_manifest)

# usethis::use_package("betareg")
# usethis::use_package("eq5d")
# usethis::use_package("ggfortify")
# usethis::use_dev_package("cmdstanr")
# usethis::use_package("knitrBootstrap")
# usethis::use_package("readr")
# usethis::use_package("rmarkdown",type = "Suggests")
# usethis::use_dev_package("ready4show")
# usethis::use_dev_package("ready4use")
# usethis::use_dev_package("youthvars")
#usethis::use_package("knitr", type = "suggests")
#usethis::use_package("rgl")
#
