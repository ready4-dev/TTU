---
title: "Main Workflow"
output: html_document
params:
  path_to_data_1L_chr: !r NA_character_
  path_to_write_fls_to_1L_chr: "../../../../../../Data/Project/Utility_Models"
  run_chunks_1L_lgl: FALSE
  dir_nm_1L_chr: "One_Predr_Output"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = F,
                      eval = F)
library(xtable) 
library(FBaqol) 
library(magrittr)
```

# Specify input data

The first step is to import the raw data. Note, for this example, purely synthetic data has been used - all results are therefore purely illustrative.

```{r eval = T}
if(!is.na(params$path_to_data_1L_chr)){
  raw_data_tb <- transform_raw_aqol_tb_to_aqol6d_tb(readRDS(params$path_to_data_1L_chr))
}else{
  raw_data_tb <- FBaqol::replication_popl_tb
}
path_to_write_fls_to_1L_chr <- params$path_to_write_fls_to_1L_chr
dir_nm_1L_chr <- params$dir_nm_1L_chr
path_to_write_to_1L_chr <- paste0(path_to_write_fls_to_1L_chr,
                                                      "/",
                                                      dir_nm_1L_chr)
```

# Calculate AQoL scores and test candidate models, predictors and confounders

The next step implements an algorithm to convert AQoL6D item responses into AQoL6D-Adolescent utility scores and to examine a range of candidate models, predictors and confounders. In this example we have chosen to override models preferred by the automated algorithm with two we have pre-specified. The rationale for this choice is outlined in the main paper.

```{r}
outp_smry_ls <- write_all_alg_outps(raw_data_tb = raw_data_tb,
                    path_to_write_to_1L_chr = path_to_write_to_1L_chr,
                    aqol6d_q_pfx_1L_chr = "aqol6d_q",
                    dep_var_nm_1L_chr = "aqol6d_total_w",
                    candidate_predrs_chr = c("BADS","GAD7","K6","OASIS","PHQ9","SCARED"),
                    candidate_covar_nms_chr = c("d_sex_birth_s", "SOFAS", "c_p_diag_s", "c_clinical_staging_s", "d_age",  "d_sexual_ori_s", "d_country_bir_s", "d_relation_s", "d_studying_working"),
                    id_var_nm_1L_chr ="fkClientID",
                    round_var_nm_1L_chr = "round",
                    round_bl_val_1L_chr = "Baseline",
                    mdl_types_chr = mdl_types_lup$short_name_chr, 
                    prefd_mdl_types_chr = c("GLM_GSN_LOG","OLS_CLL"),
                    choose_from_pfx_chr = c("GLM","OLS", "BET"),
                    prefd_covars_chr = NA_character_,
                    seed_1L_int = 12345,
                    n_folds_1L_int = 10L,
                    max_nbr_of_boruta_mdl_runs_int = 300L,
                    mdl_types_lup = mdl_types_lup)

```

# Apply selected models to selected predictors

The models, predictors and potential confounders selected in the previous step are now run. Note for this step to work for models other than our selected models, it will be necessary to write new functions that are passed to the fn_ls argument. We plan to do this at a later date. Also note, that CMDSTANR needs to be installed in your machine to run this function. It is possible to try to run this function with "rstan" as the backend_1L_chr argument value, but in our experience using rstan can cause RStudio to crash.

```{r}
outp_smry_ls <- write_ts_mdls_from_alg_outp(outp_smry_ls,
                                            fn_ls = list(fit_gsn_log_lnk,fit_clg_log_tfmn),
                                            backend_1L_chr = "cmdstanr",
                                            iters_1L_int = 1000L)
```

# Create shareable version of predictive models
It is not appropriate to share the raw models created in the previous step publicly (as they contain confidential data and are very large in file size). We therefore create shareable versions that are relatively small in file size and contain no confidential data, but that have the coefficients from the original models. This function call writes shareable models to your local machine and, if you have a Dataverse account and supply the details for the account in the dv_ls argument (which will differ from the ones we use for ours below), will push these shareable models to the Dataverse online data repository. If you do not have  a Dataverse account, do not use the dv_ls argument (or set it to its default value of NULL). The files created in the following step are available here (temporary URL, to be replaced when we publish the data repository):

https://dataverse.harvard.edu/privateurl.xhtml?token=37736f13-4d32-4afa-a03a-ad82c0d7d4e0

```{r include=F, eval=T}
if(T){
  outp_smry_ls <- readRDS(paste0(path_to_write_to_1L_chr,"/I_ALL_OUTPUT_.RDS"))
}
```

```{r eval=T}

outp_smry_ls$dv_ls <- list(dv_nm_1L_chr = "ready4models",
                               ds_url_1L_chr = "https://doi.org/10.7910/DVN/GRZRY5",
                               parent_dv_dir_1L_chr = "../../../../../../Data/Dataverse")
outp_smry_ls <- write_shareable_mdls(outp_smry_ls,
                                     sub_dir_1L_chr = "Shareable")
```


# Create shareable population data

Similar to the previous step, we can create a purely synthetic dataset, representative of the source data, but containing no real data on any individual.

```{r eval=T}
outp_smry_ls$fk_data_tb <- make_fake_ts_data(outp_smry_ls)
```

# Predict


We now have a range of models that we can use for prediction. To put this to use, we can run the following function. The model passed to the argument mdl can either be one you have generated yourself using the previous steps, or one created by others that you download from a data repository.

```{r eval=T}
add_adol6d_predn_to_ds(data_tb = outp_smry_ls$fk_data_tb,
                       mdl = outp_smry_ls$sharble_mdls_ls$PHQ9_1_OLS_CLL,
                       tfmn_1L_chr = "CLL") %>% head() 
```

# Create report
You can create reports based on the output saved to your local machine in the preceding steps. As per previously, if you have supplied details about a Dataverse account, the report is sent to your online data repository as well. One sample report is generated below and is available for viewing at the same temporary URL used for the shareable models:

 https://dataverse.harvard.edu/privateurl.xhtml?token=37736f13-4d32-4afa-a03a-ad82c0d7d4e0

```{r}
outp_smry_ls <- write_rprt(outp_smry_ls,
           nm_of_RMD_1L_chr = "_Mdls_Report.RMD",
           output_type_1L_chr = "PDF",
           section_type_1L_chr = "#",
           reports_dir_1L_chr = "Reports",
           markdown_dir_1L_chr = "Markdown",
           file_nm_1L_chr = "Main_Mdl_Smry")
```

# Save work

Finally, we save a complete record of our analysis.

```{r}
saveRDS(outp_smry_ls,paste0(outp_smry_ls$path_to_write_to_1L_chr,"/I_ALL_OUTPUT_.RDS"))
```

