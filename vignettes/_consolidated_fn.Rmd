---
title: "Main Workflow"
output: html_document
params:
  path_to_data_1L_chr: !r NA_character_
  path_to_write_fls_to_1L_chr: "../../../../../../Data/Project/Utility_Models"
  dir_nm_1L_chr: "One_Predr_Output"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = F,
                      eval = T)
library(xtable) 
library(FBaqol) 
library(magrittr)
```

# Specify input data

The first step is to import the raw data. Note, for this example, purely synthetic data has been used - all results are therefore purely illustrative.

```{r}
if(!is.na(params$path_to_data_1L_chr)){
  raw_data_tb <- transform_raw_aqol_tb_to_aqol6d_tb(readRDS(params$path_to_data_1L_chr))
}else{
  raw_data_tb <- FBaqol::replication_popl_tb
}
path_to_write_fls_to_1L_chr <- params$path_to_write_fls_to_1L_chr
dir_nm_1L_chr <- params$dir_nm_1L_chr
path_to_write_to_1L_chr <- paste0(path_to_write_fls_to_1L_chr,
                                                      "/",
                                                      dir_nm_1L_chr)
```

# Calculate AQoL scores and test candidate models, predictors and confounders

The next step implements an algorithm to convert AQoL6D item responses into AQoL6D-Adolescent utility scores and to examine a range of candidate models, predictors and confounders. In this example we have chosen to override models preferred by the automated algorithm
```{r}
outp_smry_ls <- write_all_alg_outps(raw_data_tb = raw_data_tb,
                    path_to_write_to_1L_chr = path_to_write_to_1L_chr,
                    aqol6d_q_pfx_1L_chr = "aqol6d_q",
                    dep_var_nm_1L_chr = "aqol6d_total_w",
                    candidate_predrs_chr = c("BADS","GAD7","K6","OASIS","PHQ9","SCARED"),
                    candidate_covar_nms_chr = c("d_sex_birth_s", "SOFAS", "c_p_diag_s", "c_clinical_staging_s", "d_age",  "d_sexual_ori_s", "d_country_bir_s", "d_relation_s", "d_studying_working"),
                    id_var_nm_1L_chr ="fkClientID",
                    round_var_nm_1L_chr = "round",
                    round_bl_val_1L_chr = "Baseline",
                    mdl_types_chr = mdl_types_lup$short_name_chr, 
                    prefd_mdl_types_chr = c("GLM_GSN_LOG","OLS_CLL"),
                    choose_from_pfx_chr = c("GLM","OLS", "BET"),
                    prefd_covars_chr = NA_character_,
                    seed_1L_int = 12345,
                    n_folds_1L_int = 10L,
                    max_nbr_of_boruta_mdl_runs_int = 300L,
                    mdl_types_lup = mdl_types_lup)

```

# Apply selected models to selected predictors

```{r}
outp_smry_ls <- write_ts_mdls_from_alg_outp(outp_smry_ls,
                                            fn_ls = list(fit_gsn_log_lnk,fit_clg_log_tfmn),
                                            backend_1L_chr = "cmdstanr",
                                            iters_1L_int = 1000L)
```

# Create shareable version of predictive models

```{r}
outp_smry_ls <- write_shareable_mdls(outp_smry_ls,
                                     sub_dir_1L_chr = "Shareable",
                                     dv_ls = list(dv_nm_1L_chr = "ready4models",
                               ds_url_1L_chr = "https://doi.org/10.7910/DVN/GRZRY5",
                               parent_dv_dir_1L_chr = "../../../../../../Data/Dataverse"))
```

This function call writes shareable models to your local machine and, if you have a Dataverse account and supply the details for the account in the dv_ls argument, will push these shareable models to the Dataverse online data repository. If you do not have  a Dataverse account, do not use the dv_ls argument (or set it to its default value of NULL).

```{r}
outp_smry_ls$fk_data_tb <- make_fake_ts_data(outp_smry_ls)
```


# Predict

```{r}
add_adol6d_predn_to_ds(data_tb = outp_smry_ls$fk_data_tb,
                       mdl = outp_smry_ls$sharble_mdls_ls$PHQ9_1_OLS_CLL,
                       tfmn_1L_chr = "CLL")%>% head() 
```

# Create report

```{r}

write_rprt(outp_smry_ls,
           nm_of_RMD_1L_chr = "_Mdls_Report.RMD",
           output_type_1L_chr = "PDF",
           section_type_1L_chr = "#",
           reports_dir_1L_chr = "Reports",
           markdown_dir_1L_chr = "Markdown",
           file_nm_1L_chr = "Main_Mdl_Smry")
```

```{r}

```


```{r}
  dss_tb <- tibble::tibble(ds_obj_nm_chr = "Main_Mdl_Smry",
                           title_chr = "Summary report of the models estimated from synthetic data to map a number of mental health measures to adolescent AQoL-6D scores.")
ready4use::write_fls_to_dv_ds(dss_tb,
                               dv_nm_1L_chr = "ready4models",
                               ds_url_1L_chr = "https://doi.org/10.7910/DVN/GRZRY5",
                               parent_dv_dir_1L_chr = "../../../../../../Data/Dataverse",
                               paths_to_dirs_chr = paste0(params$path_to_write_fls_to_1L_chr,"/Reports"),
                               inc_fl_types_chr = ".pdf")
```
Report is available at: https://dataverse.harvard.edu/privateurl.xhtml?token=37736f13-4d32-4afa-a03a-ad82c0d7d4e0

# Save work

```{r}

saveRDS(outp_smry_ls,paste0(outp_smry_ls$path_to_write_to_1L_chr,"/I_ALL_OUTPUT_.RDS"))
```

