---
title: "Reporting Workflow, AQoL-6D Clinical Population Example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Reporting Workflow, AQoL-6D Clinical Population Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

\blandscape
<!---BLOCK_LANDSCAPE_START--->

This vignette is an example of implementing of analysis, reporting and sharing workflow to develop transfer to AQoL-6D health utility models. Some of the initial steps in this example are described in more detail in the [EQ-5D example](CSP_EQ5D_TTU.html).
```{r echo = TRUE, message=FALSE}
library(TTU)
```

# Input parameters

## Reporting parameters

### Bibliograhic data
We begin by specifying the authorship and other bibliographic data that we wish to attach to all reports that we generate.

```{r}
header_yaml_args_ls <- make_header_yaml_args_ls(authors_tb = ready4show::authors_tb,
                                                institutes_tb = ready4show::institutes_tb,
                                                title_1L_chr = "A hypothetical study using fake data for instructional purposes only",
                                                keywords_chr = c("this","is","a","replication","using","fake","data","do", "not","cite"))
```

### Report formatting
We add parameters relating to the desired output format of the reports we will be producing.

```{r }
output_format_ls <- make_output_format_ls(manuscript_outp_1L_chr = "Word",
                                          manuscript_digits_1L_int = 2L,
                                          supplementary_outp_1L_chr = "PDF",
                                          supplementary_digits_1L_int = 2L)
```

## Data parameters

### Dataset
We read in our study dataset (in this case we are using fake data).

```{r message=FALSE}
ds_tb <- youthvars::replication_popl_tb %>% 
            youthvars::transform_raw_ds_for_analysis() 
```

### Dataset metadata
We describe the features of our dataset that are most relevant to the analyses we are planning to undertake. 

```{r echo = TRUE}
ds_descvs_ls <- make_ds_descvs_ls(candidate_predrs_chr = c("K6","PHQ9"),#
                                  candidate_covar_nms_chr = c("d_age", "SOFAS",
                                                              "c_p_diag_s",
                                                              "c_clinical_staging_s", 
                                                              "d_relation_s",
                                                              "d_studying_working"),
                                  cohort_descv_var_nms_chr = c("d_age","d_relation_s",
                                                               "d_studying_working",
                                                               "c_p_diag_s","c_clinical_staging_s",
                                                               "SOFAS"),
                                  dictionary_tb = youthvars::make_final_rpln_ds_dict(), 
                                  id_var_nm_1L_chr = "fkClientID", 
                                  is_fake_1L_lgl = T,
                                  msrmnt_date_var_nm_1L_chr = "d_interview_date",
                                  round_var_nm_1L_chr = "round", 
                                  round_vals_chr = c("Baseline", "Follow-up"),
                                  maui_item_pfx_1L_chr = "aqol6d_q", 
                                  utl_wtd_var_nm_1L_chr = "aqol6d_total_w", 
                                  utl_unwtd_var_nm_1L_chr = "aqol6d_total_c")
```

### Candidate predictors metadata
We create a lookup table with metadata on the dataset variables that we specified in the `candidate_predrs_chr` element of `ds_descvs_ls` as our candidate predictors, as well as the preferred covariates that we will specify later in the `make_valid_params_ls_ls` function.

```{r}
predictors_lup <- make_pt_TTU_predictors_lup(short_name_chr = c(ds_descvs_ls$candidate_predrs_chr, "SOFAS"),
                                              long_name_chr = c("K6 total score", "PHQ9 total score", "SOFAS total score"),
                                              min_val_dbl = 0,
                                              max_val_dbl = c(24,27,100),
                                              class_chr = "integer",
                                              increment_dbl = 1,
                                              class_fn_chr = c("youthvars::youthvars_k6",
                                                               "youthvars::youthvars_phq9",
                                                               "youthvars::youthvars_sofas"),
                                              mdl_scaling_dbl = 0.01,
                                              covariate_lgl = F) %>%
  TTU_predictors_lup()
```

## Analysis parameters

### Multi-Attribute Utility Instrument (MAUI) parameters
We also need to provide information specific to the MAUI used to collect the data from which health utility will be derived.

```{r}
maui_params_ls <- make_maui_params_ls(maui_domains_pfcs_1L_chr = "vD",
                                      maui_itm_short_nms_chr = c("Household tasks", "Getting around","Morbility","Self care","Enjoy close rels","Family rels", "Community involvement","Despair","Worry", "Sad", "Agitated","Energy level","Control", "Coping","Frequency of pain", "Degree of pain","Pain interference","Vision", "Hearing","Communication"),
                                      maui_scoring_fn = youthvars::add_adol6d_scores,
                                      short_and_long_nm = c("AQoL-6D",
                                                            "Assessment of Quality of Life - Six Dimension"),
                                      utl_min_val_1L_dbl = 0.03)
```

## Path parameters
We next create an object that specifies the relative locations of the input data and the intended destination for analysis outputs and reports. The default settings of the `make_path_params_ls` function will write all output into a new directory, created one level up from the current working directory.

## Analysis parameters
We can now create a list of input parameters using the `make_input_params` function, principally using the objects created in the preceding steps. We can force the use of specified model types or covariates (rather than allowing the analysis algorithm to select these based on automated criteria) by using the `prefd_mdl_types_chr` and `prefd_covars_chr` arguments. We can also specify how we want to adapt our primary analysis input parameters for secondary analyses (e.g. that use different combinations of candidate predictors and covariates) using the `scndry_anlys_params_ls ` argument in conjunction with the `make_scndry_anlys_params` function. If you have created an empty dataverse dataset to post results to, assign the DOI for your dataset and the name of the dataverse containing it to the `dv_ds_nm_and_url_chr` argument (these values will be unique to you and different to those below, which will not work for you). If you do not wish to post results to a dataverse dataset, set `dv_ds_nm_and_url_chr = NULL`. The `make_input_params` function performs a number of checks relating to the naming conventions used in some variables of interest and where necessary (for consistency with reporting templates) modifies the names of these variables.

```{r eval = F }
input_params_ls <- make_input_params(ds_tb,
                                     ds_descvs_ls = ds_descvs_ls,
                                     dv_ds_nm_and_url_chr = c("fakes", # Dataverse containing dataset
                                                              "https://doi.org/10.7910/DVN/D74QMP"), # DOI
                                     header_yaml_args_ls = header_yaml_args_ls,
                                     maui_params_ls = maui_params_ls,
                                     output_format_ls = output_format_ls,
                                     predictors_lup = predictors_lup,
                                     prefd_covars_chr = "SOFAS",
                                     prefd_mdl_types_chr = c("OLS_CLL","GLM_GSN_LOG"),
                                     scndry_anlys_params_ls = make_scndry_anlys_params(candidate_predrs_chr = c("SOFAS"),
                                                   prefd_covars_chr = NA_character_))

```

# Run analysis
All analytic steps for our primary and secondary analyses are executed with the following function call. Note, this step can involve long execution times (potentially over an hour, depending on the input parameters).
```{r}
write_analyses(input_params_ls)
```

# Report results
We now generate the catalogues (one for the primary and one for each secondary analysis) that report the models created in the preceding step. The `write_mdl_smry_rprt` function also creates shareable versions (i.e. with copies of source dataset replaced by synthetic data) of the models. This step can take several minutes to execute.

```{r echo = TRUE, eval=FALSE }
input_params_ls <- write_mdl_smry_rprt(input_params_ls,
                                       use_shareable_mdls_1L_lgl = T)
```

# Share results
We can now share the results created in the previous step by posting them to the online repository, the details of which we supplied earlier. 

```{r echo = TRUE, eval=FALSE }
write_study_outp_ds(input_params_ls)
```

The `write_study_outp_ds` function writes its outputs to a draft dataset - which you can review by logging into your dataverse account, before clicking on the option to publish the dataset. The stucture of your draft dataset should be similar to those produced by this vignette, which are viewable at: https://doi.org/10.7910/DVN/D74QMP

# Create manuscript
The first step to creating a manuscript that provides the scientific summary of the study is to provide some metadata about the study itself. If you want the manuscript to refer to some of the candidate predictors by different names than that provided in the `short_name_chr` column of the `predictors_lup` object defined earlier, you can create a table of name correspondences and pass it to the `var_nm_change_lup` argument.

```{r}
input_params_ls <- make_study_descs_ls(input_params_ls = input_params_ls,
                                       background_1L_chr = "Our study is entirely fictional and has been created to illustrate TTU package functionality.",
                                       coi_1L_chr = "None declared.",
                                       conclusion_1L_chr = "If this study was real, the results would be interesting.",
                                       ethics_1L_chr = "The study was reviewed and granted approval by Awesome University's Human Research Ethics Committee (1111111.1).",
                                       funding_1L_chr = "The study was funded by Generous Benefactor.",
                                       sample_desc_1L_chr = "The study sample is fake data that pretends to be young people aged 12 to 25 years who attended Australian primary care services for mental health related needs between November 2019 to August 2020.",
                                       time_btwn_bl_and_fup_1L_chr = "three months",
                                       var_nm_change_lup = tibble::tibble(old_nms_chr = c("PHQ9","GAD7"),
                                                                          new_nms_chr = c("PHQ-9",
                                                                                          "GAD-7")))
```
```{r eval = F}
write_manuscript <- function(abstract_args_ls = NULL,
                             input_params_ls = NULL,
                             results_ls = NULL,
                             version_1L_chr = "0.1"){
    mkdn_data_dir_1L_chr <- ifelse(!is.null(input_params_ls),
                                   input_params_ls$path_params_ls$paths_ls$mkdn_data_dir_1L_chr,
                                   input_params_ls$path_params_ls$paths_ls$mkdn_data_dir_1L_chr)
  if(!dir.exists(paste0(mkdn_data_dir_1L_chr,"/ttu_lng_ss-",version_1L_chr))){
 temp_fl <- tempfile() 
 download.file(paste0("https://github.com/ready4-dev/ttu_lng_ss/archive/refs/tags/v",
                      version_1L_chr,
                      ".zip",
                      temp_fl)
utils::unzip(temp_fl, 
             exdir = mkdn_data_dir_1L_chr)
unlink(temp_fl)
  }
    if(is.null(results_ls)){
        results_ls <- make_results_ls(dv_ds_nm_and_url_chr = input_params_ls$path_params_ls$dv_ds_nm_and_url_chr,
                                output_format_ls = input_params_ls$output_format_ls,
                                params_ls_ls = input_params_ls,
                                path_params_ls = input_params_ls$path_params_ls,
                                study_descs_ls = input_params_ls$study_descs_ls,
                                var_nm_change_lup = input_params_ls$study_descs_ls$var_nm_change_lup,
                                version_1L_chr = version_1L_chr)
    }

                             }




```

```{r eval=FALSE}


```
```{r echo = FALSE, eval=FALSE }
saveRDS(results_ls,paste0(path_params_ls$paths_ls$output_data_dir_1L_chr,"/results_ls.RDS"))
  # rmarkdown::render("AQoL_VIH/AQoL_VIH.Rmd",
  #                   output_format = NULL,
  #                   params = list(figures_in_body_lgl = F,
  #                                 output_type_1L_chr = "Word",
  #                                 results_ls = results_ls,
  #                                 tables_in_body_lgl = F),
  #                   output_file = paste0("AQoL_VIH", ".docx"),
  #                   output_dir = path_params_ls$paths_ls$reports_dir_1L_chr)
# }
```

# Purge dataset copies
All remaining local copies (but not the original version) of the study dataset are deleted from the workspace.

```{r echo = TRUE, eval=FALSE }
write_to_delete_ds_copies(path_params_ls$paths_ls)
```

\elandscape
<!---BLOCK_LANDSCAPE_STOP--->
