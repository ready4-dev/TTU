---
title: "AQoL-6D mappign using GLMM with anxiety/depression measurements and SOFAS score"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#load libraries 
library(pacman)
p_load("dplyr", "tidyr","magrittr","reshape2", "ggplot2","gridExtra", "data.table",  "kableExtra", "knitr",  "here","tidyselect","scales", "ggpubr","Hmisc","stringr","psych","corrplot","arsenal","lavaan","semTools","semPlot","sandwich",
"ggalt","viridis", "ggthemes", "caret","brms")

sessionInfo()

```



# Import the data 

```{r}
Baseline_follow<-readRDS( here::here("Data cleaning","Data","Combined_cleaned_V2.rds")) %>%     
  mutate(d_agegroup_s=cut(d_age,breaks=c(11,17,30), labels=c("Age 12-17","Age 18-26"))) %>% 
  filter(!is.na(aqol6d_total_w)) %>% 
  mutate(round=factor(round,labels=c("Baseline","Follow-up"))) %>% 
  dplyr::select(fkClientID, c_p_diag_s , s_centre, c_clinical_staging_s, 
          d_age , d_agegroup ,d_gender,
          d_sex_birth_s , d_sexual_ori_s ,
          d_country_bir_s, d_ATSI,d_english_home, d_english_native, 
          d_relation_s,  d_studying_working, k6_total, 
          phq9_total, bads_total, gad7_total,oasis_total,
          scared_total, 
          contains("aqol6d"),c_sofas, round) %>% 
  mutate(Gender= factor(ifelse(d_gender =="Genderqueer/gender nonconforming/agender" | 
                d_gender=="Transgender" , "Other", as.character(d_gender))))   %>% 
  mutate(Region=as.factor(ifelse(s_centre=="Canberra" |  s_centre=="Southport" | s_centre=="Knox", "Metro","Regional"))) %>% 
  mutate(CALD=factor(ifelse(d_country_bir_s=="Other" | d_english_home=="No" | d_english_native=="No" | d_ATSI=="Yes" , "Yes", "No" ))) %>%
  rename(PHQ9=phq9_total,BADS=bads_total,GAD7=gad7_total,OASIS=oasis_total, SCARED=scared_total,K6=k6_total,SOFAS=c_sofas)

nrow(Baseline_follow)

```

Check missing

```{r}
# non missing 
table(Baseline_follow[!is.na(Baseline_follow$aqol6d_total_c),]$round)

nrow(Baseline_follow)
```

# Generallized mixed effect 

## PHQ9 


```{r,warning=FALSE}
dta <- Baseline_follow %>% 
    dplyr::select(aqol6d_total_w,PHQ9,fkClientID,round,SOFAS) %>% 
    group_by(fkClientID) %>% 
    arrange(fkClientID,round) %>% 
    mutate(phq9_baseline=first(PHQ9)/100) %>% 
    mutate(phq9_change=ifelse(round=="Baseline",0,(PHQ9-lag(PHQ9))/100))  %>% 
    mutate(sofas_baseline=first(SOFAS)/100) %>% 
    mutate(sofas_change=ifelse(round=="Baseline",0,(SOFAS-lag(SOFAS))/100))  %>% 
    mutate(aqol6d_total_w_cloglog= log(-log(1-ifelse(aqol6d_total_w==1,0.999,aqol6d_total_w)))) %>% 
    na.omit() 

```

### Gaussian with log link

```{r}

brm_model <- brm(formula = aqol6d_total_w ~ phq9_baseline + phq9_change  + sofas_baseline + sofas_change+ (1|fkClientID), data = dta, family = gaussian(link="log"), iter = 4000,seed=12345)
plot(brm_model)
summary(brm_model, digits = 4)

k<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
k<-rbind(k,bayes_R2(brm_model),summary(brm_model, digits = 4)$spec_par[1:4])


result1<-data.frame(round(k,3))  %>% 
    mutate(Parameter=c("PHQ9 baseline", "PHQ9 change", "SOFAS baseline", "SOFAS chage","R2", "Sigma"),
    Model="PHQ9 model") %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Model,Parameter,Estimate,  SE, `95% CI`)

set.seed(23456)
dta$Predicted<-predict(brm_model)[,1]
dta %>% 
    mutate(Observed=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Observed) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() + 
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",y="Density", fill="") 

ggplot(dta) + 
  geom_point(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1) +
  theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#de2d26","#fc9272"))  +
  labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
  theme(legend.position="bottom")
```

### Cloglog transformed AQoL-6D scores

```{r}

brm_model <- brm(formula = aqol6d_total_w_cloglog ~ phq9_baseline + phq9_change  + sofas_baseline + sofas_change+ (1|fkClientID), data = dta, family = gaussian(link="identity"), iter = 4000,seed=12345)
plot(brm_model)
summary(brm_model, digits = 4)

k<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
k<-rbind(k,bayes_R2(brm_model),summary(brm_model, digits = 4)$spec_par[1:4])

result2<-data.frame(round(k,3))  %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Estimate,  SE, `95% CI`)

results<-cbind(result1,result2)


set.seed(23456)
dta$Predicted<-1-exp(-exp(predict(brm_model)[,1]))
dta %>% 
    mutate(Observed=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Observed) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() + 
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",y="Density", fill="") 

ggplot(dta,aes(x=aqol6d_total_w,y=Predicted,col=round)) + 
  geom_point(,size=1) +
  theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#de2d26","#fc9272"))  +
  labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
  theme(legend.position="bottom") + geom_smooth()
```



## BADS 

```{r,warning=FALSE}
dta <- Baseline_follow %>% 
    dplyr::select(aqol6d_total_w,BADS,fkClientID,round,d_sex_birth_s,SOFAS) %>% 
    group_by(fkClientID) %>% 
    arrange(fkClientID,round) %>% 
    mutate(bads_baseline=first(BADS)/100) %>% 
    mutate(bads_change=ifelse(round=="Baseline",0,(BADS-lag(BADS))/100))  %>% 
    mutate(sofas_baseline=first(SOFAS)/100) %>% 
    mutate(sofas_change=ifelse(round=="Baseline",0,(SOFAS-lag(SOFAS))/100))  %>%
    mutate(aqol6d_total_w_cloglog= log(-log(1-ifelse(aqol6d_total_w==1,0.999,aqol6d_total_w)))) %>% 
    na.omit() 

```


### Gaussian with log link

```{r}

brm_model <- brm(formula = aqol6d_total_w ~ bads_baseline + bads_change  + sofas_baseline + sofas_change+ (1|fkClientID), data = dta, family = gaussian(link="log"), iter = 4000,seed=12345)
plot(brm_model)
summary(brm_model, digits = 4)

k<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
k<-rbind(k,bayes_R2(brm_model),summary(brm_model, digits = 4)$spec_par[1:4])


result1<-data.frame(round(k,3))  %>% 
    mutate(Parameter=c("BADS baseline", "BADS change", "SOFAS baseline", "SOFAS chage","R2", "Sigma"),
    Model="BADS model") %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Model,Parameter,Estimate,  SE, `95% CI`)

set.seed(23456)
dta$Predicted<-predict(brm_model)[,1]
dta %>% 
    mutate(Observed=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Observed) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() + 
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",y="Density", fill="") 

ggplot(dta) + 
  geom_point(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1) +
  theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#de2d26","#fc9272"))  +
  labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
  theme(legend.position="bottom")
```

### Cloglog transformed AQoL-6D scores

```{r}

brm_model <- brm(formula = aqol6d_total_w_cloglog ~ bads_baseline + bads_change  + sofas_baseline + sofas_change+ (1|fkClientID), data = dta, family = gaussian(link="identity"), iter = 4000,seed=12345)
plot(brm_model)
summary(brm_model, digits = 4)

k<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
k<-rbind(k,bayes_R2(brm_model),summary(brm_model, digits = 4)$spec_par[1:4])

result2<-data.frame(round(k,3))  %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Estimate,  SE, `95% CI`)

results<-rbind(results,cbind(result1,result2)) 


set.seed(23456)
dta$Predicted<-1-exp(-exp(predict(brm_model)[,1]))
dta %>% 
    mutate(Observed=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Observed) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() + 
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",y="Density", fill="") 

ggplot(dta) + 
  geom_point(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1) +
  theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#de2d26","#fc9272"))  +
  labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
  theme(legend.position="bottom")
```


## GAD7 

```{r,warning=FALSE}
dta <- Baseline_follow %>% 
    dplyr::select(aqol6d_total_w,GAD7,fkClientID,round,d_sex_birth_s,SOFAS) %>% 
    group_by(fkClientID) %>% 
    arrange(fkClientID,round) %>% 
    mutate(gad7_baseline=first(GAD7)/100) %>% 
    mutate(gad7_change=ifelse(round=="Baseline",0,(GAD7-lag(GAD7))/100))  %>% 
    mutate(sofas_baseline=first(SOFAS)/100) %>% 
    mutate(sofas_change=ifelse(round=="Baseline",0,(SOFAS-lag(SOFAS))/100))  %>% 
    mutate(aqol6d_total_w_cloglog= log(-log(1-ifelse(aqol6d_total_w==1,0.999,aqol6d_total_w)))) %>% 
    na.omit() 
```


### Gaussian with log link

```{r}

brm_model <- brm(formula = aqol6d_total_w ~ gad7_baseline + gad7_change  + sofas_baseline + sofas_change+ (1|fkClientID), data = dta, family = gaussian(link="log"), iter = 4000,seed=12345)
plot(brm_model)
summary(brm_model, digits = 4)

k<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
k<-rbind(k,bayes_R2(brm_model),summary(brm_model, digits = 4)$spec_par[1:4])


result1<-data.frame(round(k,3))  %>% 
    mutate(Parameter=c("GAD7 baseline", "GAD7 change", "SOFAS baseline", "SOFAS chage","R2", "Sigma"),
    Model="GAD7 model") %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Model,Parameter,Estimate,  SE, `95% CI`)

set.seed(23456)
dta$Predicted<-predict(brm_model)[,1]
dta %>% 
    mutate(Observed=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Observed) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() + 
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",y="Density", fill="") 

ggplot(dta) + 
  geom_point(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1) +
  theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#de2d26","#fc9272"))  +
  labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
  theme(legend.position="bottom")
```

### Cloglog transformed AQoL-6D scores

```{r}

brm_model <- brm(formula = aqol6d_total_w_cloglog ~ gad7_baseline + gad7_change  + sofas_baseline + sofas_change+ (1|fkClientID), data = dta, family = gaussian(link="identity"), iter = 4000,seed=12345)
plot(brm_model)
summary(brm_model, digits = 4)

k<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
k<-rbind(k,bayes_R2(brm_model),summary(brm_model, digits = 4)$spec_par[1:4])

result2<-data.frame(round(k,3))  %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Estimate,  SE, `95% CI`)

results<-rbind(results,cbind(result1,result2)) 


set.seed(23456)
dta$Predicted<-1-exp(-exp(predict(brm_model)[,1]))
dta %>% 
    mutate(Observed=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Observed) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() + 
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",y="Density", fill="") 

ggplot(dta) + 
  geom_point(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1) +
  theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#de2d26","#fc9272"))  +
  labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
  theme(legend.position="bottom")
```


## OASIS

```{r,warning=FALSE}
dta <- Baseline_follow %>% 
    dplyr::select(aqol6d_total_w,OASIS,fkClientID,round,d_sex_birth_s,SOFAS) %>% 
    group_by(fkClientID) %>% 
    arrange(fkClientID,round) %>% 
    mutate(oasis_baseline=first(OASIS)/100) %>% 
    mutate(oasis_change=ifelse(round=="Baseline",0,(OASIS-lag(OASIS))/100))  %>% 
    mutate(sofas_baseline=first(SOFAS)/100) %>% 
    mutate(sofas_change=ifelse(round=="Baseline",0,(SOFAS-lag(SOFAS))/100))  %>% 
    mutate(aqol6d_total_w_cloglog= log(-log(1-ifelse(aqol6d_total_w==1,0.999,aqol6d_total_w)))) %>% 
    na.omit() 

```


### Gaussian with log link

```{r}

brm_model <- brm(formula = aqol6d_total_w ~ oasis_baseline + oasis_change  + sofas_baseline + sofas_change+ (1|fkClientID), data = dta, family = gaussian(link="log"), iter = 4000,seed=12345)
plot(brm_model)
summary(brm_model, digits = 4)

k<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
k<-rbind(k,bayes_R2(brm_model),summary(brm_model, digits = 4)$spec_par[1:4])


result1<-data.frame(round(k,3))  %>% 
    mutate(Parameter=c("OASIS baseline", "OASIS change", "OASIS baseline", "OASIS chage","R2", "Sigma"),
    Model="GAD7 model") %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Model,Parameter,Estimate,  SE, `95% CI`)

set.seed(23456)
dta$Predicted<-predict(brm_model)[,1]
dta %>% 
    mutate(Observed=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Observed) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() + 
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",y="Density", fill="") 

ggplot(dta) + 
  geom_point(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1) +
  theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#de2d26","#fc9272"))  +
  labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
  theme(legend.position="bottom")
```

### Cloglog transformed AQoL-6D scores

```{r}

brm_model <- brm(formula = aqol6d_total_w_cloglog ~ oasis_baseline + oasis_change  + sofas_baseline + sofas_change+ (1|fkClientID), data = dta, family = gaussian(link="identity"), iter = 4000,seed=12345)
plot(brm_model)
summary(brm_model, digits = 4)

k<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
k<-rbind(k,bayes_R2(brm_model),summary(brm_model, digits = 4)$spec_par[1:4])

result2<-data.frame(round(k,3))  %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Estimate,  SE, `95% CI`)

results<-rbind(results,cbind(result1,result2)) 


set.seed(23456)
dta$Predicted<-1-exp(-exp(predict(brm_model)[,1]))
dta %>% 
    mutate(Observed=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Observed) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() + 
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",y="Density", fill="") 

ggplot(dta) + 
  geom_point(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1) +
  theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#de2d26","#fc9272"))  +
  labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
  theme(legend.position="bottom")
```



## SCARED

```{r,warning=FALSE}
dta <- Baseline_follow %>% 
    dplyr::select(aqol6d_total_w,SCARED,fkClientID,round,d_sex_birth_s,SOFAS) %>% 
    group_by(fkClientID) %>% 
    arrange(fkClientID,round) %>% 
    mutate(scared_baseline=first(SCARED)/100) %>% 
    mutate(scared_change=ifelse(round=="Baseline",0,(SCARED-lag(SCARED))/100))  %>% 
    mutate(sofas_baseline=first(SOFAS)/100) %>% 
    mutate(sofas_change=ifelse(round=="Baseline",0,(SOFAS-lag(SOFAS))/100))  %>% 
    mutate(aqol6d_total_w_cloglog= log(-log(1-ifelse(aqol6d_total_w==1,0.999,aqol6d_total_w)))) %>% 
    na.omit() 

```

### Gaussian with log link

```{r}

brm_model <- brm(formula = aqol6d_total_w ~ scared_baseline + scared_change  + sofas_baseline + sofas_change+ (1|fkClientID), data = dta, family = gaussian(link="log"), iter = 4000,seed=12345)
plot(brm_model)
summary(brm_model, digits = 4)

k<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
k<-rbind(k,bayes_R2(brm_model),summary(brm_model, digits = 4)$spec_par[1:4])


result1<-data.frame(round(k,3))  %>% 
    mutate(Parameter=c("SCARED baseline", "SCARED change", "SOFAS baseline", "SOFAS chage","R2", "Sigma"),
    Model="SCARED model") %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Model,Parameter,Estimate,  SE, `95% CI`)

set.seed(23456)
dta$Predicted<-predict(brm_model)[,1]
dta %>% 
    mutate(Observed=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Observed) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() + 
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",y="Density", fill="") 

ggplot(dta) + 
  geom_point(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1) +
  theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#de2d26","#fc9272"))  +
  labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
  theme(legend.position="bottom")
```

### Cloglog transformed AQoL-6D scores

```{r}

brm_model <- brm(formula = aqol6d_total_w_cloglog ~ scared_baseline + scared_change  + sofas_baseline + sofas_change+ (1|fkClientID), data = dta, family = gaussian(link="identity"), iter = 4000,seed=12345)
plot(brm_model)
summary(brm_model, digits = 4)

k<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
k<-rbind(k,bayes_R2(brm_model),summary(brm_model, digits = 4)$spec_par[1:4])

result2<-data.frame(round(k,3))  %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Estimate,  SE, `95% CI`)

results<-rbind(results,cbind(result1,result2)) 


set.seed(23456)
dta$Predicted<-1-exp(-exp(predict(brm_model)[,1]))
dta %>% 
    mutate(Observed=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Observed) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() + 
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",y="Density", fill="") 

ggplot(dta) + 
  geom_point(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1) +
  theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#de2d26","#fc9272"))  +
  labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
  theme(legend.position="bottom")
```





## K6

```{r,warning=FALSE}
dta <- Baseline_follow %>% 
    dplyr::select(aqol6d_total_w,K6,fkClientID,round,d_sex_birth_s,SOFAS) %>% 
    group_by(fkClientID) %>% 
    arrange(fkClientID,round) %>% 
    mutate(k6_baseline=first(K6)/100) %>% 
    mutate(k6_change=ifelse(round=="Baseline",0,(K6-lag(K6))/100))  %>% 
    mutate(sofas_baseline=first(SOFAS)/100) %>% 
    mutate(sofas_change=ifelse(round=="Baseline",0,(SOFAS-lag(SOFAS))/100))  %>% 
    mutate(aqol6d_total_w_cloglog= log(-log(1-ifelse(aqol6d_total_w==1,0.999,aqol6d_total_w)))) %>% 
    na.omit() 

```



```{r}

brm_model <- brm(formula = aqol6d_total_w ~ k6_baseline + k6_change  + sofas_baseline + sofas_change+ (1|fkClientID), data = dta, family = gaussian(link="log"), iter = 4000,seed=12345)
plot(brm_model)
summary(brm_model, digits = 4)

k<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
k<-rbind(k,bayes_R2(brm_model),summary(brm_model, digits = 4)$spec_par[1:4])


result1<-data.frame(round(k,3))  %>% 
    mutate(Parameter=c("K6 baseline", "K6 change", "SOFAS baseline", "SOFAS chage","R2", "Sigma"),
    Model="K6 model") %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Model,Parameter,Estimate,  SE, `95% CI`)

set.seed(23456)
dta$Predicted<-predict(brm_model)[,1]
dta %>% 
    mutate(Observed=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Observed) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() + 
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",y="Density", fill="") 

ggplot(dta) + 
  geom_point(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1) +
  theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#de2d26","#fc9272"))  +
  labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
  theme(legend.position="bottom")
```

### Cloglog transformed AQoL-6D scores

```{r}

brm_model <- brm(formula = aqol6d_total_w_cloglog ~ k6_baseline + k6_change  + sofas_baseline + sofas_change+ (1|fkClientID), data = dta, family = gaussian(link="identity"), iter = 4000,seed=12345)
plot(brm_model)
summary(brm_model, digits = 4)

k<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
k<-rbind(k,bayes_R2(brm_model),summary(brm_model, digits = 4)$spec_par[1:4])

result2<-data.frame(round(k,3))  %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Estimate,  SE, `95% CI`)

results<-rbind(results,cbind(result1,result2)) 


set.seed(23456)
dta$Predicted<-1-exp(-exp(predict(brm_model)[,1]))
dta %>% 
    mutate(Observed=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Observed) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() + 
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",y="Density", fill="") 

ggplot(dta) + 
  geom_point(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1) +
  theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#de2d26","#fc9272"))  +
  labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
  theme(legend.position="bottom")
```


## Summary table 


```{r}
knitr::kable( results  , format="html") %>%
    kable_styling(bootstrap_options = "striped", full_width = F) %>% 
    add_header_above(c(" " = 2, "GLM (Gaussian distribution with log link)" = 3, "OLS (cloglog transformed utility score)" = 3))
```


