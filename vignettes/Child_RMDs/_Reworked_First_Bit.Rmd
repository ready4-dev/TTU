---
title: "AQol-6D analyses"
output:
  html_document: 
    code_folding: "hide"
    toc: yes 
  output: html_notebook
params:
  path_to_data_1L_chr: "../Data/fake_pop_tb.rds"
  path_to_write_fls_to_1L_chr: "../../../../../../../Data/Project/Utility_Models"
  dir_nm_1L_chr: "One_Predr_Output"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(xtable) # EDIT
library(FBaqol) # EDIT
library(magrittr)
```

```{r}
data_tb <- transform_raw_aqol_tb_to_aqol6d_tb(readRDS(params$path_to_data_1L_chr))
bl_tb <- data_tb %>% 
   dplyr::filter(round=="Baseline") %>% 
   dplyr::select(aqol6d_total_w, PHQ9, BADS, GAD7, OASIS, SCARED, K6) %>% 
  dplyr::mutate(aqol6d_total_w = ifelse(aqol6d_total_w == 1, 0.999, aqol6d_total_w)) %>% 
  dplyr::mutate(aqol6d_total_w_log = log(aqol6d_total_w),
         aqol6d_total_w_logit = psych::logit(aqol6d_total_w),
         aqol6d_total_w_loglog = -log(-log(aqol6d_total_w)),
         aqol6d_total_w_cloglog = log(-log(1-aqol6d_total_w))) %>% 
  dplyr::filter(!is.na(PHQ9)) 
#folds_10 <- createFolds(baseline$aqol6d_total_w , k = 10, list = TRUE, returnTrain = FALSE)
```

```{r}
set.seed(12345)
```

# Regression testing 

## Boxcox transformation 

```{r}
library(MASS)
initech_fit = lm(aqol6d_total_w ~ PHQ9, data = bl_tb)
bc<-boxcox(initech_fit, plotit = TRUE)
bc$x[which.max(bc$y)]
```

```{r}
make_one_predr_mdl <- function(data_tb,
                               dep_var_nm_1L_chr = "aqol6d_total_w",
                               tfmn_1L_chr = "NTF",
                               predr_var_nm_1L_chr,
                               mdl_type_1L_chr = "OLS_NTF",
                               mdl_types_lup = NULL){
    if(is.null(mdl_types_lup))
      mdl_types_lup <- data("mdl_types_lup", package = "FBaqol", envir = environment())
  mdl_1L_chr <- paste0(ready4fun::get_from_lup_obj(mdl_types_lup,
                                                   match_var_nm_1L_chr = "short_name_chr",
                                                   match_value_xx = mdl_type_1L_chr,
                                                   target_var_nm_1L_chr = "fn_chr",
                                                   evaluate_lgl = F),
                       "(",
                       transform_dep_var_nm(dep_var_nm_1L_chr, tfmn_1L_chr = tfmn_1L_chr),
                       " ~ ",
                       predr_var_nm_1L_chr, 
                       ", data = data_tb",
                       ifelse(!is.na(ready4fun::get_from_lup_obj(mdl_types_lup,
                                                   match_var_nm_1L_chr = "short_name_chr",
                                                   match_value_xx = mdl_type_1L_chr,
                                                   target_var_nm_1L_chr = "family_chr",
                                                   evaluate_lgl = F)),
                              paste0(", family = ", 
                                     ready4fun::get_from_lup_obj(mdl_types_lup,
                                                   match_var_nm_1L_chr = "short_name_chr",
                                                   match_value_xx = mdl_type_1L_chr,
                                                   target_var_nm_1L_chr = "family_chr",
                                                   evaluate_lgl = F)),#", ADD ME",
                              ""),
                       ifelse(!is.na(ready4fun::get_from_lup_obj(mdl_types_lup,
                                                   match_var_nm_1L_chr = "short_name_chr",
                                                   match_value_xx = mdl_type_1L_chr,
                                                   target_var_nm_1L_chr = "start_chr",
                                                   evaluate_lgl = F)),
                              paste0(", start=c(",
                                     ready4fun::get_from_lup_obj(mdl_types_lup,
                                                   match_var_nm_1L_chr = "short_name_chr",
                                                   match_value_xx = mdl_type_1L_chr,
                                                   target_var_nm_1L_chr = "start_chr",
                                                   evaluate_lgl = F),
                                     ")"),#", AND ME",
                              ""),
                       ")")
  mdl <- eval(parse(text = mdl_1L_chr))
  return(mdl)
}
make_predn_ds_with_one_predr <- function(mdl,
                                         dep_var_nm_1L_chr = "aqol6d_total_w",
                                         tfmn_1L_chr = "NTF",
                                         predr_var_nm_1L_chr,
                                         predr_vals_dbl){
  predn_ds_tb <- tibble::tibble(!!rlang::sym(predr_var_nm_1L_chr) := predr_vals_dbl)
  predn_ds_tb <- predn_ds_tb %>% dplyr::mutate(!!rlang::sym(dep_var_nm_1L_chr) := predict(mdl, newdata = predn_ds_tb) %>% calculate_dep_var_tfmn(tfmn_1L_chr = tfmn_1L_chr, tfmn_is_outp_1L_lgl = T))
  return(predn_ds_tb)
}
make_smry_of_one_predr_mdl <- function(data_tb,
                                       mdl,
                                       folds_ls,
                                       dep_var_nm_1L_chr = "aqol6d_total_w",
                                       tfmn_1L_chr = "NTF",
                                       predr_var_nm_1L_chr,
                                       mdl_type_1L_chr = "OLS_NTF",
                                       mdl_types_lup = NULL){
    if(is.null(mdl_types_lup))
      mdl_types_lup <- data("mdl_types_lup", package = "FBaqol", envir = environment())
    mdl_desc_1L_chr <- ready4fun::get_from_lup_obj(mdl_types_lup,
                                                   match_var_nm_1L_chr = "short_name_chr",
                                                   match_value_xx = mdl_type_1L_chr,
                                                   target_var_nm_1L_chr = "long_name_chr",
                                                   evaluate_lgl = F)
        pred_type_1L_chr <- ready4fun::get_from_lup_obj(mdl_types_lup,
                                                   match_var_nm_1L_chr = "short_name_chr",
                                                   match_value_xx = mdl_type_1L_chr,
                                                   target_var_nm_1L_chr = "pred_type_chr",
                                                   evaluate_lgl = F)
        if(is.na(pred_type_1L_chr))
          pred_type_1L_chr <- NULL
smry_of_one_predr_mdl_tb <- purrr::map_dfr(folds_ls,
               ~ {
                   mdl <- make_one_predr_mdl(data_tb,
                               dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                               tfmn_1L_chr = tfmn_1L_chr,
                               predr_var_nm_1L_chr = predr_var_nm_1L_chr,
                               mdl_type_1L_chr = mdl_type_1L_chr,
                               mdl_types_lup = mdl_types_lup) 
  pred_old_dbl <- predict(mdl, type = pred_type_1L_chr)
  pred_new_dbl <- predict(mdl,newdata=data_tb[.x,], type = pred_type_1L_chr) %>% calculate_dep_var_tfmn(tfmn_1L_chr = tfmn_1L_chr,
                                                                               tfmn_is_outp_1L_lgl = T)
  tibble::tibble(Rsquared = caret::R2(pred_old_dbl, data_tb[-.x,] %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr)), form = "traditional"),
  RMSE = caret::RMSE(pred_old_dbl, data_tb[-.x,] %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr))),
  MAE = caret::MAE(pred_old_dbl, data_tb[-.x,] %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr))),
  RsquaredP = caret::R2(pred_new_dbl, data_tb[.x,] %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr)), form = "traditional"),
  RMSEP = caret::RMSE(pred_new_dbl, data_tb[.x,] %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr))),
  MAEP = caret::MAE(pred_new_dbl, data_tb[.x,] %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr))))
               }
) %>% dplyr::summarise_all(mean) %>%
    dplyr::mutate(Model = mdl_desc_1L_chr) %>%
    dplyr::select(Model, dplyr::everything())
return(smry_of_one_predr_mdl_tb)
}
plot_auto_lm <- function(mdl, # Requires ggfortify
                         which_dbl = 1:6, 
                         ncol_1L_int = 3L, 
                         label_size_1L_int = 3){
 plt <- ggplot2::autoplot(mdl,which = which_dbl, ncol = ncol_1L_int, label.size = label_size_1L_int)
if(6 %in% which_dbl)
  plt[which(which_dbl==6)] <- plt[which(which_dbl==6)] + ggtitle("Cooks vs Leverage") 
plt
}
plot_lnr_cmprsn <- function(data_tb,
                      predn_ds_tb,
                      dep_var_nm_1L_chr = "aqol6d_total_w",
                      predr_var_nm_1L_chr,
                      dep_var_desc_1L_chr = "AQoL-6D utility score",
                      predr_var_desc_1L_chr){
  ggplot2::ggplot(data_tb,ggplot2::aes(x = !!rlang::sym(predr_var_nm_1L_chr), y = !!rlang::sym(dep_var_nm_1L_chr) )) +
  ggplot2::geom_point() + 
  ggplot2::geom_smooth(method = "loess", size = 1.5) +
  ggplot2::geom_line(data = predn_ds_tb, ggplot2::aes(x = !!rlang::sym(predr_var_nm_1L_chr), y = !!rlang::sym(dep_var_nm_1L_chr)),col="red")  +
  ggplot2::theme_bw() + ggplot2::labs(x= predr_var_desc_1L_chr, y= dep_var_desc_1L_chr)
}
plot_sctr_lnr_cmprsn <- function(tfd_data_tb,
                                 dep_var_nm_1L_chr = "aqol6d_total_w",
                                 predd_val_var_nm_1L_chr = "Predicted"){
  tfd_data_tb %>%
    ggplot2::ggplot(ggplot2::aes(x = !!rlang::sym(dep_var_nm_1L_chr),
                             y = !!rlang::sym(predd_val_var_nm_1L_chr))) +
  ggplot2::geom_point() + 
  ggplot2::geom_smooth(method = "loess", size = 1.5) +
  ggplot2::theme_bw() +
  ggplot2::geom_abline(intercept = 0, slope = 1, color="red", 
                       linetype="dashed", size=1.5) +
  ggplot2::xlim(0, 1) + ggplot2::ylim(0, 1)
}
transform_data_tb_for_cmprsn <- function(data_tb,
                                         mdl,
                                         dep_var_nm_1L_chr = "aqol6d_total_w",
                                         source_data_nm_1L_chr = "Original",
                                         tf_type_1L_chr = "Predicted"){
  if(tf_type_1L_chr == "Predicted")
    new_data_dbl <- predict(mdl)
  if(tf_type_1L_chr == "Simulated")
    new_data_dbl <- simulate(mdl)$sim_1
  tfd_data_tb <- data_tb %>% 
    dplyr::mutate(!!rlang::sym(tf_type_1L_chr) := new_data_dbl,
         !!rlang::sym(source_data_nm_1L_chr) := !!rlang::sym(dep_var_nm_1L_chr))
  return(tfd_data_tb)
}
library(ggfortify)
write_one_predr_mdl_plts <- function(data_tb, # MUST IMPORT ggfortify
                                     mdl,
                                     mdl_type_1L_chr = "OLS_NTF",
                                     dep_var_nm_1L_chr = "aqol6d_total_w",
                                     tfmn_1L_chr = "NTF",
                                     predr_var_nm_1L_chr,
                                     predr_var_desc_1L_chr,
                                     predr_vals_dbl,
                                     path_to_write_to_1L_chr){
  tfd_data_tb <- transform_data_tb_for_cmprsn(data_tb, mdl = mdl) 
  predn_ds_tb <- make_predn_ds_with_one_predr(mdl, 
                                              dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                                              tfmn_1L_chr = tfmn_1L_chr,
                                              predr_var_nm_1L_chr = predr_var_nm_1L_chr, predr_vals_dbl = predr_vals_dbl)
  purrr::pwalk(list(plt_fn_ls = list(plot_lnr_cmprsn, plot_auto_lm, plot_obsd_predd_dnst, plot_obsd_predd_dnst, plot_sctr_lnr_cmprsn),
                 fn_args_ls_ls = list(list(data_tb = data_tb,
                                        predn_ds_tb = predn_ds_tb,
                                        predr_var_nm_1L_chr = predr_var_nm_1L_chr,
                                        predr_var_desc_1L_chr = predr_var_desc_1L_chr),
                                      list(mdl,
                                           which_dbl = 1:6, 
                                           ncol_1L_int = 3L,
                                           label_size_1L_int = 3),
                                      list(tfd_data_tb = tfd_data_tb),
                                      list(tfd_data_tb = transform_data_tb_for_cmprsn(data_tb, 
                                                                                      mdl = mdl,
                                                                                      tf_type_1L_chr = "Simulated"),
                                           predd_val_var_nm_1L_chr = "Simulated"),
                                      list(tfd_data_tb = tfd_data_tb)),
                 plt_nm_sfx_chr = c("_lnr_cmprsn","_auto_plt","_pred_dnsty","_simd_dnsty","_pred_sctr"),
                 size_ls = list(c(6,6),c(4,7),c(6,6),c(6,6),c(6,6))), 
            ~ write_brm_mdl_plt_fl(plt_fn = ..1,
                     fn_args_ls = ..2,
                     path_to_write_to_1L_chr = path_to_write_to_1L_chr,
                     plt_nm_1L_chr = paste0(mdl_type_1L_chr,
                                            ..3),
                     height_1L_dbl = ..4[1],
                     width_1L_dbl = ..4[2]))
  
}
write_one_predr_mdl_outp <- function(data_tb,
                                     dep_var_nm_1L_chr = "aqol6d_total_w",
                                     tfmn_1L_chr = "NTF",
                                     predr_var_nm_1L_chr, 
                                     predr_var_desc_1L_chr,
                                     predr_vals_dbl,
                                     mdl_type_1L_chr = "OLS_NTF",
                                     mdl_types_lup = NULL,
                                     path_to_write_to_1L_chr,
                                     mdl_fl_nm_1L_chr){
  if(is.null(mdl_types_lup))
    mdl_types_lup <- data("mdl_types_lup", package = "FBaqol", envir = environment())
  data_tb <- data_tb %>% dplyr::mutate(!!rlang::sym(transform_dep_var_nm(dep_var_nm_1L_chr,
                                                                         tfmn_1L_chr = tfmn_1L_chr)) := !!rlang::sym(dep_var_nm_1L_chr) %>% calculate_dep_var_tfmn())
  mdl <- make_one_predr_mdl(data_tb,
                            dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                            tfmn_1L_chr = tfmn_1L_chr,
                            predr_var_nm_1L_chr = predr_var_nm_1L_chr, 
                            mdl_type_1L_chr = mdl_type_1L_chr,
                            mdl_types_lup = mdl_types_lup)
  write_one_predr_mdl_plts(data_tb,
                         mdl = mdl,
                         mdl_type_1L_chr = mdl_fl_nm_1L_chr,
                         dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                         tfmn_1L_chr = tfmn_1L_chr,
                         predr_var_nm_1L_chr = predr_var_nm_1L_chr,
                         predr_var_desc_1L_chr = predr_var_desc_1L_chr,
                         predr_vals_dbl = predr_vals_dbl,
                         path_to_write_to_1L_chr = path_to_write_to_1L_chr)
smry_of_one_predr_mdl_tb <- make_smry_of_one_predr_mdl(data_tb,
                           mdl = mdl,
                           folds_ls = folds_ls,
                           dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                           tfmn_1L_chr = tfmn_1L_chr,
                           predr_var_nm_1L_chr = predr_var_nm_1L_chr,
                           mdl_type_1L_chr = mdl_type_1L_chr,
                           mdl_types_lup = mdl_types_lup)
saveRDS(mdl,paste0(path_to_write_to_1L_chr,"/",mdl_fl_nm_1L_chr,".RDS"))
return(smry_of_one_predr_mdl_tb)
}
mdl_types_lup <- dplyr::bind_rows(FBaqol::mdl_types_lup,
  tibble::tibble(short_name_chr = c("OLS_NTF",
                                     "OLS_LOG",
                                     "OLS_LOGIT",
                                     "OLS_LOGLOG",
                                     "OLS_CLL",
                                    "GLM_GSN_LOG",
                                    "GLM_BNL_LOG",
                                    "GLM_BNL_LGT",
                                    "GLM_BNL_CLL",
                                    "BET_LOG",
                                    "BET_LGT",
                                    "BET_CLL"),
               long_name_chr = c("Ordinary Least Squares (No transformation)",
                                    "Ordinary Least Squares (Log transformation)",
                                    "Ordinary Least Squares (Logit transformation)",
                                    "Ordinary Least Squares (Log Log transformation)",
                                    "Ordinary Least Squares (Complementary Log Log transformation)",
                                 "Generalised Linear Mixed Model with Gaussian distribution and log link",
                                 "Generalised Linear Mixed Model with Binomial distribution and log link",
                                 "Generalised Linear Mixed Model with Binomial distribution and logit link",
                                 "Generalised Linear Mixed Model with Binomial distribution and complementary log log link", 
                                 "Beta Regression Model with Binomial distribution and log link",
                                 "Beta Regression Model with Binomial distribution and logit link",
                                 "Beta Regression Model with Binomial distribution and complementary log log link"))) %>%
  dplyr::mutate(control_chr = c(rep(NA_character_,11),rep("betareg.control",3)),
                family_chr = c(rep(NA_character_,7),"gaussian(log)","quasibinomial(log)","quasibinomial(logit)","quasibinomial(cloglog)", rep(NA_character_,3)),
                fn_chr = c(NA_character_,rep("lm",6),rep("glm",4),rep("betareg::betareg",3)),
                start_chr = c(rep(NA_character_,7),
                              rep("-0.1,-0.1",4),
                              rep("-0.5,-0.1,3",3)),
                
                pred_type_chr = c(rep(NA_character_,7),
                                 rep("response",7)),
                tfmn_chr = dplyr::case_when(startsWith(short_name_chr, "OLS_") ~ purrr::map_chr(short_name_chr, ~ {
                  idx_1L_int <- 1 + stringi::stri_locate_last_fixed(.x,"_")[1,1] %>% as.vector()
                  stringr::str_sub(.x, start = idx_1L_int)
                  }),
                                            T ~ "NTF"),
                tfmn_for_bnml_lgl = c(rep(F,8),rep(T,3),rep(F,3)))
```

```{r}
folds_ls <- caret::createFolds(bl_tb$aqol6d_total_w , k = 10, list = TRUE, returnTrain = FALSE)
path_to_write_fls_to_1L_chr <- params$path_to_write_fls_to_1L_chr
dir_nm_1L_chr <- params$dir_nm_1L_chr
path_to_write_to_1L_chr <- paste0(path_to_write_fls_to_1L_chr,
                                                      "/",
                                                      dir_nm_1L_chr)
predr_var_nm_1L_chr <- "PHQ9"
```


```{r}
mdl_types_chr <- c("OLS_NTF","OLS_LOG", "OLS_LOGIT", "OLS_LOGLOG", "OLS_CLL")
predr_var_desc_1L_chr <- "PHQ9 total score"
predr_vals_dbl <- 0:27
purrr::map_dfr(mdl_types_chr,
               ~ {
                 tfmn_1L_chr <- ready4fun::get_from_lup_obj(mdl_types_lup, 
                                             match_var_nm_1L_chr = "short_name_chr",
                                             match_value_xx = .x,
                                             target_var_nm_1L_chr = "tfmn_chr",
                                             evaluate_lgl = F)
                 write_one_predr_mdl_outp(bl_tb,
                         tfmn_1L_chr = tfmn_1L_chr,
                         predr_var_nm_1L_chr = predr_var_nm_1L_chr, 
                         predr_var_desc_1L_chr = predr_var_desc_1L_chr,
                         predr_vals_dbl = predr_vals_dbl,
                         mdl_type_1L_chr = .x,
                         path_to_write_to_1L_chr = path_to_write_to_1L_chr,
                         mdl_types_lup = mdl_types_lup,
                         mdl_fl_nm_1L_chr = paste0(predr_var_nm_1L_chr,
                                                   "_",
                                                   .x,
                                                   "_MDL"
                                                   ))
               })
```


## Linear model (no transformation)

## Linear model (log transformation)

## Linear model (logit transformation)

## Linear model (log-log transformation)

## Linear model (clog-log transformation)


```{r}
mdl_types_chr <- c("GLM_GSN_LOG")
predr_var_desc_1L_chr <- "PHQ9 total score"
predr_vals_dbl <- 0:27
.x <- mdl_types_chr[1]
purrr::map_dfr(mdl_types_chr,
               ~ {
                 tfmn_1L_chr <- ready4fun::get_from_lup_obj(mdl_types_lup, 
                                             match_var_nm_1L_chr = "short_name_chr",
                                             match_value_xx = .x,
                                             target_var_nm_1L_chr = "tfmn_chr",
                                             evaluate_lgl = F)
                 write_one_predr_mdl_outp(bl_tb,
                         tfmn_1L_chr = tfmn_1L_chr,
                         predr_var_nm_1L_chr = predr_var_nm_1L_chr, 
                         predr_var_desc_1L_chr = predr_var_desc_1L_chr,
                         predr_vals_dbl = predr_vals_dbl,
                         mdl_type_1L_chr = .x,
                         path_to_write_to_1L_chr = path_to_write_to_1L_chr,
                         mdl_types_lup = mdl_types_lup,
                         mdl_fl_nm_1L_chr = paste0(predr_var_nm_1L_chr,
                                                   "_",
                                                   .x,
                                                   "_MDL"
                                                   ))
               })
```

## GLM (Gausian with log link)

```{r}
library(ggfortify)
fit = glm(aqol6d_total_w ~ PHQ9, data = baseline,family=gaussian(log), start=c(-0.1,-0.1)) ##
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response") ##
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)

baseline %>% 
    mutate(Predicted=predict(fit,type="response"), ##
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 


 
baseline %>% 
    mutate(Simulated=simulate(fit)$sim_1, ###################### 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 



baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  ##
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = glm(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],],family=gaussian(log), start=c(-0.1,-0.1)) ######################
  pred<-predict(fit,type="response") ##################
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="GLM (Gausian with log link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

``` 



## GLM (Binomial with log link)

```{r}
library(ggfortify)
fit = glm( aqol6d_total_w  ~ PHQ9, data = baseline,family=quasibinomial(log),start=c(-0.1,-0.1))
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response")
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)

baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

 
baseline %>% 
    mutate(Simulated=exp(predict(fit)+rnorm(n(),0,sigma(fit))),  ##################
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 


baseline %>% 
     mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = glm(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],],family=quasibinomial(log),start=c(-0.1,-0.1))
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="GLM (Binomial with log link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)


``` 


## GLM (Binomial with logit link)

```{r}
library(ggfortify)
fit = glm( aqol6d_total_w  ~ PHQ9, data = baseline,family=quasibinomial(logit),start=c(-0.1,-0.1))
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response")
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)

baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

 
baseline %>% 
    mutate(Simulated=inv.logit(predict(fit)+rnorm(n(),0,sigma(fit))),  ##########
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 


baseline %>% 
     mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = glm(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],],family=quasibinomial(logit),start=c(-0.1,-0.1))
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="GLM (Binomial logit link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)


``` 




## GLM (Binomial with cloglog link)

```{r}
library(ggfortify)
fit = glm( aqol6d_total_w  ~ PHQ9, data = baseline,family=quasibinomial(cloglog),start=c(-0.1,-0.1))
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response")
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)

 
baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="")   


 
baseline %>% 
    mutate(Simulated=1-exp(-exp(predict(fit)+rnorm(n(),0,sigma(fit)))), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="")   


baseline %>% 
     mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = glm(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],],family=quasibinomial(cloglog),start=c(-0.1,-0.1))
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="GLM (Binomial with cloglog link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

``` 


## Beta regression log link

```{r}
library(betareg) 

fit = betareg( aqol6d_total_w  ~ PHQ9, data = baseline, link="log",control=betareg.control(start=c(-0.5,-0.1,3)))
summary(fit)  

newdata<-data.frame(PHQ9=0:27) 
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response") 
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score") 

 
baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="")  



baseline %>% 
     mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = betareg(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],], link="log",control=betareg.control(start=c(-0.5,-0.1,3)))
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="Beta regression (log link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

``` 


## Beta regression logit link

```{r}
library(betareg)
fit = betareg( aqol6d_total_w  ~ PHQ9, data = baseline, link="logit",control=betareg.control(start=c(-0.5,-0.1,3)))
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response")
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

 
baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 



baseline %>% 
     mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = betareg(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],], link="logit",control=betareg.control(start=c(-0.5,-0.1,3)))
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="Beta regression (logit link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

``` 


## Beta regression cloglog link

```{r}
library(betareg)
fit = betareg( aqol6d_total_w  ~ PHQ9, data = baseline, link="cloglog",control=betareg.control(start=c(-0.5,-0.1,3))) ###############
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response")
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")
 
baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 


baseline %>% 
     mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = betareg(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],], link="cloglog",control=betareg.control(start=c(-0.5,-0.1,3)))
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="Beta regression (cloglog link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

``` 

## Summary of model fit

```{r} 
knitr::kable( summary_table  , format="html",digits = 3) %>%
    kable_styling(bootstrap_options = "striped", full_width = F) 
```



# Predictor selection 

## Random forest 

```{r, fig.height=8, fig.width=10}
library(randomForest)
library(Boruta)
baseline

baseline<- Baseline_follow %>% 
   filter(round=="Baseline") %>% 
   dplyr::select( aqol6d_total_w, PHQ9 ,  BADS, GAD7 ,OASIS,  SCARED, K6)  %>% 
   na.omit()

names(baseline)<-c("aqol6d_total_w", "PHQ9", "BADS", "GAD7","OASIS","SCARED","K6" )

folds_10 <- createFolds(baseline$aqol6d_total_w , k = 10, list = TRUE, returnTrain = FALSE)

## Random Forest
RF<-randomForest(aqol6d_total_w~.,data=baseline,importance=TRUE)
varImpPlot(RF)


## Boruta 
boruta.model <- Boruta(aqol6d_total_w~., data = baseline , maxRuns = 300)
# plot variable importance 
op <- par(mar = c(10,4,4,3) + 0.1)
plot(boruta.model,cex=1.5, cex.axis=1, las=2, xlab="", main="Variable Importance")
```

## Individual predictor

```{r}
predictors<-c("PHQ9", "BADS", "GAD7","OASIS","SCARED","K6" )

summary_table<-data.frame("Model"=NA,"Rsquare"=NA,"RMSE"=NA, "MAE"=NA, "Rsquare.prediction"=NA, "RMSE prediction"=NA,"MAE prediction"=NA)

n=1 
for(predictor in predictors){  
  Rsquared<-NA 
  RMSE<-NA 
  MAE<-NA 
  RsquaredP<-NA 
  RMSEP<-NA 
  MAEP<-NA 
  for (i in 1:10) {
    fit = glm(as.formula(paste0("aqol6d_total_w~", predictor )), data = baseline[-folds_10[[i]],], family=gaussian(log)) 
    pred<-predict(fit,type="response")
    Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
    RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
    MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
    pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
    RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
    RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
    MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


#save model fit
summary_table[n,1]=predictor 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)
n=n+1
}

knitr::kable( summary_table  , format="html",digits = 3) %>%
    kable_styling(bootstrap_options = "striped", full_width = F) 
```

## Additional confounding variables

```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w, K6 ,PHQ9 ,  BADS, GAD7 ,OASIS,  SCARED,
          d_sex_birth_s , SOFAS ,c_p_diag_s , c_clinical_staging_s ,  d_age , d_sexual_ori_s ,
          d_country_bir_s,  d_relation_s , d_studying_working) %>% 
   na.omit()


predictor<-c("PHQ9", "BADS", "K6","OASIS","SCARED","GAD7" )

summarytable<-data.frame("variable"=character(),"data"=character(),"Rsquared"=double(),
                            "AIC"=double(),BIC=double(),"Significant"=character())

for(i in predictor){  
  model<-glm(as.formula(paste0("aqol6d_total_w~", i , "+d_sex_birth_s + SOFAS +c_p_diag_s + c_clinical_staging_s +  d_age + d_sexual_ori_s + d_country_bir_s + d_relation_s + d_studying_working")), data=baseline, family=gaussian(log)) 
  print(summary(model))
  summarytable=rbind(summarytable,data.frame("variable"=i,
                     Rsuqare=R2(baseline$aqol6d_total_w, predict(model), form = "traditional"),
                     AIC=AIC(model), BIC=BIC(model),
                     "Significant"=paste(names(which(summary(model)$coefficients[,4]<0.01)),collapse = " "))) 
} 



knitr::kable( summarytable  , format="html",digits = 3) %>%
    kable_styling(bootstrap_options = "striped", full_width = F) 
```

## Checking 

### PHQ9 
```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w ,PHQ9, SOFAS) %>% 
   na.omit()

fit = glm(aqol6d_total_w ~ PHQ9 + SOFAS  , data = baseline,family=gaussian(log))

summary(fit)
baseline %>% 
    mutate(Predicted=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 


```


### BADS 
```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w ,BADS, SOFAS) %>% 
   na.omit()

fit = glm(aqol6d_total_w ~ BADS + SOFAS  , data = baseline,family=gaussian(log))

summary(fit)
baseline %>% 
    mutate(Predicted=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 


```



### GAD7 
```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w ,GAD7, SOFAS) %>% 
   na.omit()

fit = glm(aqol6d_total_w ~ GAD7 + SOFAS  , data = baseline,family=gaussian(log))

summary(fit)
baseline %>% 
    mutate(Predicted=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 


```


### OASIS  
```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w ,OASIS, SOFAS) %>% 
   na.omit()

fit = glm(aqol6d_total_w ~ OASIS + SOFAS  , data = baseline,family=gaussian(log))

summary(fit)
baseline %>% 
    mutate(Predicted=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 


```



### SCARED 
```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w ,SCARED, SOFAS) %>% 
   na.omit()

fit = glm(aqol6d_total_w ~ SCARED + SOFAS  , data = baseline,family=gaussian(log))

summary(fit)
baseline %>% 
    mutate(Predicted=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 


```



### K6 
```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w ,K6, SOFAS) %>% 
   na.omit()

fit = glm(aqol6d_total_w ~ K6 + SOFAS  , data = baseline,family=gaussian(log))

summary(fit)
baseline %>% 
    mutate(Predicted=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 


```
