---
title: "TEST"
author: "Matthew Hamilton"
date: "06/08/2020"
output:
  officedown::rdocx_document:
    number_sections: yes
  pdf_document:
    number_sections: yes
    includes:  
      in_header: preamble.tex
  bookdown::html_document2:
    number_sections: yes
  html_document:
    df_print: paged
  bookdown::pdf_book:
    number_sections: yes
    includes:  
      in_header: preamble.tex
params:
  output_type_1L_chr: "Word"
graphics: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(comment=NA)
library(flextable)
library(xtable) # EDIT
library(FBaqol) # EDIT
library(magrittr)
options(tinytex.verbose = TRUE)
options(xtable.floating = FALSE)
options(xtable.timestamp = "")
```

```{r echo = FALSE}
make_brms_mdl_smry_tbl <- function(smry_mdl_ls,
                                   grp_1L_chr,
                                   pop_1L_chr,
                                   fam_1L_chr){
 brms_mdl_smry_tb <- purrr::map(1:length(smry_mdl_ls$random), 
           ~ make_mdl_smry_elmt_tbl(cat_chr = c(ifelse(.x==1,grp_1L_chr,character(0)),paste0(names(smry_mdl_ls$ngrps)[.x], 
                         " (Number of levels: ",smry_mdl_ls$ngrps[.x][[1]],")")),
                  mat = smry_mdl_ls$random[.x][[1]])) %>%
  dplyr::bind_rows(make_mdl_smry_elmt_tbl(mat = smry_mdl_ls$fixed, cat_chr = pop_1L_chr),
                   make_mdl_smry_elmt_tbl(mat = smry_mdl_ls$spec_pars, cat_chr = fam_1L_chr))
 return(brms_mdl_smry_tb)
                                   }
make_mdl_smry_elmt_tbl <- function(mat,
                              cat_chr){
  tb <- mat %>% tibble::as_tibble() %>% dplyr::mutate(Parameter = rownames(mat)) %>% dplyr::select(Parameter, dplyr::everything())

mdl_elmt_sum_tb <- tb %>% dplyr::filter(F) %>% tibble::add_case(Parameter = cat_chr) %>%
  dplyr::bind_rows(tb)
return(mdl_elmt_sum_tb)
}
print_ts_mdl_plts <- function(paths_to_plts_chr,
                              title_1L_chr,
                              label_refs_chr,
                              mdl_smry_ls){
    cat('\n')
  cat("## ", title_1L_chr, "\n")
  cat('\n')
  purrr::pwalk(list(paths_to_plts_chr,
              paste0(#"\\label{fig:fig",label_refs_chr,"}",
                     "Caption",1:length(paths_to_plts_chr)),
              label_refs_chr),
    ~ {
      cat(paste0('\n![',
                 #.y,
                 '](',
                 ..1,
                 ')\n\n'))
      cat(fig_nums(..3, ..2))
    cat('\n\n')
    })
 cat('\n\n')
}
print_all_plts_for_mdl_set <- function(output_ls,
                                       start_from_1L_int = 0L){
  label_refs_mat <- paste0("lab",1:(output_ls %>% purrr::flatten() %>% length())+start_from_1L_int) %>% matrix(nrow = length(output_ls), byrow=T)
purrr::walk(1:length(output_ls),
            ~ print_ts_mdl_plts(output_ls[[.x]], 
                                title_1L_chr = names(output_ls)[.x],
                                label_refs_chr = label_refs_mat[.x,]))
}
print_table_xx <- function(data_tb,
                           output_type_1L_chr = "PDF",
                           caption_1L_chr = NA_character_,
                           footnotes_chr = NA_character_,
                           label,
                           hline.after,
                           addtorow,
                           sanitize_fn = getOption("xtable.sanitize.text.function", NULL)){
   data_x_tb <- data_tb %>%
  xtable::xtable(caption = caption_1L_chr, label = label)
if(output_type_1L_chr == "PDF"){
 data_x_tb %>%
  print(comment = F,
        floating = TRUE, #floating.environment = "sidewaystable",
        hline.after = hline.after,
        caption.placement = "top",
        add.to.row = addtorow, 
        sanitize.text.function = sanitize_fn,
        include.colnames = FALSE,
        include.rownames = FALSE#,scalebox = 0.75
        ) 
}else{
  if(output_type_1L_chr == "HTML"){
  data_tb <- data_tb %>%
    kableExtra::kable(escape = F,
        caption = caption_1L_chr) %>%
      kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
                                full_width = F, 
                                position = "left") %>%
      kableExtra::footnote(general = "TEST 1",
                           general_title = "TEST 2",
                           footnote_as_chunk = T,
                           title_format = c("italic","underline"),
                           threeparttable = T)
  print(data_tb)
  }
    if(output_type_1L_chr == "Word"){
    data_tb <- flextable::flextable(data_tb,
                                   cwidth = 1.25) %>%
      flextable::set_caption(caption_1L_chr)
    if(!all(is.na(footnotes_chr))){
      data_tb <- data_tb %>%
        flextable::add_footer_lines(values = footnotes_chr)
    }
    data_tb
    # cat("  \n")
    # cat(
    #   paste(
    #     "\n```{=openxml}", 
    #     format(data_tb, type = "docx"), 
    #     "```\n", sep = "\n")
    # )
    # cat("  \n")
  }
}
}
make_brms_mdl_print_ls <- function(mdl_ls,
                               label_stub_1L_chr,
                               caption_1L_chr,
                               footnote_1L_chr = "",
                               output_type_1L_chr = "PDF"){
    smry_mdl_ls <- summary(mdl_ls, digits = 4)
  mdl_smry_chr <- smry_mdl_ls %>% capture.output() 
  idx_dbl <- c("Formula: ",
             "Samples: ", 
             "Group-Level Effects: ", 
             "Population-Level Effects: ", 
             "Family Specific Parameters: ",
             "Samples were drawn using ") %>% purrr::map_dbl(~mdl_smry_chr %>% startsWith(.x) %>% which())
  data_tb <- make_brms_mdl_smry_tbl(smry_mdl_ls,
                       grp_1L_chr = mdl_smry_chr[idx_dbl[3]],
                       pop_1L_chr = mdl_smry_chr[idx_dbl[4]],
                       fam_1L_chr = mdl_smry_chr[idx_dbl[5]])
  add_to_row_ls <- list(pos = list(0, nrow(data_tb)),
                 command = c(names(data_tb) %>% 
                               stringr::str_replace_all("[[:punct:]]", " ") %>% 
                               paste0(collapse=" & ") %>% paste0("\\\\\n"),
                      paste0("\\hline\n","{\\footnotesize ",
                             footnote_1L_chr,
                             "}\n")))
bold_lgl <- data_tb$Parameter %in% c(mdl_smry_chr[idx_dbl[3]],mdl_smry_chr[idx_dbl[4]],mdl_smry_chr[idx_dbl[5]])
data_tb <- data_tb %>% dplyr::mutate(Parameter = purrr::map_chr(Parameter,
                                                                ~ .x %>%
                                                                  stringr::str_replace_all("[[:punct:]]", " ")))
data_tb <- data_tb %>% dplyr::mutate(Parameter = Parameter %>%
                                       purrr::map2_chr(dplyr::all_of(bold_lgl),
                                                       ~ifelse(.y & output_type_1L_chr =="PDF",
                                                               paste0("\\textbf{",.x,"}"),
                                                               .x))) %>%
  dplyr::mutate(dplyr::across(c(Bulk_ESS, Tail_ESS),as.character))

# brms_mdl_print_ls <- list(mdl_smry_chr = mdl_smry_chr,
#                           idx_dbl = idx_dbl,
#                           data_tb = data_tb,
#                           output_type_1L_chr = output_type_1L_chr,
#                caption_1L_chr = caption_1L_chr,
#                label_stub_1L_chr = label_stub_1L_chr,
#               add_to_row_ls = add_to_row_ls)
end_matter_1L_chr <- mdl_smry_chr[idx_dbl[6]:length(mdl_smry_chr)] %>% paste0(collapse = " ")
brms_mdl_print_ls <- list(part_1 = mdl_smry_chr[idx_dbl[1]],
                          part_2 = "\n\n",
                          part_3 = c(mdl_smry_chr[1:(idx_dbl[2]-1)][-idx_dbl[1]],
  paste0(mdl_smry_chr[idx_dbl[2]], " ",trimws(mdl_smry_chr[idx_dbl[2]+1]), collapse = " ")) %>%
  paste0(collapse = "\n\n"),
  part_4 = "\n\n",
  part_5 = print_table_xx(data_tb = data_tb,
               output_type_1L_chr = output_type_1L_chr,
               caption_1L_chr = caption_1L_chr,
               label = paste0("tab:",label_stub_1L_chr),
               hline.after =  c(-1,0),
               sanitize_fn = force,
               footnotes_chr = ifelse(output_type_1L_chr=="PDF",
                                      NA_character_,
                                      end_matter_1L_chr),
              addtorow = add_to_row_ls),
  part_6 = end_matter_1L_chr)
return(brms_mdl_print_ls)
}
print_brms_mdl_tbl <- function(brms_mdl_print_ls){
  # mdl_smry_chr = brms_mdl_print_ls$mdl_smry_chr
  # idx_dbl = brms_mdl_print_ls$idx_dbl
  # data_tb = brms_mdl_print_ls$data_tb
  # output_type_1L_chr = brms_mdl_print_ls$output_type_1L_chr
  # caption_1L_chr = brms_mdl_print_ls$caption_1L_chr
  # label_stub_1L_chr = brms_mdl_print_ls$label_stub_1L_chr
  # add_to_row_ls = brms_mdl_print_ls$add_to_row_ls

if(output_type_1L_chr=="PDF"){
  end_matter_1L_chr %>% cat()
}

                               }



```

# TEST SECTION

```{r child="./AQoL_6D_Replication_Fns.Rmd", echo=FALSE}

```

```{r, include=FALSE}
path_to_mdl_1L_chr <- "../../../../../../../Data/Project/Utility_Models/PHQ9_GSN_LOG.RDS"
#mdl_ls <- readRDS(path_to_mdl_1L_chr)
paths_to_mdl_plts_chr <- paste0(path_to_mdl_1L_chr %>% stringr::str_sub(end=-5), paste0("_",c("coefs","hetg", "dnst","sctr_plt"),".png"))
plt_nms_chr <- c("Caption 1","Caption 2","Caption 3","Caption 4")
output_ls <- list(`First predictor` = paths_to_mdl_plts_chr,
                  `Second predictor` = paths_to_mdl_plts_chr)
plt_nms_chr <- rep(plt_nms_chr,2)
fig_nums <- captioner::captioner()
```

<!-- \newpage -->
<!-- \blandscape -->
```{r echo = F, results='asis'}
brms_mdl_print_ls <- make_brms_mdl_print_ls(mdl_ls = readRDS(path_to_mdl_1L_chr),
label_stub_1L_chr = "LABELSTUB",
caption_1L_chr = "CAPTION FOR TABLE",
output_type_1L_chr = params$output_type_1L_chr,
footnote_1L_chr = "") 
brms_mdl_print_ls 
# print_brms_mdl_tbl()

# brms_mdl_print_ls$data_tb %>% print_table_xx(output_type_1L_chr = brms_mdl_print_ls$output_type_1L_chr,
#                caption_1L_chr = brms_mdl_print_ls$caption_1L_chr,
#                label = paste0("tab:",brms_mdl_print_ls$label_stub_1L_chr),
#                hline.after =  c(-1,0),
#                sanitize_fn = force,
#                footnotes_chr = brms_mdl_print_ls$mdl_smry_chr[brms_mdl_print_ls$idx_dbl[6]:length(brms_mdl_print_ls$mdl_smry_chr)] %>% paste0(collapse = " "),
#               addtorow = brms_mdl_print_ls$add_to_row_ls)
#readRDS(path_to_mdl_1L_chr) %>% sjPlot::tab_model()

```



<!-- \elandscape -->
<!-- \newpage -->
```{r results='asis', echo=F}
#From: https://stackoverflow.com/questions/20409172/how-to-display-verbatim-inline-r-code-with-backticks-using-rmarkdown
# rinline <- function(code) { 
#   sprintf('``` `r %s` ```', code)
# }
# rinline(fig_nums('pressure-plot', 'pressure against temperature'))
#cat(fig_nums('pressure-plot', 'pressure against temperature'))
#cat("\"\`r fig_nums(\"pressure-plot\", \"pressure against temperature\")\`\"")
#cat("some text \u0060r 2+3\u0060 and more text")
```

`r fig_nums("lab1", display = "cite")`
 
```{r, fig.cap=c("Caption 1", "Caption 2", "Caption 3", "Caption 4"), echo=FALSE, message=F}
# knitr::include_graphics(paths_to_mdl_plts_chr)
# cat('\n') 
# cat("###", "TEST", "\n\n")
# 
# for(plots in mdl_plts_ls){
#   print(mdl_plts_ls)
#   cat('\n\n') 
# }


```
