---
title: "TEST"
author: "Matthew Hamilton"
date: "06/08/2020"
output:
  pdf_document:
    number_sections: yes
    includes:  
      in_header: preamble.tex
  officedown::rdocx_document:
    number_sections: yes
  bookdown::html_document2:
    number_sections: yes
  html_document:
    df_print: paged
  bookdown::pdf_book:
    number_sections: yes
    includes:  
      in_header: preamble.tex
params:
  pdf_output_lgl: !r T
graphics: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(comment=NA)
library(xtable) # EDIT
library(FBaqol) # EDIT
library(magrittr)
options(tinytex.verbose = TRUE)
options(xtable.floating = FALSE)
options(xtable.timestamp = "")
```

```{r echo = FALSE}
make_brms_mdl_smry_tbl <- function(smry_mdl_ls,
                                   grp_1L_chr,
                                   pop_1L_chr,
                                   fam_1L_chr){
 brms_mdl_smry_tb <- purrr::map(1:length(smry_mdl_ls$random), 
           ~ make_mdl_smry_elmt_tbl(cat_chr = c(ifelse(.x==1,grp_1L_chr,character(0)),paste0(names(smry_mdl_ls$ngrps)[.x], 
                         " (Number of levels: ",smry_mdl_ls$ngrps[.x][[1]],")")),
                  mat = smry_mdl_ls$random[.x][[1]])) %>%
  dplyr::bind_rows(make_mdl_smry_elmt_tbl(mat = smry_mdl_ls$fixed, cat_chr = pop_1L_chr),
                   make_mdl_smry_elmt_tbl(mat = smry_mdl_ls$spec_pars, cat_chr = fam_1L_chr))
 return(brms_mdl_smry_tb)
                                   }
make_mdl_smry_elmt_tbl <- function(mat,
                              cat_chr){
  tb <- mat %>% tibble::as_tibble() %>% dplyr::mutate(Parameter = rownames(mat)) %>% dplyr::select(Parameter, dplyr::everything())

mdl_elmt_sum_tb <- tb %>% dplyr::filter(F) %>% tibble::add_case(Parameter = cat_chr) %>%
  dplyr::bind_rows(tb)
return(mdl_elmt_sum_tb)
}
print_ts_mdl_plts <- function(paths_to_plts_chr,
                              title_1L_chr,
                              label_refs_chr,
                              mdl_smry_ls){
    cat('\n')
  cat("## ", title_1L_chr, "\n")
  cat('\n')
  purrr::pwalk(list(paths_to_plts_chr,
              paste0(#"\\label{fig:fig",label_refs_chr,"}",
                     "Caption",1:length(paths_to_plts_chr)),
              label_refs_chr),
    ~ {
      cat(paste0('\n![',
                 #.y,
                 '](',
                 ..1,
                 ')\n\n'))
      cat(fig_nums(..3, ..2))
    cat('\n\n')
    })
 cat('\n\n')
}
print_all_plts_for_mdl_set <- function(output_ls,
                                       start_from_1L_int = 0L){
  label_refs_mat <- paste0("lab",1:(output_ls %>% purrr::flatten() %>% length())+start_from_1L_int) %>% matrix(nrow = length(output_ls), byrow=T)
purrr::walk(1:length(output_ls),
            ~ print_ts_mdl_plts(output_ls[[.x]], 
                                title_1L_chr = names(output_ls)[.x],
                                label_refs_chr = label_refs_mat[.x,]))
}
print_table_xx <- function(data_tb,
                           pdf_output_lgl,
                           caption_chr,
                           label,
                           hline.after,
                           addtorow,
                           sanitize_fn = getOption("xtable.sanitize.text.function", NULL)){
   data_x_tb <- data_tb %>%
  xtable::xtable(caption = caption_chr, label = label)
if(pdf_output_lgl){
 data_x_tb %>%
  print(comment = F,
        floating = TRUE, #floating.environment = "sidewaystable",
        hline.after = hline.after,
        caption.placement = "top",
        add.to.row = addtorow, 
        sanitize.text.function = sanitize_fn,
        include.colnames = FALSE,
        include.rownames = FALSE#,scalebox = 0.75
        ) 
}else{
  data_tb %>%
    kableExtra::kable(escape = F,
        caption = caption_chr) %>%
      kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                                full_width = F, 
                                position = "left") # NEED TO ADD FOOTNOTE
}
}
```

# TEST SECTION

```{r child="./AQoL_6D_Replication_Fns.Rmd", echo=FALSE}

```

```{r, include=FALSE}
path_to_mdl_1L_chr <- "../../../../../../../Data/Project/Utility_Models/PHQ9_GSN_LOG.RDS"
#mdl_ls <- readRDS(path_to_mdl_1L_chr)
paths_to_mdl_plts_chr <- paste0(path_to_mdl_1L_chr %>% stringr::str_sub(end=-5), paste0("_",c("coefs","hetg", "dnst","sctr_plt"),".png"))
plt_nms_chr <- c("Caption 1","Caption 2","Caption 3","Caption 4")
output_ls <- list(`First predictor` = paths_to_mdl_plts_chr,
                  `Second predictor` = paths_to_mdl_plts_chr)
plt_nms_chr <- rep(plt_nms_chr,2)
fig_nums <- captioner::captioner()
```

<!-- \newpage -->
<!-- \blandscape -->
```{r echo = F, results='asis'}
#grid::grid.raster(tiff::readTIFF(paths_to_mdl_plts_chr[1]))
# print_output <- function(output, cex = 0.8) {
#   tmp <- capture.output(output)
#   plot.new()
#   text(0, 1, paste(tmp, collapse='\n'), adj = c(0,1), family = 'mono', cex = cex)
#   box()
# }

mdl_ls <- readRDS(path_to_mdl_1L_chr)
smry_mdl_ls <- summary(mdl_ls, digits = 4)
mdl_smry_chr <- smry_mdl_ls %>% capture.output()  #paste0(collapse='\n')
mdl_smry_chr[3] %>% cat()
cat("\n\n")
c(mdl_smry_chr[1:4][-3], 
  paste0(mdl_smry_chr[5], " ",trimws(mdl_smry_chr[6]), collapse = " ")) %>% 
  paste0(collapse = "\n\n") %>% cat()
cat("\n\n")
data_tb <- make_brms_mdl_smry_tbl(smry_mdl_ls,
                       grp_1L_chr = ifelse(params$pdf_output_lgl,
                                           mdl_smry_chr[8],#paste0("\\\\textbf{","TEST","}"),
                                           mdl_smry_chr[8]),
                       pop_1L_chr = mdl_smry_chr[13],
                       fam_1L_chr = mdl_smry_chr[21])
label_stub_1L_chr <- "LABELSTUB"
addtorow <- list(pos = list(0, nrow(data_tb)),
                 command = c(names(data_tb) %>% stringr::str_replace_all("[[:punct:]]", " ") %>% paste0(collapse=" & ") %>% paste0("\\\\\n"),
                      paste0("\\hline\n","{\\footnotesize ",
                             "TEST",
                             #mdl_smry_chr[25:27] %>% paste0(collapse = " "),
                             "}\n")))
caption_chr <- "CAPTION FOR TABLE"
print_table_xx(data_tb = data_tb,
               pdf_output_lgl = params$pdf_output_lgl,
               caption_chr = caption_chr,
               label = paste0("tab:",label_stub_1L_chr),
               hline.after =  c(-1,0),
               #sanitize_fn = force,
              addtorow = addtorow)
mdl_smry_chr[25:27] %>% paste0(collapse = " ") %>% cat()

# print(smry_mdl_ls)
#readRDS(path_to_mdl_1L_chr) %>% sjPlot::tab_model()

```

```{r results = 'asis', echo = F}
data_3_tb <- read.csv("../Data/glm_SOFAS.csv")
data_3_tb <- data_3_tb[1:nrow(data_tb),]
addtorow <- list()
addtorow$pos <- list(0, nrow(data_3_tb)
                     )
addtorow$command <- c("Parameter* & Estimate	& SE	& 95CI & R2	& Sigma\\\\\n",
                      paste0("\\hline\n","{\\footnotesize * Calculated as original scores divided by 100}\n")) 

# caption_chr <- "Estimated coefficients from TTU models based on individual anxiety/depression measurements and SOFAS score using GLM (Gaussian distribution with log link)"
# print_table_xx(data_tb = data_3_tb,
#                pdf_output_lgl = params$pdf_output_lgl,
#                caption_chr = caption_chr,
#                label = "tab:coeffsll_table",
#                hline.after =  c(-1,0#,nrow(data_3_tb)
#                                 ),
#               addtorow = addtorow)
```

```{r results = 'asis', echo = F}
# addtorow <- list(pos = list(0, nrow(data_tb)),
#                  command = c(names(data_tb) %>% paste0(collapse=" & ") %>% paste0("\\\\\n"),
#                       paste0("\\hline\n","{\\footnotesize ",
#                              mdl_smry_chr[25:27] %>% paste0(collapse = " "),
#                              "}\n"))
# )
# addtorow$command <- c("Parameter & Estimate	& SE	& 95CI & R2	& Sigma\\\\\n",
#                       # paste0("\\hline\n","{\\footnotesize Calculated as original scores divided by 100}\n")) 
#                       paste0("\\hline\n","{\\footnotesize ",
#                              mdl_smry_chr[25:27] %>% paste0(collapse = "") %>% stringr::str_replace_all("[[:punct:]]", " "),
#                              "}\n"))
# print_table_xx(data_tb = data_tb[,1:6],
#                pdf_output_lgl = params$pdf_output_lgl,
#                caption_chr = caption_chr,
#                label = paste0("tab:",label_stub_1L_chr),
#                hline.after =  c(-1,0),
#               addtorow = addtorow)
```


<!-- \elandscape -->
<!-- \newpage -->
```{r results='asis', echo=F}
#From: https://stackoverflow.com/questions/20409172/how-to-display-verbatim-inline-r-code-with-backticks-using-rmarkdown
# rinline <- function(code) { 
#   sprintf('``` `r %s` ```', code)
# }
# rinline(fig_nums('pressure-plot', 'pressure against temperature'))
#cat(fig_nums('pressure-plot', 'pressure against temperature'))
#cat("\"\`r fig_nums(\"pressure-plot\", \"pressure against temperature\")\`\"")
#cat("some text \u0060r 2+3\u0060 and more text")
```

`r fig_nums("lab1", display = "cite")`
 
```{r, fig.cap=c("Caption 1", "Caption 2", "Caption 3", "Caption 4"), echo=FALSE, message=F}
# knitr::include_graphics(paths_to_mdl_plts_chr)
# cat('\n') 
# cat("###", "TEST", "\n\n")
# 
# for(plots in mdl_plts_ls){
#   print(mdl_plts_ls)
#   cat('\n\n') 
# }


```
