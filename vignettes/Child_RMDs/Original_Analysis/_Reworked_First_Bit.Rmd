---
title: "AQol-6D analyses"
output:
  html_document: 
    code_folding: "hide"
    toc: yes 
  output: html_notebook
---


Check missing

```{r}
# non missing 
table(Baseline_follow[!is.na(Baseline_follow$aqol6d_total_c),]$round)

nrow(Baseline_follow)
```

# Descriptive statistics 


```{r, results='asis'}
my_controls <- tableby.control(
  test = F,
  total = F,
  digits=1,
  digits.pct=1,
  digits.p=3,
  numeric.test = "anova", cat.test = "chisq",
  numeric.stats = c("meansd", "medianq1q3", "range", "Nmiss2"),
  cat.stats = c("countpct", "Nmiss2"),
  ordered.stats=c("countpct", "Nmiss2"),
  stats.labels = list(
    meansd = "Mean (SD)",
    medianq1q3 = "Median (Q1, Q3)",
    range = "Min - Max",
    Nmiss2 = "Missing"
  )
)
 
table<- tableby( round  ~ d_age + d_agegroup + Gender + d_sexual_ori_s + Region + CALD +  d_studying_working  + c_p_diag_s + c_clinical_staging_s + SOFAS ,
  data = Baseline_follow,
  control = my_controls
)
 
summary(table,
  title = "Participant characteristics"
)
```


# Outcome table
```{r, results='asis'}
 
table<- tableby(  round~  PHQ9 +  BADS+ GAD7 +OASIS+ SCARED + K6  + aqol6d_total_c  + aqol6d_total_w ,
  data = Baseline_follow,
  control = my_controls
)
 
summary(table,
  title = "Participant outcome"
)
```

# Correlation 

```{r, results='asis'}
library(xtable)
baseline<- Baseline_follow %>% 
   filter(round=="Baseline") %>% 
   dplyr::select( aqol6d_total_w, PHQ9 ,  BADS, GAD7 ,OASIS,  SCARED, K6,) 

corstars(baseline, result="html")

followup<-Baseline_follow[Baseline_follow$round=="Follow-up",] %>% 
   dplyr::select(aqol6d_total_w, PHQ9 ,  BADS, GAD7 ,OASIS,  SCARED, K6 ) 

corstars(followup, result="html")

``` 


# Plots 

## Crude question responses 
  
```{r, fig.height=12, fig.width=12,warning=FALSE,}

colNames <- names(select(Baseline_follow, starts_with("aqol6d_q")))

labNames<-c("Household tasks", "Getting around", "Morbility","Self care",
            "Enjoy close rel’s", "Family rel’s", "Community involvement",
             "Despair","Worry", "Sad", "Agitated",
             "Energy level", "Control", "Coping", 
             "Frequency of pain", "Degree of pain", "Pain interference",
              "Vision", "Hearing", "Communication")

plot<-list() 
j=1
for(i in colNames){ 
    
    dta<-Baseline_follow %>% 
          filter( !is.na(!!as.name(i) )) %>% 
          group_by( round, !!as.name(i) ) %>% 
          summarise(n=n()) %>% 
          group_by(round) %>% 
          mutate(y=n/sum(n))
    labelx<-labNames[j]
    j=j+1
    plot[[i]]<- ggplot(dta, aes_string(i)) +
          geom_bar(aes(y = y, fill=round),stat = "identity", na.rm = TRUE, position="dodge",colour="white",alpha=0.7) +
          scale_y_continuous(labels = percent_format()) +
          labs(x=labelx,y="Percentage",fill = "Data collection")  + 
          theme_bw()+
          theme(legend.position="none") +
          scale_fill_manual(values=c("#de2d26","#fc9272")) 
}


# function to extract the legend (borrowed from: https://github.com/hadley/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs )
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

#save legend from one plot 
legend<-ggplot(dta, aes_string(i)) +
          geom_bar(aes(y = y, fill=round),stat = "identity", na.rm = TRUE, position="dodge",colour="white",alpha=0.7)  +
          labs(x=labelx,y="Percentage", fill = "Data collection")  +
          theme(legend.position="bottom") +
          scale_fill_manual(values=c("#de2d26","#fc9272")) 
legend <- g_legend(legend)

#arrange all plot together
grid.arrange(ggarrange(plotlist=plot,nrow=5,ncol=4) ,
             legend, nrow=2,heights=c(10, 1))

```



## Weighted subtotal scores

```{r, fig.height=10 ,fig.width=8,warning=FALSE}
colNames <- names(select(Baseline_follow, starts_with("aqol6d_subtotal_w")))

plot<-list()
for(i in colNames){ 
    
    labelx<-eval(parse(text=paste0("attributes(Baseline_follow$",i,")$label")))
    labelx<- str_to_sentence(str_sub(labelx,38,55))
    plot[[i]]<- ggplot(Baseline_follow, aes_string(i)) +
      geom_histogram(bins=8,color = "white",aes(fill=round,y=2*(..density..)/sum(..density..)), position = 'dodge',alpha=0.7) +
      labs(x=labelx,y="Percentage")  + 
      theme_bw() +
      scale_y_continuous(labels = scales::percent) +
      theme(legend.position="none") +
      scale_fill_manual(values=c("#de2d26","#fc9272")) 
}

# function to extract the legend (borrowed from: https://github.com/hadley/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs )
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

#save legend from one plot 
legend<-ggplot(Baseline_follow, aes_string(i)) +
      geom_histogram(bins=8,color = "white",aes(fill=round,y=2*(..density..)/sum(..density..)), position = 'dodge',alpha=0.7) +
      labs(x=labelx,y="Percentage", fill = "Data collection")  + 
      theme_bw() +
      theme(legend.position="bottom") +
      scale_y_continuous(labels = scales::percent) +
      scale_fill_manual(values=c("#de2d26","#fc9272")) 


legend <- g_legend(legend)

grid.arrange(ggarrange(plotlist=plot,nrow=3,ncol=2) ,
             legend, nrow=2,heights=c(10, 1))  

```



## log-log transformed scores subtotal scores


```{r, fig.height=10 ,fig.width=8,warning=FALSE}
colNames <- names(select(Baseline_follow, starts_with("aqol6d_subtotal_w")))

plot<-list()
for(i in colNames){
    targetvar=paste0("tran_",i)
    #log-log transform 
    Baseline_follow<- mutate(Baseline_follow,!!targetvar := log(-log(1-!!as.name(i))))  %>% 
          mutate(!!targetvar :=ifelse(!!as.name(i)==1,log(-log(1-0.999)),!!as.name(targetvar )))
    #extract label  
    labelx<-eval(parse(text=paste0("attributes(Baseline_follow$",i,")$label")))
    labelx<- paste0("log-log transformed ",str_to_sentence(str_sub(labelx,38,55)))
    #plot
    plot[[i]]<- ggplot(Baseline_follow, aes_string(targetvar)) +
         geom_histogram(bins=8,color = "white",aes(fill=round),position = 'dodge',alpha=0.7) +
          labs(x=labelx, y="Percentage")  +
          theme_bw() +
          scale_y_continuous(labels = scales::percent) +
          theme(legend.position="none") +
          scale_fill_manual(values=c("#de2d26","#fc9272")) 
      
}

# extract legend
legend<-ggplot(Baseline_follow, aes_string(targetvar)) +
         geom_histogram(bins=8,color = "white",aes(fill=round),position = 'dodge',alpha=0.7) +
          labs(x=labelx, y="Percentage", fill = "Data collection")  +
          theme_bw() +
          theme(legend.position="bottom") +
          scale_y_continuous(labels = scales::percent) +
          scale_fill_manual(values=c("#de2d26","#fc9272")) 

legend <- g_legend(legend)
grid.arrange(ggarrange(plotlist=plot,nrow=3,ncol=2) ,
             legend, nrow=2,heights=c(10, 1))  

```

## Total utility score and by round 

```{r,fig.width=8,warning=FALSE}

ggplot(Baseline_follow,aes(x=aqol6d_total_w,fill=round)) +
        theme_bw() +
        geom_histogram( aes(y = stat(width*density)),
                        bins=10,position="dodge",colour="white",alpha=0.7) + 
        scale_y_continuous(labels = percent_format()) +
        labs(y="Percentage",x= "AQoL-6D utility score", fill = "Data collection")  +
        scale_fill_manual(values=c("#de2d26","#fc9272"))  +
        theme(legend.position="bottom")


```

# Regression testing 

## Boxcox transformation 

```{r}
library(MASS)
initech_fit = lm(aqol6d_total_w ~ PHQ9, data = baseline)
bc<-boxcox(initech_fit, plotit = TRUE)
bc$x[which.max(bc$y)]
```

close to no transformation

```{r,fig.width= 12, fig.height=6}

baseline<-baseline %>% 
  mutate(aqol6d_total_w=ifelse(aqol6d_total_w==1,0.999,aqol6d_total_w)) %>% 
  mutate(aqol6d_total_w_log=log(aqol6d_total_w),
         aqol6d_total_w_logit=logit(aqol6d_total_w),
         aqol6d_total_w_loglog= -log(-log(aqol6d_total_w)),
         aqol6d_total_w_cloglog= log(-log(1-aqol6d_total_w))) %>% 
  filter(!is.na(PHQ9)) 


set.seed(12345)
folds_10 <- createFolds(baseline$aqol6d_total_w , k = 10, list = TRUE, returnTrain = FALSE)

gather(baseline, variable, value, aqol6d_total_w, aqol6d_total_w_log,  aqol6d_total_w_logit,  aqol6d_total_w_loglog,aqol6d_total_w_cloglog) %>%
mutate(variable = factor(variable, levels = c("aqol6d_total_w", 
                                                "aqol6d_total_w_log", 
                                                "aqol6d_total_w_logit", 
                                                "aqol6d_total_w_loglog", "aqol6d_total_w_cloglog"),
                                      labels= c("No transformation",
                                                "Log", "Logit","Log-log", "Complementary log-log"))) %>%
  ggplot(aes(x = value, fill = variable)) +
    geom_bkde() +
    geom_rug() +
    scale_fill_viridis(guide = FALSE, discrete = TRUE) +
    facet_wrap(~variable, scales = "free") +
    theme_bw() + labs(x="Transformed AQoL-6D utility scores")
```

## Linear model (no transformation)
```{r}
make_one_predr_mdl <- function(data_tb,
                               dep_var_nm_1L_chr = "aqol6d_total_w",
                               predr_var_nm_1L_chr,
                               mdl_type_1L_chr = "lm"){
  mdl_1L_chr <- paste0(mdl_type_1L_chr,"(",dep_var_nm_1L_chr," ~ ",predr_var_nm_1L_chr, ", data = data_tb)")
  mdl <- eval(parse(text = mdl_1L_chr))
  return(mdl)
}
make_predn_ds_with_one_predr <- function(mdl,
                                         dep_var_nm_1L_chr = "aqol6d_total_w",
                                         predr_var_nm_1L_chr,
                                         predr_vals_dbl){
  predn_ds_tb <- tibble::tibble(!!rlang::sym(predr_var_nm_1L_chr) := predr_vals_dbl)
  predn_ds_tb <- predn_ds_tb %>% dplyr::mutate(!!rlang::sym(dep_var_nm_1L_chr) := predict(mdl, newdata = predn_ds_tb))
  return(predn_ds_tb)
}
plot_lnr_cmprsn <- function(data_tb,
                      predn_ds_tb,
                      dep_var_nm_1L_chr = "aqol6d_total_w",
                      predr_var_nm_1L_chr,
                      dep_var_desc_1L_chr = "AQoL-6D utility score",
                      predr_var_desc_1L_chr){
  ggplot2::ggplot(data_tb,ggplot2::aes(x = !!rlang::sym(predr_var_nm_1L_chr), y = !!rlang::sym(dep_var_nm_1L_chr) )) +
  ggplot2::geom_point() + 
  ggplot2::geom_smooth(method = "loess", size = 1.5) +
  ggplot2::geom_line(data = predn_ds_tb, ggplot2::aes(x = !!rlang::sym(predr_var_nm_1L_chr), y = !!rlang::sym(dep_var_nm_1L_chr)),col="red")  +
  ggplot2::theme_bw() + ggplot2::labs(x= predr_var_desc_1L_chr, y= dep_var_desc_1L_chr)
}
plot_sctr_lnr_cmprsn <- function(tfd_data_tb,
                                 dep_var_nm_1L_chr = "aqol6d_total_w",
                                 predd_val_var_nm_1L_chr = "Predicted"){
  tfd_data_tb %>%
    ggplot2::ggplot(ggplot2::aes(x = !!rlang::sym(dep_var_nm_1L_chr),
                             y = !!rlang::sym(predd_val_var_nm_1L_chr))) +
  ggplot2::geom_point() + 
  ggplot2::geom_smooth(method = "loess", size = 1.5) +
  ggplot2::theme_bw() +
  ggplot2::geom_abline(intercept = 0, slope = 1, color="red", 
                       linetype="dashed", size=1.5) +
  ggplot2::xlim(0, 1) + ggplot2::ylim(0, 1)
}
transform_data_tb_for_cmprsn <- function(data_tb,
                                         mdl,
                                         dep_var_nm_1L_chr = "aqol6d_total_w",
                                         source_data_nm_1L_chr = "Original",
                                         tf_type_1L_chr = "Predicted"){
  if(tf_type_1L_chr == "Predicted")
    new_data_dbl <- predict(mdl)
  if(tf_type_1L_chr == "Simulated")
    new_data_dbl <- simulate(mdl)$sim_1
  tfd_data_tb <- data_tb %>% 
    dplyr::mutate(!!rlang::sym(tf_type_1L_chr) := new_data_dbl,
         !!rlang::sym(source_data_nm_1L_chr) := !!rlang::sym(dep_var_nm_1L_chr))
  return(tfd_data_tb)
}
make_smry_of_one_predr_mdl <- function(data_tb,
                                       mdl,
                                       folds_ls,
                                       dep_var_nm_1L_chr = "aqol6d_total_w",
                                       predr_var_nm_1L_chr,
                                       mdl_type_1L_chr = "lm",
                                       mdl_nm_1L_chr = "OLS (no transformation)"){
purrr::map_dfr(folds_ls,
               ~ {
                   mdl <- make_one_predr_mdl(data_tb,
                               dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                               predr_var_nm_1L_chr = predr_var_nm_1L_chr,
                               mdl_type_1L_chr = mdl_type_1L_chr) 
  pred_old_dbl <- predict(mdl)
  pred_new_dbl <- predict(mdl,newdata=data_tb[.x,])
  tibble::tibble(Rsquared = caret::R2(pred_old_dbl, data_tb[-.x,] %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr)), form = "traditional"),
  RMSE = caret::RMSE(pred_old_dbl, data_tb[-.x,] %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr))),
  MAE = caret::MAE(pred_old_dbl, data_tb[-.x,] %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr))),
  RsquaredP = caret::R2(pred_new_dbl, data_tb[.x,] %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr)), form = "traditional"),
  RMSEP = caret::RMSE(pred_new_dbl, data_tb[.x,] %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr))),
  MAEP = caret::MAE(pred_new_dbl, data_tb[.x,] %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr))))
               }
) %>% dplyr::summarise_all(mean) %>%
    dplyr::mutate(Model = mdl_nm_1L_chr) %>%
    dplyr::select(Model, dplyr::everything())
}
```

```{r}
predr_var_nm_1L_chr = "PHQ9"
data_tb <- baseline
mdl <- make_one_predr_mdl(data_tb,predr_var_nm_1L_chr = predr_var_nm_1L_chr, mdl_type_1L_chr = "lm")
summary(mdl)
predn_ds_tb <- make_predn_ds_with_one_predr(mdl, predr_var_nm_1L_chr = predr_var_nm_1L_chr, predr_vals_dbl = 0:27)
transform_data_tb_for_cmprsn(data_tb, mdl = mdl)
plot_lnr_cmprsn(data_tb = data_tb,
               predn_ds_tb = predn_ds_tb,
               predr_var_nm_1L_chr = predr_var_nm_1L_chr,
               predr_var_desc_1L_chr = "PHQ9 total score")
ggplot2::autoplot(mdl, which = 1:6, ncol = 3, label.size = 3)
tfd_data_tb <- transform_data_tb_for_cmprsn(data_tb, mdl = mdl) 
tfd_data_tb %>%
  plot_obsd_predd_dnst()
transform_data_tb_for_cmprsn(data_tb, mdl = mdl, tf_type_1L_chr = "Simulated") %>%
  plot_obsd_predd_dnst(predd_val_var_nm_1L_chr = "Simulated")
tfd_data_tb %>%
  plot_sctr_lnr_cmprsn()
# transform_data_tb_for_cmprsn(data_tb, mdl = mdl, tf_type_1L_chr = "Simulated") %>%
#   plot_sctr_lnr_cmprsn(predd_val_var_nm_1L_chr = "Simulated")
make_smry_of_one_predr_mdl()#

```


```{r}
summary_table<-data.frame("Model"=NA,"Rsquare"=NA,"RMSE"=NA, "MAE"=NA, "Rsquare.prediction"=NA, "RMSE prediction"=NA,"MAE prediction"=NA)

library(ggfortify)
fit = lm(aqol6d_total_w ~ PHQ9, data = baseline)
summary(fit)


newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata)
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)


baseline %>% 
    mutate(Predicted=predict(fit),
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="")

baseline %>% 
    mutate(Simulated=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="")

baseline %>% 
  mutate(Predicted=predict(fit),
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1)


Rsquared<-NA
RMSE<-NA
MAE<-NA
RsquaredP<-NA
RMSEP<-NA
MAEP<-NA
for (i in 1:10) {
  fit = lm(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],])
  pred<-predict(fit)
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],])
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 

n=1
#save model fit
summary_table[n,1]="OLS (no transformation)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

```



## Linear model (log transformation)

```{r}

fit = lm(aqol6d_total_w_log ~ PHQ9, data = baseline)
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=exp(predict(fit,newdata=newdata))
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)

baseline %>% 
    mutate(Predicted=exp(predict(fit)),
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="")


baseline %>% 
    mutate(Simulated=exp(simulate(fit)$sim_1),
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="")


baseline %>% 
    mutate(Predicted=exp(predict(fit)),
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1)

Rsquared<-NA
RMSE<-NA
MAE<-NA
RsquaredP<-NA
RMSEP<-NA
MAEP<-NA
for (i in 1:10) {
  fit = lm(aqol6d_total_w_log ~ PHQ9, data = baseline[-folds_10[[i]],])
  pred<-exp(predict(fit))
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-exp(predict(fit,newdata=baseline[folds_10[[i]],]))
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 

n=n+1
#save model fit
summary_table[n,1]="OLS (log)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)
``` 



## Linear model (logit transformation)

```{r}
library(boot)
fit = lm(aqol6d_total_w_logit ~ PHQ9, data = baseline)
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=inv.logit(predict(fit,newdata=newdata))
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)

 
baseline %>% 
    mutate(Predicted=inv.logit(predict(fit)),
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="")

baseline %>% 
    mutate(Simulated=inv.logit(simulate(fit)$sim_1) ,
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="")


baseline %>% 
    mutate(Predicted=inv.logit(predict(fit)),
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1)

Rsquared<-NA
RMSE<-NA
MAE<-NA
RsquaredP<-NA
RMSEP<-NA
MAEP<-NA
for (i in 1:10) {
  fit = lm(aqol6d_total_w_logit ~ PHQ9, data = baseline[-folds_10[[i]],])
  pred<-inv.logit(predict(fit))
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-inv.logit(predict(fit,newdata=baseline[folds_10[[i]],]))
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 

n=n+1
#save model fit
summary_table[n,1]="OLS (logit)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)
``` 




## Linear model (log-log transformation)

```{r}
library(ggfortify)
fit = lm(aqol6d_total_w_loglog ~ PHQ9, data = baseline)
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=exp(-exp(-predict(fit,newdata=newdata)))
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")


ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)


 
baseline %>% 
    mutate(Predicted=exp(-exp(-predict(fit))) ,
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
    mutate(Simulated=exp(-exp(-simulate(fit)$sim_1)) ,
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 



baseline %>% 
    mutate(Predicted=exp(-exp(-predict(fit))) ,
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = lm(aqol6d_total_w_loglog ~ PHQ9, data = baseline[-folds_10[[i]],])
  pred<-exp(-exp(-predict(fit))) 
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-exp(-exp(-predict(fit,newdata=baseline[folds_10[[i]],]))) 
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="OLS (loglog)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

``` 




## Linear model (clog-log transformation)

```{r}
library(ggfortify)
fit = lm(aqol6d_total_w_cloglog ~ PHQ9, data = baseline)
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=1-exp(-exp(predict(fit,newdata=newdata)))
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)


 
baseline %>% 
    mutate(Predicted=1-exp(-exp(predict(fit))) ,
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
    mutate(Simulated=1-exp(-exp(simulate(fit)$sim_1)) ,
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 


baseline %>% 
     mutate(Predicted=1-exp(-exp(predict(fit))) ,
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = lm(aqol6d_total_w_cloglog ~ PHQ9, data = baseline[-folds_10[[i]],])
  pred<-1-exp(-exp(predict(fit))) 
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-1-exp(-exp(predict(fit,newdata=baseline[folds_10[[i]],]))) 
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="OLS (cloglog)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

``` 






## GLM (Gausian with log link)

```{r}
library(ggfortify)
fit = glm(aqol6d_total_w ~ PHQ9, data = baseline,family=gaussian(log), start=c(-0.1,-0.1)) 
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response")
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)

baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 


 
baseline %>% 
    mutate(Simulated=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 



baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = glm(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],],family=gaussian(log), start=c(-0.1,-0.1)) 
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="GLM (Gausian with log link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

``` 




## GLM (Binomial with log link)

```{r}
library(ggfortify)
fit = glm( aqol6d_total_w  ~ PHQ9, data = baseline,family=quasibinomial(log),start=c(-0.1,-0.1))
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response")
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)

baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

 
baseline %>% 
    mutate(Simulated=exp(predict(fit)+rnorm(n(),0,sigma(fit))), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 


baseline %>% 
     mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = glm(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],],family=quasibinomial(log),start=c(-0.1,-0.1))
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="GLM (Binomial with log link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)


``` 




## GLM (Binomial with logit link)

```{r}
library(ggfortify)
fit = glm( aqol6d_total_w  ~ PHQ9, data = baseline,family=quasibinomial(logit),start=c(-0.1,-0.1))
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response")
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)

baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

 
baseline %>% 
    mutate(Simulated=inv.logit(predict(fit)+rnorm(n(),0,sigma(fit))), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 


baseline %>% 
     mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = glm(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],],family=quasibinomial(logit),start=c(-0.1,-0.1))
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="GLM (Binomial logit link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)


``` 




## GLM (Binomial with cloglog link)

```{r}
library(ggfortify)
fit = glm( aqol6d_total_w  ~ PHQ9, data = baseline,family=quasibinomial(cloglog),start=c(-0.1,-0.1))
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response")
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

ggplot2::autoplot(fit, which = 1:6, ncol = 3, label.size = 3)

 
baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="")   


 
baseline %>% 
    mutate(Simulated=1-exp(-exp(predict(fit)+rnorm(n(),0,sigma(fit)))), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Simulated, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="")   


baseline %>% 
     mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = glm(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],],family=quasibinomial(cloglog),start=c(-0.1,-0.1))
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="GLM (Binomial with cloglog link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

``` 

## Beta regression log link

```{r}
library(betareg) 

fit = betareg( aqol6d_total_w  ~ PHQ9, data = baseline, link="log",control=betareg.control(start=c(-0.5,-0.1,3)))
summary(fit)  

newdata<-data.frame(PHQ9=0:27) 
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response") 
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score") 

 
baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="")  



baseline %>% 
     mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = betareg(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],], link="log",control=betareg.control(start=c(-0.5,-0.1,3)))
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="Beta regression (log link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

``` 


## Beta regression logit link

```{r}
library(betareg)
fit = betareg( aqol6d_total_w  ~ PHQ9, data = baseline, link="logit",control=betareg.control(start=c(-0.5,-0.1,3)))
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response")
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")

 
baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 



baseline %>% 
     mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = betareg(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],], link="logit",control=betareg.control(start=c(-0.5,-0.1,3)))
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="Beta regression (logit link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

``` 


## Beta regression cloglog link

```{r}
library(betareg)
fit = betareg( aqol6d_total_w  ~ PHQ9, data = baseline, link="cloglog",control=betareg.control(start=c(-0.5,-0.1,3)))
summary(fit)

newdata<-data.frame(PHQ9=0:27)
newdata$aqol6d_total_w=predict(fit,newdata=newdata,type="response")
 
ggplot(baseline,aes(x = PHQ9, y= aqol6d_total_w )) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  geom_line(data=newdata,aes(x = PHQ9, y= aqol6d_total_w),col="red")  +
  theme_bw() + labs(x="PHQ9 total score",y="AQoL-6D utility score")
 
baseline %>% 
    mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>%  
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 


baseline %>% 
     mutate(Predicted=predict(fit,type="response"), 
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 



Rsquared<-NA 
RMSE<-NA 
MAE<-NA 
RsquaredP<-NA 
RMSEP<-NA 
MAEP<-NA 
for (i in 1:10) {
  fit = betareg(aqol6d_total_w ~ PHQ9, data = baseline[-folds_10[[i]],], link="cloglog",control=betareg.control(start=c(-0.5,-0.1,3)))
  pred<-predict(fit,type="response")
  Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
  pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
  RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
  RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
  MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


n=n+1
#save model fit
summary_table[n,1]="Beta regression (cloglog link)" 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)

``` 

## Summary of model fit

```{r} 
knitr::kable( summary_table  , format="html",digits = 3) %>%
    kable_styling(bootstrap_options = "striped", full_width = F) 
```



# Predictor selection 

## Random forest 

```{r, fig.height=8, fig.width=10}
library(randomForest)
library(Boruta)
baseline

baseline<- Baseline_follow %>% 
   filter(round=="Baseline") %>% 
   dplyr::select( aqol6d_total_w, PHQ9 ,  BADS, GAD7 ,OASIS,  SCARED, K6)  %>% 
   na.omit()

names(baseline)<-c("aqol6d_total_w", "PHQ9", "BADS", "GAD7","OASIS","SCARED","K6" )

folds_10 <- createFolds(baseline$aqol6d_total_w , k = 10, list = TRUE, returnTrain = FALSE)

## Random Forest
RF<-randomForest(aqol6d_total_w~.,data=baseline,importance=TRUE)
varImpPlot(RF)


## Boruta 
boruta.model <- Boruta(aqol6d_total_w~., data = baseline , maxRuns = 300)
# plot variable importance 
op <- par(mar = c(10,4,4,3) + 0.1)
plot(boruta.model,cex=1.5, cex.axis=1, las=2, xlab="", main="Variable Importance")
```

## Individual predictor

```{r}
predictors<-c("PHQ9", "BADS", "GAD7","OASIS","SCARED","K6" )

summary_table<-data.frame("Model"=NA,"Rsquare"=NA,"RMSE"=NA, "MAE"=NA, "Rsquare.prediction"=NA, "RMSE prediction"=NA,"MAE prediction"=NA)

n=1 
for(predictor in predictors){  
  Rsquared<-NA 
  RMSE<-NA 
  MAE<-NA 
  RsquaredP<-NA 
  RMSEP<-NA 
  MAEP<-NA 
  for (i in 1:10) {
    fit = glm(as.formula(paste0("aqol6d_total_w~", predictor )), data = baseline[-folds_10[[i]],], family=gaussian(log)) 
    pred<-predict(fit,type="response")
    Rsquared[i]=R2(pred, baseline[-folds_10[[i]],]$aqol6d_total_w, form = "traditional")
    RMSE[i]=RMSE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
    MAE[i]=MAE(pred, baseline[-folds_10[[i]],]$aqol6d_total_w)
    pred<-predict(fit,newdata=baseline[folds_10[[i]],],type="response")
    RsquaredP[i]=R2(pred, baseline[folds_10[[i]],]$aqol6d_total_w, form = "traditional")
    RMSEP[i]=RMSE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
    MAEP[i]=MAE(pred, baseline[folds_10[[i]],]$aqol6d_total_w)
} 


#save model fit
summary_table[n,1]=predictor 
summary_table$Rsquare[n]= mean(Rsquared)
summary_table$RMSE[n]= mean(RMSE)
summary_table$MAE[n]=mean(MAE)
summary_table$`Rsquare.prediction`[n]=mean(RsquaredP)
summary_table$`RMSE.prediction`[n]=mean(RMSEP)
summary_table$`MAE.prediction`[n]=mean(MAEP)
n=n+1
}

knitr::kable( summary_table  , format="html",digits = 3) %>%
    kable_styling(bootstrap_options = "striped", full_width = F) 
```

## Additional confounding variables

```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w, K6 ,PHQ9 ,  BADS, GAD7 ,OASIS,  SCARED,
          d_sex_birth_s , SOFAS ,c_p_diag_s , c_clinical_staging_s ,  d_age , d_sexual_ori_s ,
          d_country_bir_s,  d_relation_s , d_studying_working) %>% 
   na.omit()


predictor<-c("PHQ9", "BADS", "K6","OASIS","SCARED","GAD7" )

summarytable<-data.frame("variable"=character(),"data"=character(),"Rsquared"=double(),
                            "AIC"=double(),BIC=double(),"Significant"=character())

for(i in predictor){  
  model<-glm(as.formula(paste0("aqol6d_total_w~", i , "+d_sex_birth_s + SOFAS +c_p_diag_s + c_clinical_staging_s +  d_age + d_sexual_ori_s + d_country_bir_s + d_relation_s + d_studying_working")), data=baseline, family=gaussian(log)) 
  print(summary(model))
  summarytable=rbind(summarytable,data.frame("variable"=i,
                     Rsuqare=R2(baseline$aqol6d_total_w, predict(model), form = "traditional"),
                     AIC=AIC(model), BIC=BIC(model),
                     "Significant"=paste(names(which(summary(model)$coefficients[,4]<0.01)),collapse = " "))) 
} 



knitr::kable( summarytable  , format="html",digits = 3) %>%
    kable_styling(bootstrap_options = "striped", full_width = F) 
```

## Checking 

### PHQ9 
```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w ,PHQ9, SOFAS) %>% 
   na.omit()

fit = glm(aqol6d_total_w ~ PHQ9 + SOFAS  , data = baseline,family=gaussian(log))

summary(fit)
baseline %>% 
    mutate(Predicted=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 


```


### BADS 
```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w ,BADS, SOFAS) %>% 
   na.omit()

fit = glm(aqol6d_total_w ~ BADS + SOFAS  , data = baseline,family=gaussian(log))

summary(fit)
baseline %>% 
    mutate(Predicted=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 


```



### GAD7 
```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w ,GAD7, SOFAS) %>% 
   na.omit()

fit = glm(aqol6d_total_w ~ GAD7 + SOFAS  , data = baseline,family=gaussian(log))

summary(fit)
baseline %>% 
    mutate(Predicted=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 


```


### OASIS  
```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w ,OASIS, SOFAS) %>% 
   na.omit()

fit = glm(aqol6d_total_w ~ OASIS + SOFAS  , data = baseline,family=gaussian(log))

summary(fit)
baseline %>% 
    mutate(Predicted=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 


```



### SCARED 
```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w ,SCARED, SOFAS) %>% 
   na.omit()

fit = glm(aqol6d_total_w ~ SCARED + SOFAS  , data = baseline,family=gaussian(log))

summary(fit)
baseline %>% 
    mutate(Predicted=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 


```



### K6 
```{r}
baseline<-Baseline_follow[Baseline_follow$round=="Baseline",] %>% 
   dplyr::select(aqol6d_total_w ,K6, SOFAS) %>% 
   na.omit()

fit = glm(aqol6d_total_w ~ K6 + SOFAS  , data = baseline,family=gaussian(log))

summary(fit)
baseline %>% 
    mutate(Predicted=simulate(fit)$sim_1, 
         Original=aqol6d_total_w) %>% 
    gather(variable, value, Predicted, Original) %>%
    ggplot(aes(x = value, fill = variable)) +
    geom_bkde(alpha=0.5) +
    geom_rug() +
    scale_fill_viridis( discrete = TRUE) +
    theme_bw() +
    theme(legend.position="bottom") +
    labs( x="AQoL-6D utility score",fill="") 

baseline %>% 
     mutate(Predicted=predict(fit,type="response"),  
         Original=aqol6d_total_w) %>% 
  ggplot(aes(x = Original, y=Predicted)) +
  geom_point() + 
  geom_smooth(method = "loess", size = 1.5) +
  theme_bw() +
  geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5) +
  xlim(0, 1) + ylim(0, 1) 


```
