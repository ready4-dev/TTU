---
title: "AQoL-6D mappign using GLMM with anxiety/depression measurements and SOFAS score"
output: html_document:
  toc: yes 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#load libraries 
library(pacman)
p_load("dplyr", "tidyr","magrittr","reshape2", "ggplot2","gridExtra", "data.table",  "kableExtra", "knitr",  "here","tidyselect","scales", "ggpubr","Hmisc","stringr","psych","corrplot","arsenal","lavaan","semTools","semPlot","sandwich",
"ggalt","viridis", "ggthemes", "caret","brms")

sessionInfo()

```



# Import the data 

```{r}
Baseline_follow<-readRDS( here::here("Data cleaning","Data","Combined_cleaned_V4.rds")) %>%     
  mutate(d_agegroup_s=cut(d_age,breaks=c(11,17,30), labels=c("Age 12-17","Age 18-26"))) %>% 
  filter(!is.na(aqol6d_total_w)) %>% 
  mutate(round=factor(round,labels=c("Baseline","Follow-up"))) %>% 
  dplyr::select(fkClientID, c_p_diag_s , s_centre, c_clinical_staging_s, 
          d_age , d_agegroup ,d_gender,
          d_sex_birth_s , d_sexual_ori_s ,
          d_country_bir_s, d_ATSI,d_english_home, d_english_native, 
          d_relation_s,  d_studying_working, k6_total, 
          phq9_total, bads_total, gad7_total,oasis_total,
          scared_total, 
          contains("aqol6d"),c_sofas, round) %>% 
  mutate(Gender= factor(ifelse(d_gender =="Genderqueer/gender nonconforming/agender" | 
                d_gender=="Transgender" , "Other", as.character(d_gender))))   %>% 
  mutate(Region=as.factor(ifelse(s_centre=="Canberra" |  s_centre=="Southport" | s_centre=="Knox", "Metro","Regional"))) %>% 
  mutate(CALD=factor(ifelse(d_country_bir_s=="Other" | d_english_home=="No" | d_english_native=="No" | d_ATSI=="Yes" , "Yes", "No" ))) %>%
  rename(PHQ9=phq9_total,BADS=bads_total,GAD7=gad7_total,OASIS=oasis_total, SCARED=scared_total,K6=k6_total,SOFAS=c_sofas)

nrow(Baseline_follow)

```

Check missing

```{r}
# non missing 
table(Baseline_follow[!is.na(Baseline_follow$aqol6d_total_c),]$round)

nrow(Baseline_follow)
```

# Generallized mixed effect 



## Functions 
```{r}

# function for RMSR
rmse <- function(y,yhat){sqrt(mean((yhat-y)^2))}

# function for fitting Gaussian model with log link
Gaussian_log_link<-function(data,var1,var2){
  data<-data.frame(data)
  #prepare data
  data<-data %>% 
    dplyr::select("aqol6d_total_w","fkClientID","round",var1,var2) %>% 
    group_by(fkClientID) %>% 
    arrange(fkClientID,round) %>% 
    mutate(!!paste0(var1,"_baseline") :=  first(!!as.name(var1))/100) %>% 
    mutate(!!paste0(var1,"_change") :=ifelse(round=="Baseline",0,(!!as.name(var1)-lag(!!as.name(var1)))/100))  %>% 
    mutate(!!paste0(var2,"_baseline") :=  first(!!as.name(var2))/100) %>% 
    mutate(!!paste0(var2,"_change") :=ifelse(round=="Baseline",0,(!!as.name(var2)-lag(!!as.name(var2)))/100))  %>% 
    mutate(aqol6d_total_w_cloglog= log(-log(1-ifelse(aqol6d_total_w==1,0.999,aqol6d_total_w)))) %>% 
    na.omit() 
  
  #Bayes models
  brm_model <- brm(formula = as.formula(paste0("aqol6d_total_w ~ ",var1,"_baseline + ",var1,"_change + ",
                                                var2,"_baseline + ",var2,"_change + (1|fkClientID)")), data = data,
                   family = gaussian(link="log"), iter = 4000,seed=1000)
  #print results
  print(plot(brm_model))
  print(summary(brm_model, digits = 4))
  
  #save prediction
  set.seed(23456)
  predictions<-predict(brm_model,summary=F)
  
  # summary statistics for posterior coef, R2, RMSR and Sigma  
  coef<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
  R2<-bayes_R2(brm_model)
  RMSE<-psych::describe( apply(predictions,1,rmse,y=data$aqol6d_total_w),
                                 quant=c(.25,.75),skew = F, ranges = F )
  RMSE <- cbind(RMSE$mean,RMSE$sd,RMSE$Q0.25,RMSE$Q0.75)
  Sigma<-summary(brm_model, digits = 4)$spec_par[1:4]
  
  #combine results
  result<-data.frame(round(rbind(coef,R2,RMSE,Sigma),3))  %>% 
    mutate(Parameter=c(paste(var1," baseline"), paste(var1," change"), 
                       paste(var2," baseline"), paste(var2," change") ,
                       "R2", "RMSE", "Sigma"),
           Model= paste(var1, " model")) %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Model,Parameter,Estimate,  SE, `95% CI`)
    
  #extract plot
  set.seed(23456)
  data$Predicted<-predict(brm_model)[,1]
  print(data %>% 
        mutate(Observed=aqol6d_total_w) %>% 
        gather(variable, value, Predicted, Observed) %>%
        ggplot(aes(x = value, fill = variable)) +
        geom_bkde(alpha=0.5) +
        geom_rug() +
        scale_fill_viridis( discrete = TRUE) +
        theme_bw() + 
        theme(legend.position="bottom") +
        labs( x="AQoL-6D utility score",y="Density", fill=""))

  print(ggplot(data) + 
      geom_point(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1) +
      theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#D55E00","#56B4E9"))  +
      labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
      theme(legend.position="bottom"))
  return(result)
  
}

# function for RMSR
rmse_trans <- function(y,yhat){sqrt(mean((1-exp(-exp(yhat))-y)^2))}
# function for fitting Gaussian model with log link
Cloglog_transform<-function(data,var1,var2 ){
  data<-data.frame(data)
  #prepare data
  data<-data %>% 
    dplyr::select("aqol6d_total_w","fkClientID","round",var1,var2) %>% 
    group_by(fkClientID) %>% 
    arrange(fkClientID,round) %>% 
    mutate(!!paste0(var1,"_baseline") :=  first(!!as.name(var1))/100) %>% 
    mutate(!!paste0(var1,"_change") :=ifelse(round=="Baseline",0,(!!as.name(var1)-lag(!!as.name(var1)))/100))  %>% 
    mutate(!!paste0(var2,"_baseline") :=  first(!!as.name(var2))/100) %>% 
    mutate(!!paste0(var2,"_change") :=ifelse(round=="Baseline",0,(!!as.name(var2)-lag(!!as.name(var2)))/100))  %>% 
    mutate(aqol6d_total_w_cloglog= log(-log(1-ifelse(aqol6d_total_w==1,0.999,aqol6d_total_w)))) %>% 
    na.omit() 
  
  #Bayes models
  brm_model <- brm(formula = as.formula(paste0("aqol6d_total_w_cloglog ~ ",var1,"_baseline + ",var1,"_change + ",
                                                var2,"_baseline + ",var2,"_change + (1|fkClientID)")), data = data,
                   family = gaussian(link="identity"), iter = 4000,seed=1000)
  #print results
  print(plot(brm_model))
  print(summary(brm_model, digits = 4))
  
  #save prediction
  set.seed(23456)
  predictions<-predict(brm_model,summary=F)
  
  # summary statistics for posterior coef, R2, RMSR and Sigma  
  coef<-summary(brm_model, digits = 4)$fixed[2:5,1:4]
  R2<-bayes_R2(brm_model)
  RMSE<-psych::describe( apply(predictions,1,rmse_trans,y=data$aqol6d_total_w),
                                 quant=c(.25,.75),skew = F, ranges = F )
  RMSE <- cbind(RMSE$mean,RMSE$sd,RMSE$Q0.25,RMSE$Q0.75)
  Sigma<-summary(brm_model, digits = 4)$spec_par[1:4]
  
  #combine results
  result<-data.frame(round(rbind(coef,R2,RMSE,Sigma),3))  %>% 
    mutate(Parameter=c(paste(var1," baseline"), paste(var1," change"), 
                       paste(var2," baseline"), paste(var2," change") ,
                       "R2", "RMSE", "Sigma"),
           Model= paste(var1, " model")) %>% 
    mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    rename (SE=Est.Error) %>% 
    dplyr::select(Model,Parameter,Estimate,  SE, `95% CI`)
    
  #extract plot
  set.seed(23456)
  data$Predicted<-1-exp(-exp(predict(brm_model)[,1]))
  
  print(data %>% 
        mutate(Observed=aqol6d_total_w) %>% 
        gather(variable, value, Predicted, Observed) %>%
        ggplot(aes(x = value, fill = variable)) +
        geom_bkde(alpha=0.5) +
        geom_rug() +
        scale_fill_viridis( discrete = TRUE) +
        theme_bw() + 
        theme(legend.position="bottom") +
        labs( x="AQoL-6D utility score",y="Density", fill=""))

  print(ggplot(data) + 
      geom_jitter(aes(x=aqol6d_total_w,y=Predicted,col=round),size=1,alpha=0.7) +
      theme_bw()  + xlim(0,1)  + ylim(0,1)  + scale_color_manual(values=c("#D55E00","#56B4E9"))  +
      labs( x="Observed AQoL-6D utility score",y="Predicted AQoL-6D utility score", col="") +
      theme(legend.position="bottom"))
  return(result)
  
}

```


## PHQ9 

### Gaussian with log link

```{r}
model1<-Gaussian_log_link(Baseline_follow,"PHQ9","SOFAS")
```

### Cloglog transformed AQoL-6D scores

```{r}
model2<-Cloglog_transform(Baseline_follow,"PHQ9","SOFAS")
```

```{r}
results<-cbind(model1,model2)
```


## BADS 

### Gaussian with log link

```{r}
model1<-Gaussian_log_link(Baseline_follow,"BADS","SOFAS")

```

### Cloglog transformed AQoL-6D scores

```{r}
model2<-Cloglog_transform(Baseline_follow,"BADS","SOFAS")
```

```{r}
results<-rbind(results,cbind(model1,model2))
```


## GAD7 

### Gaussian with log link

```{r}
model1<-Gaussian_log_link(Baseline_follow,"GAD7","SOFAS")
```

### Cloglog transformed AQoL-6D scores

```{r}
model2<-Cloglog_transform(Baseline_follow,"GAD7","SOFAS")
```

```{r}
results<-rbind(results,cbind(model1,model2))
```



## OASIS

### Gaussian with log link

```{r}
model1<-Gaussian_log_link(Baseline_follow,"OASIS","SOFAS")

```

### Cloglog transformed AQoL-6D scores

```{r}
model2<-Cloglog_transform(Baseline_follow,"OASIS","SOFAS")
```

```{r}
results<-rbind(results,cbind(model1,model2))
```



## SCARED

### Gaussian with log link

```{r}
model1<-Gaussian_log_link(Baseline_follow,"SCARED","SOFAS")

```

### Cloglog transformed AQoL-6D scores

```{r}
model2<-Cloglog_transform(Baseline_follow,"SCARED","SOFAS")
```

```{r}
results<-rbind(results,cbind(model1,model2))
```



## K6

### Gaussian with log link

```{r}
model1<-Gaussian_log_link(Baseline_follow,"K6","SOFAS")

```

### Cloglog transformed AQoL-6D scores

```{r}
model2<-Cloglog_transform(Baseline_follow,"K6","SOFAS")
```

```{r}
results<-rbind(results,cbind(model1,model2))
```


## Summary table 

```{r}
knitr::kable( results[,c(1:5,8:10)]  , format="html") %>%
    kable_styling(bootstrap_options = "striped", full_width = F) %>%  
    add_header_above(c(" " = 2, "GLM (Gaussian distribution with log link)" = 3, "OLS (cloglog transformed utility score)" = 3))
```


