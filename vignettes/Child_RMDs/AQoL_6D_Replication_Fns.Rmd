---
title: "AQoL 6D Preferred Models"
author: "Matthew Hamilton & Caroline Gao"
date: "21/10/2020"
output: html_document
---


## Functions 
```{r}
calculate_rmse <- function(y_dbl,yhat_dbl){
  rmse_dbl <- sqrt(mean((yhat_dbl-y_dbl)^2))
  return(rmse_dbl)
  }
transform_tb_to_mdl_inp <- function(data_tb,
                                        dep_var_nm_1L_chr = "aqol6d_total_w",
                                    predictor_vars_nms_chr,
                                    id_var_nm_1L_chr = "fkClientID",
                                    round_var_nm_1L_chr = "round",
                                    round_bl_val_1L_chr = "Baseline"){
    data_tb <- data.frame(data_tb)
  tfd_for_gsn_log_mdl_tb <- data_tb %>% 
    dplyr::select(dplyr::all_of(dep_var_nm_1L_chr),
                  dplyr::all_of(id_var_nm_1L_chr),
                  dplyr::all_of(round_var_nm_1L_chr),
                  dplyr::all_of(predictor_vars_nms_chr)) %>% 
    dplyr::group_by(!!rlang::sym(id_var_nm_1L_chr)) %>% 
    dplyr::arrange(!!rlang::sym(id_var_nm_1L_chr),!!rlang::sym(round_var_nm_1L_chr)) %>% 
    dplyr::mutate(dplyr::across(dplyr::all_of(predictor_vars_nms_chr), 
                    .fns = list(baseline = ~ dplyr::first(.)/100,
                                change = ~ ifelse(!!rlang::sym(round_var_nm_1L_chr)==round_bl_val_1L_chr,
                                                0,
                                                (.-lag(.))/100))))  %>% 
    dplyr::mutate(!!rlang::sym(paste0(dep_var_nm_1L_chr,"_cloglog")) := log(-log(1-ifelse(!!rlang::sym(dep_var_nm_1L_chr)==1,0.999,!!rlang::sym(dep_var_nm_1L_chr))))) %>% 
    na.omit()
  return(tfd_for_gsn_log_mdl_tb)
                              }
fit_gsn_log_lnk <- function(data_tb,
                            dep_var_nm_1L_chr = "aqol6d_total_w",
                            predictor_vars_nms_chr,
                            id_var_nm_1L_chr = "fkClientID",
                            iters_1L_int = 4000L,
                            seed_1L_int = 1000L){
  data_tb <- transform_tb_to_mdl_inp(data_tb,
                                     dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                                     predictor_vars_nms_chr = predictor_vars_nms_chr)
  brm_model_ls <- fit_ts_model_with_brm(data_tb,
                                        dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                                        predictor_vars_nms_chr = predictor_vars_nms_chr,
                                        link_1L_chr = "log",
                                        id_var_nm_1L_chr = id_var_nm_1L_chr,
                                        iters_1L_int = iters_1L_int,
                                        seed_1L_int = seed_1L_int)
  return(brm_model_ls)
}
make_smry_of_brm_mdl <- function(brm_model_ls,
                                 data_tb,
                                 dep_var_nm_1L_chr = "aqol6d_total_w",
                                 predictor_vars_nms_chr,
                                 fn = calculate_rmse,
                                 model_nm_1L_chr = NA_character_,
                                 seed_1L_dbl = 23456){
  if(is.na(model_nm_1L_chr))
    model_nm_1L_chr <- predictor_vars_nms_chr[1]
  set.seed(seed_1L_dbl)
  predictions <- predict(brm_model_ls, summary=F)
  coef <- summary(brm_model_ls, digits = 4)$fixed
  coef <- coef[1:nrow(coef),1:4]
  R2 <- brms::bayes_R2(brm_model_ls)
  RMSE <- psych::describe(apply(predictions,
                                1,
                                fn,
                                y_dbl = data_tb %>% dplyr::pull(!!rlang::sym(dep_var_nm_1L_chr))),
                          quant = c(.25, .75), 
                          skew = F, 
                          ranges = F)
  RMSE <- cbind(RMSE$mean, RMSE$sd, RMSE$Q0.25, RMSE$Q0.75)
  Sigma <- summary(brm_model_ls, digits = 4)$spec_par[1:4]
  smry_of_brm_mdl_tb <- data.frame(round(rbind(coef,R2,RMSE,Sigma),3))  %>% 
    dplyr::mutate(Parameter=c("Intercept",purrr::map(predictor_vars_nms_chr,
                                  ~ paste0(.x, c(" baseline", 
                                                 " change"))) %>%
                         purrr::flatten_chr(),
                       "R2", "RMSE", "Sigma"),
           Model = model_nm_1L_chr) %>% 
    dplyr::mutate(`95% CI`= paste(`l.95..CI`,",", `u.95..CI`)) %>% 
    dplyr::rename (SE=Est.Error) %>% 
    dplyr::select(Model, Parameter, Estimate, SE, `95% CI`)
  return(smry_of_brm_mdl_tb)
}
make_brm_model_plts <- function(brm_model_ls,
                           data_tb,
                           dep_var_nm_1L_chr = "aqol6d_total_w",
                           dep_var_desc_1L_chr = "AQoL-6D utility score",
                           round_var_nm_1L_chr = "round",
                           tfmn_fn = function(x){x},# function(x){1-exp(-exp(x))}
                           plot3_fn =ggplot2::geom_point,
                           args_ls = NULL,
                           seed_1L_dbl = 23456){
  plot_1_plt <- plot(brm_model_ls, ask=F)
  set.seed(seed_1L_dbl)
  data_tb$Predicted <- predict(brm_model_ls)[,1] %>% tfmn_fn()
  plot_2_plt <- data_tb %>% 
        dplyr::mutate(Observed = !!rlang::sym(dep_var_nm_1L_chr)) %>% 
        tidyr::gather(variable, value, Predicted, Observed) %>%
        ggplot2::ggplot(ggplot2::aes(x = value, fill = variable)) +
        ggalt::geom_bkde(alpha=0.5) +
        ggplot2::geom_rug() +
        viridis::scale_fill_viridis(discrete = TRUE) +
        ggplot2::theme_bw() + 
        ggplot2::theme(legend.position = "bottom") +
        ggplot2::labs(x = dep_var_desc_1L_chr, 
                      y = "Density", fill="")
    plot_3_plt <- ggplot2::ggplot(data_tb) +
      rlang::exec(plot3_fn,  
                              ggplot2::aes(x = !!rlang::sym(dep_var_nm_1L_chr), 
                                       y = Predicted,
                                       col = !!rlang::sym(round_var_nm_1L_chr)),
                              size = 1,
                              !!!args_ls) + 
      ggplot2::theme_bw()  + 
    ggplot2::xlim(0,1)  + 
    ggplot2::ylim(0,1)  + 
    ggplot2::scale_color_manual(values=c("#D55E00","#56B4E9"))  +
      ggplot2::labs(x = paste0("Observed ", dep_var_desc_1L_chr),
                    y = paste0("Predicted ", dep_var_desc_1L_chr), 
                    col = "") +
      ggplot2::theme(legend.position="bottom")
  brm_model_plts_ls = list(plot_1_plt, 
                           plot_2_plt,
                           plot_3_plt)
return(brm_model_plts_ls)
}
print_brm_model <- function(brm_model_ls,
                            brm_model_plts_ls){
  print(brm_model_plts_ls[[1]])
  print(summary(brm_model_ls, digits = 4))
  print(brm_model_plts_ls[[2]])
  brm_model_plts_ls[[3]]
                            }
calculate_rmse_tfmn <- function(y_dbl,yhat_dbl){
  rmse_tfmn_dbl <- sqrt(mean((1-exp(-exp(yhat_dbl))-y_dbl)^2))
  return(rmse_tfmn_dbl)
  }
fit_ts_model_with_brm <- function(data_tb,
                               dep_var_nm_1L_chr,
                               predictor_vars_nms_chr,
                               id_var_nm_1L_chr,
                               link_1L_chr = "identity",
                               iters_1L_int = 4000L,
                               seed_1L_int = 1000L){
      brm_model_ls <- brms::brm(formula = as.formula(paste0(dep_var_nm_1L_chr,#"aqol6d_total_w_cloglog",
                                                            " ~ ", 
                                                        purrr::map_chr(predictor_vars_nms_chr,
                                                                       ~ paste0(.x,
                                                                                "_baseline + ",
                                                                                .x,"_change + ")) %>%
                                                          paste0(collapse = ""),
                                                        "(1|",
                                                        id_var_nm_1L_chr,
                                                        ")")), 
                                data = data_tb,
                                family = gaussian(link=link_1L_chr), 
                                iter = iters_1L_int,
                                seed = seed_1L_int)
      return(brm_model_ls)
                               }
fit_clg_log_tfmn <- function(data_tb,
                             dep_var_nm_1L_chr = "aqol6d_total_w_cloglog",
                           predictor_var_nms_chr,
                           iters_1L_int = 4000L,
                           seed_1L_int = 1000L 
                           ){
  data_tb <- transform_tb_to_mdl_inp(data_tb,
                               predictor_vars_nms_chr = predictor_vars_nms_chr)
  brm_model_ls <- fit_ts_model_with_brm(data_tb,
                                        dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                                        predictor_vars_nms_chr = predictor_vars_nms_chr,
                                        link_1L_chr = "identity",
                                        iters_1L_int = iters_1L_int,
                                        seed_1L_int = seed_1L_int)
    return(brm_model_ls)
}
write_ts_mdl <- function(mdl_ls,
                      data_tb,
                      dep_var_nm_1L_chr = "aqol6d_total_w",
                      predictor_vars_nms_chr,
                      id_var_nm_1L_chr = "fkClientID",
                      model_nm_1L_chr,
                      path_to_data_dir_1L_chr
                      ){
  old_data_tb <- transform_tb_to_mdl_inp(data_tb,
                                dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                                predictor_vars_nms_chr = predictor_vars_nms_chr) %>%
          dplyr::select(c(dplyr::all_of(id_var_nm_1L_chr),
                          dplyr::all_of(dep_var_nm_1L_chr),
                          predictor_vars_nms_chr %>% purrr::map(~paste0(.x,c("","_baseline","_change"))) %>%
                            purrr::flatten_chr()))
cnfdl_mdl_ls <- mdl_ls 
cnfdl_mdl_ls$data <- old_data_tb %>% as.data.frame() %>% dplyr::summarise(dplyr::across(dplyr::everything(), ~ sample(.x,1))) 
saveRDS(cnfdl_mdl_ls,paste0(path_to_data_dir_1L_chr,"/",model_nm_1L_chr,".RDS"))
}
write_and_make_smry_of_ts_mdl <- function(data_tb,
                                          dep_var_nm_1L_chr = "aqol6d_total_w",
                                          predictor_vars_nms_chr,
                                          id_var_nm_1L_chr = "fkClientID",
                                          model_nm_1L_chr,
                                          path_to_data_dir_1L_chr,
                                          fn,
                                          print_plots_1L_lgl = T){
  gsn_log_lnk_mdl_ls <- fit_gsn_log_lnk(data_tb,
                                      dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                                      predictor_vars_nms_chr = predictor_vars_nms_chr)
smry_of_mdl_1 <- make_smry_of_brm_mdl(gsn_log_lnk_mdl_ls,
                               data_tb = transform_tb_to_mdl_inp(data_tb,
                                                                 dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                                                                 predictor_vars_nms_chr = predictor_vars_nms_chr),
                               dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                               predictor_vars_nms_chr = predictor_vars_nms_chr,
                               fn = fn)
write_ts_mdl(gsn_log_lnk_mdl_ls,
             data_tb = data_tb,
             dep_var_nm_1L_chr = dep_var_nm_1L_chr,
             predictor_vars_nms_chr = predictor_vars_nms_chr,
             id_var_nm_1L_chr = id_var_nm_1L_chr,
             model_nm_1L_chr = model_nm_1L_chr,
             path_to_data_dir_1L_chr = path_to_data_dir_1L_chr)
if(print_plots_1L_lgl){
  mdl_1_plts_ls <- make_brm_model_plts(gsn_log_lnk_mdl_ls,
                                     transform_tb_to_mdl_inp(data_tb,
                                                                 dep_var_nm_1L_chr = dep_var_nm_1L_chr,
                                                                 predictor_vars_nms_chr = predictor_vars_nms_chr))
  print_brm_model(gsn_log_lnk_mdl_ls,mdl_1_plts_ls)
}

return(smry_of_mdl_1)

}
predict_from_mdl_coefs <- function(smry_of_mdl_tb,
                                   new_data_tb){
  coef_tb <- smry_of_mdl_tb %>% dplyr::filter(!Parameter %in% c("R2", "RMSE", "Sigma"))
  vecs_1_ls <- coef_tb$Parameter[-1] %>% 
  purrr::map(~ new_data_tb %>% 
               dplyr::pull(.x %>% stringr::str_replace(" ","_")) * coef_tb %>%
               dplyr::filter(Parameter == .x) %>%
               dplyr::pull(Estimate)
             ) 
  pred_dbl <- exp(Reduce(`+`, vecs_1_ls) + coef_tb %>%
               dplyr::filter(Parameter == "Intercept") %>%
               dplyr::pull(Estimate))
return(pred_dbl)
}
```

## PHQ9 

### Gaussian with log link

```{r}
smry_of_gsn_log_mdl_1 <- write_and_make_smry_of_ts_mdl(data_tb = Baseline_follow,
                              dep_var_nm_1L_chr = "aqol6d_total_w",
                              predictor_vars_nms_chr = c("PHQ9","SOFAS"),
                              id_var_nm_1L_chr = "fkClientID",
                              path_to_data_dir_1L_chr = "../../../../../../../Data/R_Format/Utility_Models",
                              model_nm_1L_chr = "PHQ9_GSN_LOG",
                              fn = calculate_rmse)
# new_data_tb <- tibble::tibble(PHQ9_baseline = c(0.14,0.25,0.15,0.2,0.11),
#                                  PHQ9_change = c(-0.1,-0.05,0.05,-0.06,0.1),
#                                  SOFAS_baseline = c(0.71,0.69,0.75,0.43,0.29),
#                                  SOFAS_change = c(0.25,-0.19,0.1,-0.1,0.2))
new_data_tb <- old_data_tb
pred_1_tb <- predict(readRDS(paste0(path_to_data_dir_1L_chr,"/",model_nm_1L_chr,".RDS")),
        newdata = new_data_tb,
        re_formula = NA)
pred_1_dbl <- pred_1_tb[,1]
pred_2_dbl <-predict_from_mdl_coefs(smry_of_mdl_1,
                       new_data_tb = new_data_tb)
 
```

```{r}
#predictor_vars_nms_chr <- c("PHQ9","SOFAS")
clg_log_tfmn_mdl_ls <- fit_gsn_log_lnk(Baseline_follow,predictor_vars_nms_chr)
model2 <- make_smry_of_brm_mdl(clg_log_tfmn_mdl_ls,
                               data_tb = Baseline_follow,
                               fn = calculate_rmse_tfmn,
                               predictor_vars_nms_chr = predictor_vars_nms_chr)
mdl_2_plts_ls <- make_brm_model_plts(data_tb)
```

### Cloglog transformed AQoL-6D scores

```{r}
model2 <- fit_clg_log_tfmn(Baseline_follow,"PHQ9","SOFAS")
```

```{r}
results<-cbind(model1,model2)
```


## BADS 

### Gaussian with log link

```{r}
model1<-fit_gsn_log_lnk(Baseline_follow,"BADS","SOFAS")

```

### Cloglog transformed AQoL-6D scores

```{r}
model2<-fit_clg_log_tfmn(Baseline_follow,"BADS","SOFAS")
```

```{r}
results<-rbind(results,cbind(model1,model2))
```


## GAD7 

### Gaussian with log link

```{r}
model1<-fit_gsn_log_lnk(Baseline_follow,"GAD7","SOFAS")
```

### Cloglog transformed AQoL-6D scores

```{r}
model2<-fit_clg_log_tfmn(Baseline_follow,"GAD7","SOFAS")
```

```{r}
results<-rbind(results,cbind(model1,model2))
```



## OASIS

### Gaussian with log link

```{r}
model1<-fit_gsn_log_lnk(Baseline_follow,"OASIS","SOFAS")

```

### Cloglog transformed AQoL-6D scores

```{r}
model2<-fit_clg_log_tfmn(Baseline_follow,"OASIS","SOFAS")
```

```{r}
results<-rbind(results,cbind(model1,model2))
```



## SCARED

### Gaussian with log link

```{r}
model1<-fit_gsn_log_lnk(Baseline_follow,"SCARED","SOFAS")

```

### Cloglog transformed AQoL-6D scores

```{r}
model2<-fit_clg_log_tfmn(Baseline_follow,"SCARED","SOFAS")
```

```{r}
results<-rbind(results,cbind(model1,model2))
```



## K6

### Gaussian with log link

```{r}
model1<-fit_gsn_log_lnk(Baseline_follow,"K6","SOFAS")

```

### Cloglog transformed AQoL-6D scores

```{r}
model2<-fit_clg_log_tfmn(Baseline_follow,"K6","SOFAS")
```

```{r}
results<-rbind(results,cbind(model1,model2))
```


## Summary table 

```{r}
knitr::kable( results[,c(1:5,8:10)]  , format="html") %>%
    kable_styling(bootstrap_options = "striped", full_width = F) %>%  
    add_header_above(c(" " = 2, "GLM (Gaussian distribution with log link)" = 3, "OLS (cloglog transformed utility score)" = 3))
```

```{r}
# if(!dir.exists("../Data"))
#   dir.create("../Data")
# saveRDS(results,"../Data/sofas_models_ls.rds") 
```
